<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://s3.amazonaws.com/oncoscape/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape.js-qtip.js"></script>
   <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">

	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string) 
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
// from http://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
function openCenteredBrowserWindow(url, title, w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

    width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);

    if (window.focus) {
       newWindow.focus();
       }

} // openCenteredBrowserWindow
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined")
    {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
     }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------
</script>

<script>
//----------------------------------------------------------------------------------------------------
var UserSettingsModule = (function () {

     var username = "Guest"
     var userID = null
     var SelectionNames = [];
     
//----------------------------------------------------------------------------------------------------
//======= PUBLIC FUNCTIONS ==========
//----------------------------------------------------------------------------------------------------
      getUserID = function(){
           console.log("Sending User ID: ", userID)
           return userID;
      }      
//----------------------------------------------------------------------------------------------------
      getUsername = function(){
           console.log("Sending Username: ", username)
           return username;
      }      

    //--------------------------------------------------------------------------------------------
     addSelection = function(NewSelection){
  
           //Check NewSelection values for completeness/accuracy
           // should have selectionnames, patientIDs, Tab, and Settings
           
           NewSelection.userID = getUserID() 
     
           msg = {cmd: "addNewUserSelection",
                  callback: "UpdateSelectionListeners",
                  status:"request",
                  payload: NewSelection 
                 };
 
           msg.json = JSON.stringify(msg);
//           console.log(msg.json);
           socket.send(msg.json);
     }
    //--------------------------------------------------------------------------------------------
     getSelectionbyName = function(selectionname, callback){
               
			if(SelectionNames.indexOf(selectionname) == -1){
   			     alert("Error: ",selectionname, " not in list")
                  return;
			} else{
  
                msg = {cmd:"getUserSelection",
                  callback: callback,
                  status:"request",
                  payload:{userID: getUserID(),
                           selectionname: selectionname}
                  };
     
                 console.log(JSON.stringify(msg));
                  socket.send(JSON.stringify(msg));
          }     
    }

   //--------------------------------------------------------------------------------------------
     getSelectionNames = function(){

            return SelectionNames;
     }

//----------------------------------------------------------------------------------------------------
//======= PRIVATE FUNCTIONS ==========
//----------------------------------------------------------------------------------------------------
      function CreateNewUser(){
      
         console.log("======= creating new guest user")
  
            userID = Math.random().toString(36).substring(7)
            console.log(userID);
      }
//----------------------------------------------------------------------------------------------------
     function UserSettingsInitializeUI(){

           CreateNewUser();
       };

//----------------------------------------------------------------------------------------------------
     function addNewUser(){
              
            msg = {cmd:"addNewUserToList",
                 callback: "DisplayUserInfo",
                 status:"request",
                 payload: { userID: userID, username: username}
                };
                console.log(JSON.stringify(msg))
          socket.send(JSON.stringify(msg));
     }
 
         

//----------------------------------------------------------------------------------------------------
    function UpdateSelectionListeners(msg){
    
        console.log("===== Updating JS Selection Lists")
        console.log(msg)
         
         if(msg.status === "success"){
           SelectionNames.push(msg.payload.selectionname)  
           
           if(typeof(SavedSelection) != "undefined")  SavedSelection.addSelectionToTable(msg);
           if(typeof(PatientTimeLine) != "undefined") PatientTimeLine.RefreshSelectionMenu()
           if(typeof(ctbl) != "undefined") ctbl.UpdateSelectionMenu()
         }
     }
  
 
     
//----------------------------------------------------------------------------------------------------
return{

   init: function(){
      onReadyFunctions.push(UserSettingsInitializeUI);
      socketConnectedFunctions.push(addNewUser);
     addJavascriptMessageHandler("UpdateSelectionListeners", UpdateSelectionListeners);
      }
   };

}); // DateAndTimeModule
//----------------------------------------------------------------------------------------------------
UserSettings = UserSettingsModule();
UserSettings.init();

</script>
<script>
//----------------------------------------------------------------------------------------------------
var TimeLineModule = (function () {

     

     //--------------------------------------------------------------------------------------------------
     var TimelineTabNumber = 3;
     var TimeLineMargin = {top: 10, right: 15, bottom: 30, left: 20};
     var AlignBy = "--";
     var OrderBy = "--";
     var SidePlotEvent = "--";
     var TimeLineDisplay;
     var MainEvents = ["DOB","Encounter", "Diagnosis", "OR",  "MRI","Radiation", "Chemo","Progression",  "Status"]
     var MainEventColors = ["#17becf", "#d62728", "#8c564b","#ff7f0e", "#7f7f7f","#9467bd","#1f77b4","#2ca02c", "#bcbd22"]
     var MainEventTextSpacing = [0, 70, 82, 87, 75, 80, 78, 75, 80];
     var TimeLineSelectedRegion;    // from brushing
     var TimeLined3PlotBrush;
     var dialog;
     var TimeLinebroadcastButton;
     var TimeLineSelectionButton;
     var CalculatedEvents =[{Name:"Survival", Event1: "Diagnosis", Event2: "Status", TimeScale: "Months"},
                            {Name:"AgeDx",Event1: "DOB", Event2: "Diagnosis", TimeScale: "Years"},
                            {Name:"TimeToProgression",Event1: "Diagnosis", Event2: "Progression", TimeScale: "Days"},
                            {Name:"FirstProgressionToDeath",Event1: "Progression", Event2: "Status", TimeScale: "Days"} ];
         CalculatedEvents = d3.nest()
              .key(function(d) { return d.Name; })
              .map(CalculatedEvents, d3.map);
              
     var OneDay = 1000 *60 * 60*24;
     var TimeLineColor = d3.scale.ordinal().range(MainEventColors).domain(MainEvents);
     var PatientHeight = 3;

     var Events,EventsByID, FormatDate, EventTypes, ShowEvents;
     var dispatch = d3.dispatch("load","LoadOptions", "DisplayPatients", "Update", "UpdateMenuOptions");
     var TimeLineInitialLoad=true;
       
        //--------------------------------------------------------------------------------------------
       function initializeUI(){
             console.log("========== initializing Timeline UI")
           TimeLineDisplay = $("#TimeLineDisplay");
           TimeLineHandleWindowResize();
           TimeLinebroadcastButton = $("#SendSelectionToClinicalTable");
              TimeLinebroadcastButton.click(timelineSelectionToClinicalTable);
          TimeLineSelectionButton = $("#timelineSaveSelection");
              TimeLineSelectionButton.click(function(){
                  var selectionname = prompt("Please enter a selection name", "e.g. high survival")
                  if (selectionname != null & selectionname !== "e.g. high survival") 
                      timelineBroadcastSelection(selectionname);
              });
           $(window).resize(TimeLineHandleWindowResize);
           TimeLinebroadcastButton.prop("disabled",true);
           TimeLineSelectionButton.prop("disabled",true);
          
           dispatch.load();
      };

     //--------------------------------------------------------------------------------------------------     
     function getDateDiff(Name, Event1, Event2, TimeScale){
          console.log("Date Difference of " +Event2+ " - " + Event1 + " in " + TimeScale)          
          var DateDiff = []; var TimeScaleValue=1
          if(TimeScale==="Days"){TimeScaleValue=OneDay;}
          else if(TimeScale ==="Months"){TimeScaleValue=OneDay*30.425}
          else if(TimeScale==="Years"){ TimeScaleValue = OneDay*365.25}
               
          EventsByID.forEach(function(ID, Patient){
               var dateDiff = 0; var date1, date2;
                if( Name=== "Survival" & (!Patient.has("Status") | Patient.get("Status")[0].Type !== "Dead")) {
                     dateDiff = null;
                } else{
                  if(Patient.has(Event1) && Patient.has(Event2) ){
                     if(Patient.get(Event1)[0].date.length >1){
                         date1 = Patient.get(Event1).sort(AscendingStartDate)[0].date[0] }
                     else{ date1 = Patient.get(Event1).sort(AscendingDate)[0].date         }
                     if(Patient.get(Event2)[0].date.length >1){
                        date2 = Patient.get(Event2).sort(AscendingStartDate)[0].date[0] }
                     else{ date2 = Patient.get(Event2).sort(AscendingDate)[0].date         }
                    
                     dateDiff = (date2 - date1 )/TimeScaleValue
//                    DateDiff.push( {ID: ID,PtNum: Patient.get(Event1)[0].PtNum, value: dateDiff, Scale: TimeScale})
                   }else{ dateDiff=null;}
               }

            DateDiff.push( {ID: ID,PtNum: Patient.get(Patient.keys()[0])[0].PtNum, value: dateDiff, Scale: TimeScale})
          })
          return DateDiff;
     }
     
     //--------------------------------------------------------------------------------------------------     
     function getHorizontalBarSize(Patient){
     
//          console.log("Creating Horizontal BarPlot: ", Patient)
          var BarSizes = []
          Patient.forEach(function(d){
               xBar = 0; barWidth = ~~d.value
               if(d.value < 0){ xBar = ~~d.value; barWidth = Math.abs(d.value);  }
               BarSizes.push( {ID: d.ID, info: ~~d.value, Scale: d.Scale, xBar: xBar, yBar: d.PtNum,  width: barWidth})
          })     
          return BarSizes;
     }
     
      //--------------------------------------------------------------------------------------------
     function TimeLineHandleWindowResize(){
//       	console.log("===== resizing Timeline window")
          TimeLineDisplay.width($(window).width() * 0.95);
           TimeLineDisplay.height($(window).height() * 0.80);
          if(!TimeLineInitialLoad) {dispatch.DisplayPatients();}
     };

   //--------------------------------------------------------------------------------------------
   function timelineBroadcastSelection(selectionname){
 //     console.log("broadcastSelection: " + TimeLineSelectedRegion);
      x1=TimeLineSelectedRegion[0][0];
      y1=TimeLineSelectedRegion[0][1];
      x2=TimeLineSelectedRegion[1][0];
      y2=TimeLineSelectedRegion[1][1];
      ids = [];
      
      function LogTime(t){
                     if(AlignBy === "--"){ 
                               return t;
                     } else{ var Dir = (t<0 ? -1 : 1); 
                         return Dir * Math.log(Math.abs(t/OneDay)+1)/Math.log(2)
                    }
               }     
  
      for(var i=0; i < Events.length; i++){
         event = Events[i];
         if(event.PtNum >= y1/PatientHeight & event.PtNum <= y2/PatientHeight){
			// Patient within range
            
            if(event.date.length>1 ){
                 if( (LogTime(event.date[0]-event.offset) >=x1 & LogTime(event.date[0]-event.offset) <= x2) ||
	                 (LogTime(event.date[1]-event.offset) >=x1 & LogTime(event.date[1]-event.offset) <= x2) ){
	                  // date endpoints within range
	                
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            } else{
                 if (LogTime(event.date-event.offset) >=x1 & LogTime(event.date-event.offset) <= x2) {
	                  // date within range
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            }
         }
      } // for i
    
    if(ids.length > 0)
 //        sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
         if(AlignBy === "--") {x1 = FormatDate(x1); x2 = FormatDate(x2)}
         settings = {AlignBy: AlignBy, OrderBy: OrderBy, x: [x1, x2], y: [y1, y2]}
         sendTimelineCurrentIDsToSelection(ids,selectionname, settings);
    };
   //--------------------------------------------------------------------------------------------
   function timelineSelectionToClinicalTable(){
//      console.log("broadcastSelection: " + TimeLineSelectedRegion);
      x1=TimeLineSelectedRegion[0][0];
      y1=TimeLineSelectedRegion[0][1];
      x2=TimeLineSelectedRegion[1][0];
      y2=TimeLineSelectedRegion[1][1];
      ids = [];
      
      function LogTime(t){
                     if(AlignBy === "--"){ 
                               return t;
                     } else{ var Dir = (t<0 ? -1 : 1); 
                         return Dir * Math.log(Math.abs(t/OneDay)+1)/Math.log(2)
                    }
               }     
  
      for(var i=0; i < Events.length; i++){
         event = Events[i];
         if(event.PtNum >= y1/PatientHeight & event.PtNum <= y2/PatientHeight){
			// Patient within range
            
            if(event.date.length>1 ){
                 if( (LogTime(event.date[0]-event.offset) >=x1 & LogTime(event.date[0]-event.offset) <= x2) ||
	                 (LogTime(event.date[1]-event.offset) >=x1 & LogTime(event.date[1]-event.offset) <= x2) ){
	                  // date endpoints within range
	                
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            } else{
                 if (LogTime(event.date-event.offset) >=x1 & LogTime(event.date-event.offset) <= x2) {
	                  // date within range
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            }
         }
      } // for i
    
    if(ids.length > 0)
         sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
//         if(AlignBy === "--") {x1 = FormatDate(x1); x2 = FormatDate(x2)}
  //       settings = {AlignBy: AlignBy, OrderBy: OrderBy, x: [x1, x2], y: [y1, y2]}
    //     sendTimelineCurrentIDsToSelection(ids,selectionname, settings);
    };

//--------------------------------------------------------------------------------------------
  function timelineD3PlotBrushReader(){
     console.log("plotBrushReader");
     TimeLineSelectedRegion = TimeLined3PlotBrush.extent();
     //console.log("region: " + pcaSelectedRegion);
     y0 = TimeLineSelectedRegion[0][1];
     y1 = TimeLineSelectedRegion[1][1];
     selectHeight = Math.abs(y0-y1);
     if(selectHeight > 1){
        TimeLineSelectionButton.prop("disabled", false);
        TimeLinebroadcastButton.prop("disabled", false);
     } else {
        TimeLineSelectionButton.prop("disabled", true);
        TimeLinebroadcastButton.prop("disabled", true);
     }
     }; // d3PlotBrushReader

   //--------------------------------------------------------------------------------------------
  function sendIDsToModule(ids, moduleName, title){
       callback = moduleName + title;
       msg = {cmd:"sendIDsToModule",
              callback: callback,
              status:"request",
              payload:{targetModule: moduleName,
                       ids: ids}
             };
     socket.send(JSON.stringify(msg));
      } // sendTissueIDsToModule

  //--------------------------------------------------------------------------------------------
   function sendTimelineCurrentIDsToSelection (ids,selectionname, settings) {
      console.log("entering sendTimelineCurrentIDsToSelection");
       console.log(ids.length + " patientIDs going to SavedSelection")
      
      var NewSelection = {   
                    "selectionname": selectionname,
         			"PatientIDs" : ids,
         			"Tab": "Timeline",
         			"Settings": settings
         		}
 
          addSelection(NewSelection, callback="");
 
      } // sendTissueIDsToModule

   //--------------------------------------------------------------------------------------------------     
   function handlePatientIDs(msg){
      console.log("Module.TimeLine: handlePatientIDs");
      console.log(msg)
    $("#tabs").tabs( "option", "active", TimelineTabNumber);
 //       TimeLineInitialLoad=true;
     if(msg.status == "success"){
         patientIDs = msg.payload
//         console.log("TimeLine handlePatientIds: " + patientIDs);
         payload = patientIDs
         msg = {cmd: "getCaisisPatientHistory", callback: "DisplayPatientTimeLine", status: "request", 
                payload: payload};
         socket.send(JSON.stringify(msg));
         }
      else{
         console.log("handlePatientIDs about to call alert: " + msg)
         alert(msg.payload)
         }
      }; // handlePatientIDs


    //----------------------------------------------------------------------------------------------------
    function loadPatientDemoData(){

       console.log("==== patientTimeLines  get Events from File");
//       TimeLineInitialLoad=true;
       cmd = "getCaisisPatientHistory";
       status = "request"
       callback = "DisplayPatientTimeLine"
          filename = "" // was 'BTC_clinicaldata_6-18-14.RData', now learned from manifest file
          msg = {cmd: cmd, callback: callback, status: "request", payload: filename};
        // console.log(JSON.stringify(msg))
       socket.send(JSON.stringify(msg));
              
       } // loadPatientDemoData

     //--------------------------------------------------------------------------------------------------
     function DisplayPatientTimeLine(msg) {
         console.log("==== DisplayPatientTimeLine  Module.js document.ready");
          console.log(msg);

         console.log("==== DisplayPatientTimeLine  Events");     
          Events = msg.payload;
          console.log("Event count: " + Events.length);
         
          parseDate = d3.time.format ("%m/%d/%Y").parse;
          FormatDate = d3.time.format ("%x");
     
            Events.forEach(function(d) {
               d.Keep=true;
               if(d.date instanceof Array){
                    for(var i=0;i<d.date.length;i++){ 
                         if(parseDate(d.date[i])===null || !isValidDate(d.date[i])){ 
                              console.log("Flag "+ d.date[i]); d.Keep = false;
                         }else{  d.date[i] = parseDate(d.date[i]); }
               }}else{
                    if(parseDate(d.date)===null || !isValidDate(d.date)){ console.log("Flag "+ d.date); d.Keep=false;
                    } else{d.date = parseDate(d.date); }
               }
               if(d.Name === "Death") d.Name="Status"
               d.disabled = false;
              if(ShowEvents){
               if(ShowEvents.indexOf(d.Name) === -1){  d.disabled = true;} }

             d.showPatient = true;
              d.offset = 0    });
     
          console.log("Remove Invalid Dates")
          Events = Events.filter(function(d) {if(!d.Keep){ console.log(d.date)}
               return d.Keep })

           EventsByID = d3.nest()
              .key(function(d) { return d.PatientID; })
               .key(function(d) { return d.Name; })
              .map(Events, d3.map);
 
          EventTypes = d3.map()
          Events.forEach(function(d){
               if(EventTypes.has(d.Name)){
                    if(EventTypes.get(d.Name).indexOf(d.Type) === -1){
                         EventTypes.get(d.Name).push(d.Type)            }
               } else {
                    EventTypes.set(d.Name, [d.Type])
               }
          });          
     
 
          CalculatedEvents.forEach(function(key, entry){
               var value = entry[0];
               if(!EventTypes.has(value.Event1) ||  !EventTypes.has(value.Event2) ){
                    console.log("Removing Calculated Event: " + key)
                    CalculatedEvents.remove(key)
               }
          })

//          console.log("CaculatedEvents stored:", CalculatedEvents)
//          console.log("Events stored:", Events)
//          console.log("EventsByID stored:", EventsByID)

          if(TimeLineInitialLoad){
               ShowEvents = EventTypes.keys();
               dispatch.LoadOptions();
               TimeLineInitialLoad=false;
          }
          dispatch.DisplayPatients();
     }

     //--------------------------------------------------------------------------------------------------
     dispatch.on("LoadOptions.AllDisplays", function(){

          console.log("======== LoadOptions.AllDisplays")
          
          var width = $("#TimeLineDisplay").width();
          var height = $("#TimeLineDisplay").height();
          
          var   TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                legendSize = {height: 0.05*height, width: TimeLineSize.width};

          var svg = d3.select("#TimeLineDisplay").append("svg")
                   .attr("id", "timelineSVG")
                   .attr("width", TimeLineSize.width + SideBarSize.width + 2*TimeLineMargin.left + 2*TimeLineMargin.right )
                   .attr("height", SideBarSize.height + TimeLineMargin.top + TimeLineMargin.bottom + legendSize.height)
                       ;

          var SidePlot = svg.append("g").attr("id", "SidePlotSVG")
                  .attr("transform", "translate(" + TimeLineMargin.left + "," + TimeLineMargin.top + ")");     
             
          var TimeLine = svg.append("g").attr("id", "TimeLineSVG")
                  .attr("transform", "translate(" + (SideBarSize.width+2*TimeLineMargin.left + TimeLineMargin.right) + "," + TimeLineMargin.top + ")");
          
          
          var TextOffSet = d3.scale.ordinal()
               .range(MainEventTextSpacing)
               .domain(MainEvents);

          console.log("==== Event Types")
          var legend = svg
                     .append("g")
                   .attr("class", "legend")
                   .attr("transform", "translate(" + (SideBarSize.width+2* TimeLineMargin.left + TimeLineMargin.right) + "," + (TimeLineSize.height+ TimeLineMargin.top + TimeLineMargin.bottom) + ")")
                    .selectAll(".legend")
                     .data(TimeLineColor.domain().filter(function(d){
                          return EventTypes.keys().indexOf(d) !== -1 })  )
              .enter().append("g")
            .attr("transform", function(d, i) { 
                      return "translate(" + i*TextOffSet(d) + ",0)" })
               ;
            legend.append("rect")
           .attr("width", 10)
           .attr("height", 10)
           .style("fill", function(d) { return TimeLineColor(d)})
           .on("click", ToggleVisibleEvent);

            legend.append("text")
            .attr("y", 9)
            .attr("x", 12)
            .style("font-size", 12)
           .text(function(d) { return d; });

          //--------------------------------------------------------------------------------------------------
          dispatch.on("DisplayPatients.SidePlotDisplay",  function(){

               console.log("======== DisplayPatients.SidePlotDisplay")
          
               SidePlot.selectAll("g").remove();

                   width = $("#TimeLineDisplay").width();
                    height = $("#TimeLineDisplay").height();
          
                 TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)}
                SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)}
                legendSize = {height: 0.05*height, width: TimeLineSize.width};
          
               svg.select(".legend")
                   .attr("transform", "translate(" + (SideBarSize.width+2* TimeLineMargin.left+TimeLineMargin.right) + "," + (TimeLineSize.height+ TimeLineMargin.top + TimeLineMargin.bottom) + ")")
          
               svg.attr("width", TimeLineSize.width + SideBarSize.width + 2*TimeLineMargin.left + 2*TimeLineMargin.right )
                   .attr("height", SideBarSize.height + TimeLineMargin.top + TimeLineMargin.bottom + legendSize.height)
                       ;
               TimeLine.attr("transform", "translate(" + (SideBarSize.width+2*TimeLineMargin.left + TimeLineMargin.right) + "," + TimeLineMargin.top + ")");
  
          
               var y = d3.scale.linear().range([SideBarSize.height, 0]), 
                    yAxis = d3.svg.axis().scale(y).orient("left").ticks(0),          
                    x = d3.scale.linear().range([0, SideBarSize.width]),
                    xAxis = d3.svg.axis().scale(x).orient("bottom");
                    
                    y.domain([d3.min(Events,function(d) { return PatientHeight*d.PtNum; })-PatientHeight,d3.max(Events,function(d) { return PatientHeight*d.PtNum; })+PatientHeight]);
//                  y.domain(d3.extent(Events, function(d) { return PatientHeight*d.PtNum; }));
//                   y.domain([d3.min(Events,function(d) { return d.PtNum; }),d3.max(Events,function(d) { return PatientHeight*d.PtNum; })]);
                             
               var PatientOrderBy = []
               var Categories = []

               
               console.log("Display Current Side Plot Event: " + SidePlotEvent)

               if(SidePlotEvent === "--"){     return;     
               } else if (CalculatedEvents.has(SidePlotEvent) ){
                    var event = CalculatedEvents.get(SidePlotEvent)[0]
                     console.log("Using event: ", event)
                     PatientOrderBy =  getHorizontalBarSize(getDateDiff(SidePlotEvent, event.Event1,event.Event2,event.TimeScale)); 
                    
               } else if(["Chemo", "Radiation", "Diagnosis", "OR", "Status", "MRI"].indexOf(SidePlotEvent) !== -1){
                    //get number of categories
                    EventsByID.forEach(function(ID, Patient){
                         if(Patient.has(SidePlotEvent) && Patient.get(SidePlotEvent)[0].showPatient){
                              Patient.get(SidePlotEvent).forEach(function(k){
                              if(Categories.indexOf(k.Type) == -1){ Categories.push(k.Type)} })
                         }
                    })
                    Categories.sort();
//                    console.log(Categories)
//                    console.log(Categories.length)
                    var xWidth = 1/Categories.length;
                    EventsByID.forEach(function(ID, Patient){
                         if(!Patient.has(SidePlotEvent)){
                         } else if(Patient.get(SidePlotEvent)[0].showPatient){               
                              var xPos = Categories.indexOf(Patient.get(SidePlotEvent)[0].Type)
                              PatientOrderBy.push( {ID: ID,info:Patient.get(SidePlotEvent)[0].Type, yBar: Patient.get(SidePlotEvent)[0].PtNum,
                                              xBar: xPos * xWidth , width: xWidth})
                         }
                    })
                    xAxis.ticks(Categories.length)
                         .tickValues(makeArray(Categories.length,  function(i) { return i/Categories.length; }))
                         .tickFormat(function (d) {return Categories[d*Categories.length]     })
               } 

               console.log("PatientOrderBy")
               console.log(PatientOrderBy)

                x.domain([d3.min([d3.min(PatientOrderBy, function(d){return d.width}),d3.min(PatientOrderBy, function(d){return d.xBar})]),
                               d3.max(PatientOrderBy, function(d){ return d.xBar + d.width})]).nice();

//               console.log("SidePlotDomain: ", d3.min([d3.min(PatientOrderBy, function(d){return d.width}),d3.min(PatientOrderBy, function(d){return d.xBar})]),
//               d3.max(PatientOrderBy, function(d){ return d.xBar + d.width}) )

 //            d3PlotBrush = d3.svg.brush()
   //            .x(x)
     //          .y(y)
       //        .on("brushend", d3PlotBrushReader);

          //     SidePlot.call(d3PlotBrush);

//			var HorizLine = svg.append("g").attr("class", "rect")

             var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");
     
                 SidePlot.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (SideBarSize.height+TimeLineMargin.top) + ")")
                .call(xAxis)
                .selectAll("text")  
                    .style("text-anchor", "end")
                    .style("font-size", 12)
                      .attr("dy", ".55em")
                      .attr("dx", "-.45em")
                     .attr("transform", function(d) {
                         return "rotate(-75)" 
                        });
 
                 SidePlot.append("g")
                .attr("class", "y axis")
                .call(yAxis)
              .append("text")
                .on("mouseover", function(d){
                        tooltip.text("click to reorder by SidePlot value");
                     return tooltip.style("visibility", "visible"); })
                 .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
               .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                 .on("click", function(){
                           OrderBySidePlot(); 
                           dispatch.Update();
                           dispatch.DisplayPatients();})
                .attr("transform", "rotate(-90)")
                .attr("y", 2)
                .attr("dy", "-.71em")
                .style("font-size", 12)
                .style("text-anchor", "end")
                .text(SidePlotEvent)
                ;
            
               var BarPlot_Horiz = SidePlot.append("g").selectAll("rect")
                    .data(PatientOrderBy)
                    .enter()
                         .append("rect")
                         .attr("x", function(d) { return x(d.xBar);  })
                         .attr("y", function(d) { return y(PatientHeight*d.yBar); })
                         .attr("width", function(d) { return Math.abs(x(d.width) - x(0));  })
                         .attr("height", function(d) { return PatientHeight; })
                         .attr("fill", function(d){ 
                              var ColorShade =  d3.rgb(TimeLineColor(SidePlotEvent)); //d3.rgb("grey"); //
                              if(Categories.length>0){ 
                                   return ColorShade.brighter((Categories.indexOf(d.info) % 5)/2) };
                              return ColorShade;
                              })
                         .on("mouseover", function(d,i){
                          tooltip.text(d.ID + ": " + d.info);
                     return tooltip.style("visibility", "visible");
                     })
                          .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                          .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                         ;
          })

          //--------------------------------------------------------------------------------------------------
          dispatch.on("DisplayPatients.TimeLineDisplay",  function(){

               console.log("======== DisplayPatients.TimeLineDisplay")
               TimeLine.selectAll("g").remove();


                var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");

 
                var x,TimeScale, xTitle, xAxis, 
                    y = d3.scale.linear().range([TimeLineSize.height, 0]), 
                    yAxis = d3.svg.axis().scale(y).orient("left").ticks(0)
                    ;
               function LogTime(t){
                     if(AlignBy === "--"){ 
                               return t;
                     } else{ var Dir = (t<0 ? -1 : 1); 
                         return Dir * Math.log(Math.abs(t)+1)/Math.log(2) 
                    }
               }     
          
               if(OrderBy !== "--"){ OrderEvents();}
               if(AlignBy === "--"){ 
                     x = d3.time.scale().range([0, TimeLineSize.width]); TimeScale =1;
                     Xtitle="Year";
                     xAxis = d3.svg.axis().scale(x).orient("bottom")
               } else{
                    AlignEvents();
                     x =  d3.scale.linear().range([0, TimeLineSize.width])
                     TimeScale = OneDay
                     Xtitle = "Days"
                     xAxis = d3.svg.axis().scale(x).orient("bottom")
                         .ticks(10)
                         .tickFormat(function (d) { 
                              var Dir = (d<0 ? -1 : 1); 
                              return Math.round(Dir * (Math.pow(2, (Math.abs(d)))-1) *100)/100})
                    }

               var EventMin      = d3.min(Events.filter(function(d){ return d.showPatient && !d.disabled}), function(d){ 
                                        var date = (d.date instanceof Array ? d.date.sort(DescendingDate)[0] : d.date);  return LogTime((date - d.offset)/TimeScale);})
               var EventMax      = d3.max(Events.filter(function(d){ return d.showPatient && !d.disabled}), function(d){ 
                                        var date = (d.date instanceof Array ? d.date.sort(DescendingDate)[d.date.length-1] : d.date);  return LogTime((date - d.offset)/TimeScale);})

               x.domain([EventMin, EventMax]);
               y.domain([d3.min(Events,function(d) { return PatientHeight*d.PtNum; })-PatientHeight,d3.max(Events,function(d) { return PatientHeight*d.PtNum; })+PatientHeight]);
               console.log(y.domain())
      
               var EventOffset = d3.map({"Radiation": 1/3*(1/y.domain()[1]), "Chemo": -1/3*(1/y.domain()[1])})
 

             TimeLined3PlotBrush = d3.svg.brush()
               .x(x)
               .y(y)
               .on("brushend", timelineD3PlotBrushReader);

               TimeLine.call(TimeLined3PlotBrush);


            TimeLine.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + TimeLineSize.height + ")")
                .call(xAxis)
               .append("text")
               .style("font-size", 12)
                .text(Xtitle);
 
            TimeLine.append("g")
                .attr("class", "y axis")
                .call(yAxis)
              .append("text")
                     .attr("transform", "rotate(-90)")
                .attr("y", 2)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .style("font-size", 12)
                .text("Patients");
      
              var Hoverbar = TimeLine.append("g")
                .attr("class", "hoverbar")

 
                var TimeSeries = TimeLine.append("g").selectAll("path")
                    .data(Events.filter(function(d){ return (d.date instanceof Array) && !d.disabled && d.showPatient}))
               ;

      //         console.log("TimeSeries", TimeSeries)

               TimeSeries.enter()
                    .append("line")
                    .attr("class", "path")
                    .attr("x1", function(d) { return x(LogTime((d.date[0] - d.offset)/TimeScale));  })
                    .attr("y1", function(d) { return y(PatientHeight*(d.PtNum + EventOffset.get(d.Name))); })
                    .attr("x2", function(d) { return x(LogTime((d.date[1] - d.offset)/TimeScale));  })
                    .attr("y2", function(d) { return y(PatientHeight*(d.PtNum+ EventOffset.get(d.Name))); })
                    .attr("stroke", function(d){ 
                         var ColorShade = d3.rgb(TimeLineColor(d.Name)); 
                         if(d3.keys(d).indexOf("Type") !== -1){ 
                              return ColorShade.brighter((EventTypes.get(d.Name).indexOf(d.Type) % 5)/2) };
                         return ColorShade;
                         })
                    .attr("stroke-width", PatientHeight*0.75)
                    .attr("data-legend",function(d) { return d.Name})
                    .on("mouseover", function(d,i){
                        Hoverbar.append("rect")
                            .attr("x", 0)
                            .attr("y", y(d.PtNum*PatientHeight))
                            .attr("width", TimeLineSize.width)
                            .attr("height", PatientHeight)
                            .style("fill", "grey").style("opacity", 0.3);
                           
                         var Type = ""; if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Type}
                     tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.date[0]) + ", "+ FormatDate(d.date[1]) + ") " + Type);
                     return tooltip.style("visibility", "visible");
                     })
                     .on("mousemove", function(){return tooltip.style("top",
                    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                     .on("mouseout", function(){
                        Hoverbar.select("rect").remove();
                        return tooltip.style("visibility", "hidden");})
                    ;

               TimeSeries.exit().remove();

               var TimePoint = TimeLine.append("g").selectAll("circle")
                    .data(Events.filter(function(d){ return !(d.date instanceof Array) && !d.disabled && d.showPatient}));

      //         console.log("TimePoint", TimePoint)
                    
               TimePoint.enter()
                    .append("circle")
                    .attr("class", "circle")
                    .style("fill", function(d){ return TimeLineColor(d.Name) })
                    .attr("cx", function(d) {return x(LogTime((d.date -d.offset)/TimeScale)); })
                    .attr("cy", function(d) { return y(PatientHeight*d.PtNum); })
                    .attr("r", function(d) { return PatientHeight;})
                    .attr("data-legend",function(d) { return d.Name})
                    .on("mouseover", function(d,i){
                         Hoverbar.append("rect")
                            .attr("x", 0)
                            .attr("y", y(d.PtNum*PatientHeight))
                            .attr("width", TimeLineSize.width)
                            .attr("height", PatientHeight)
                            .style("fill", "grey").style("opacity", 0.3);

                         var Type = ""; if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Type}
                      tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.date) +") " + Type);
                      return tooltip.style("visibility", "visible");
                     })
                     .on("mousemove", function(){return tooltip.style("top",
                    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                     .on("mouseout", function(){ Hoverbar.select("rect").remove();return tooltip.style("visibility", "hidden");})
               ;

               TimePoint.exit().remove();                    

               })
          })

          //--------------------------------------------------------------------------------------------------
          dispatch.on("load.Menu", function(){
         
              var width = $("#TimeLineDisplay").width();
               var height = $("#TimeLineDisplay").height();
          
               var   TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                     SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                     legendSize = {height: 0.05*height, width: TimeLineSize.width};

               console.log("======== load.Menu")
               var PatientMenu = d3.select("#PatientSetDiv")
                    .attr("transform", "translate(" + (3*TimeLineMargin.left+SideBarSize.width+TimeLineMargin.right) + ",0)")
                    .append("g")
                     .append("select")
   //                  .attr("multiple", "multiple")
                     .on("focus",function(d){
                          UpdateSelectionMenu()})
                     .on("change", function() {
                        getSelectionbyName(this.value, callback="FilterTimelinePatients"); 
                         })
                 ;
                
                 
                 //--------------------------------------------------------------------------------------------
               function UpdateSelectionMenu(){           
                  
                      PatientMenu.selectAll("option")
                           .data(getSelectionNames(), function(d){return d;})
                           .enter()
                             .append("option")
                             .attr("value", function(d){return d})
                             .text(function(d) { return d})
                        ;
//                        PatientMenu.selectAll("option").exit().remove()
                }
 
 //d3.select("input").property("checked", true).each(change);
//<label><input type="checkbox"> Sort values</label>

//  <label><input type="radio" name="dataset" value="apples" checked> Apples</label>
//  <label><input type="radio" name="dataset" value="oranges"> Oranges</label>


                 var  AlignByMenu = d3.select("#AlignByDiv")
                   .attr("transform", "translate(" + (3*TimeLineMargin.left+SideBarSize.width+TimeLineMargin.right) + ",0)")
                    .append("g")
                     .append("select")
                    .on("change", function() {
                         AlignBy = this.value; 
                         AlignEvents(); 
                         dispatch.DisplayPatients()});
                 ;
               AlignByMenu.selectAll("option")
                    .data(["--"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;

                 var  OrderByMenu = d3.select("#OrderByDiv")
                   .attr("transform", "translate(" + (TimeLineMargin.left+SideBarSize.width+TimeLineMargin.left+TimeLineMargin.right) + ",0)")
                     .append("g")
                   .append("select")
                    .on("change", function() {
                         OrderBy = this.value; 
                         if(OrderBy === "+Add"){
                              console.log("== changing OrderBy with ", OrderBy)
                              OpenDialogForAddedEvents("OrderBy");
                         } else{
                              console.log("== changing OrderBy ", OrderBy)
                         OrderEvents();      
                              dispatch.DisplayPatients();
//                              dialog.dialog("destroy");
                         }
                    })
                 ;
               OrderByMenu.selectAll("option")
                    .data(["--", "+Add"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
               var  AddSideBarMenu = d3.select("#AddSideBar")
                    .style("display", "inline-block") 
                    .style("width", (SideBarSize.width + 2*TimeLineMargin.left + TimeLineMargin.right) +"px" )
                    .append("g")
                    .append("select")
                    .on("change", function() {SidePlotEvent = this.value; 
                         if(SidePlotEvent === "+Add"){
                              console.log("== changing SideBar with ", SidePlotEvent)
                              OpenDialogForAddedEvents("SidePlot");
                         } else{ 
                              console.log("== changing SideBar", SidePlotEvent)
                                                  dispatch.DisplayPatients(); 
//                         dialog.dialog("destroy");
                         }
                                                  });
               AddSideBarMenu.selectAll("option")
                    .data(["--", "+Add"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
                var  SaveImage = d3.select("#SaveImageDiv")
                    .on("click", function() {
                         console.log("========Save Image: ")
          
                         var html = d3.select("svg")
                                      .attr("version", 1.1)
                                  .attr("xmlns", "http://www.w3.org/2000/svg")
                                      .node().parentNode.innerHTML;
                        var imgsrc = 'data:image/svg+xml;base64,'+ btoa(html);
                         var img = '<img src="'+imgsrc+'">';
                    
                         var canvas = document.querySelector("canvas"),
                             context = canvas.getContext("2d");

                         var image = new Image;
                         image.src = imgsrc;
                         image.onload = function() {
                                context.drawImage(image, 0, 0);
          
                              var canvasdata = canvas.toDataURL("image/png");
                              var pngimg = '<img src="'+canvasdata+'">'; 

                                var a = document.createElement("a");
                                   a.download = "test.png"
                                     a.href = canvasdata;
                                a.click();
                         }
                    })
     
         //--------------------------------------------------------------------------------------------------
         dispatch.on("UpdateMenuOptions.Menu", function(){
     
            console.log("======== UpdateMenuOptions")
//            console.log("CalculatedEvents keys: ", CalculatedEvents.keys())
  //          console.log("EventTypes keys: ",EventTypes.keys())
    //        console.log("OrderByMenu: ", OrderByMenu)
     
          OrderByMenu.selectAll("option").remove()     
          AlignByMenu.selectAll("option").remove()
          AddSideBarMenu.selectAll("option").remove()
              
           OrderByMenu.selectAll("option")
                    .data(d3.merge([["--", "+Add"], CalculatedEvents.keys() ,EventTypes.keys()]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
       
                 AlignByMenu.selectAll("option")
                    .data(d3.merge([["--"],EventTypes.keys()]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
           ;
           
           AddSideBarMenu.selectAll("option")
                    .data(d3.merge([["--", "+Add"], CalculatedEvents.keys(), ["Radiation", "Chemo", "Diagnosis", "OR", "MRI", "Status"].filter(function(d){ return EventTypes.has(d) })]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
           ;
           
           UpdateSelectionMenu();
     
     
        })
        //--------------------------------------------------------------------------------------------------
          dispatch.on("LoadOptions.Menu",  function(){
               console.log("======== LoadOptions.Menu")     
               dispatch.UpdateMenuOptions()
          })
     
          
          //--------------------------------------------------------------------------------------------------
          dispatch.on("Update.Menu", function(){
               console.log("======== Update.Menu")
                
               OrderByMenu.selectAll("option")
                         .each(function(d){if(d === OrderBy) return d3.select(this).attr("selected", "selected")})
               AddSideBarMenu.selectAll("option")
                         .each(function(d){if(d === SidePlotEvent) return d3.select(this).attr("selected", "selected")})				
               AlignByMenu.selectAll("option")
                         .each(function(d){if(d === AlignBy) return d3.select(this).attr("selected", "selected")})
          })
     })
                          
    //--------------------------------------------------------------------------------------------
     function FilterTimelinePatients(msg){
    
        console.log("=======Updating Patient Selection")
//        console.log(msg.payload)
        
 //       selections = msg.payload
//         patientIDs = selections.patientIDs
        // console.log("TimeLine Filter PatientIds: " + patientIDs);
      patientIDs = []
      selections = msg.payload;
      console.log(d3.values(selections))
      d3.values(selections).forEach(function(d){ console.log(d); patientIDs.push(d.patientIDs)})
      
         msg = {cmd:"getCaisisPatientHistory", callback: "DisplayPatientTimeLine", status: "request", payload: patientIDs};
console.log(msg)
         socket.send(JSON.stringify(msg));
     }
    //--------------------------------------------------------------------------------------------
     function UpdateCalculatedEvent(value){
               
          }
        //--------------------------------------------------------------------------------------------
       function CreateCalculatedEvent() {
                          var Name = $( "#Name" ).val();
                          var Event1 = $( "#Event1" ).val();
                          var Event2 = $( "#Event2" ).val();
                          var TimeScale = $( "#TimeScale").val();
  //                       console.log("Calculated Event: ")
//                         console.log(Name, Event1 , Event2, TimeScale);

                          var valid = true;
      
                          valid = valid && EventTypes.has(Event1);
                          valid = valid && EventTypes.has(Event2);
                           valid = valid && ["Days", "Months", "Years"].indexOf(TimeScale) !== -1;
  
                          if ( valid ) {
                            CalculatedEvents.set(Name, [{Name: Name, Event1: Event1, Event2: Event2,  TimeScale: TimeScale}])
                            console.log("Calculated Events Added: " + Name)
                            console.log(CalculatedEvents);
                             dialog.dialog( "close" );
                             return(Name);
                          } else {
                                 console.log("Invalid Calculated Event");
                               return("--");
                          }
                   }

      
      //--------------------------------------------------------------------------------------------
       function OpenDialogForAddedEvents(MenuType) {
          console.log("======== Dialog for Adding Events")
          dialog = $( "#AddCalculatedEvent" ).dialog({
                autoOpen: false,
                title: "Calculate Event",
                height: 300,
                width: 400,
                buttons: {
                  "Create": function(){
                            var value = CreateCalculatedEvent()
                            
                            if(MenuType == "OrderBy"){
                                   OrderBy = value;
                                   console.log("OrderBy is now: " + OrderBy);
                                   OrderEvents();
                              } else if (MenuType == "SidePlot"){
                                   SidePlotEvent = value;
                                   console.log("SidePlotEvent is now: " + SidePlotEvent);
                              }
                              dialog.dialog("close")
                               dispatch.UpdateMenuOptions();
                               dispatch.Update(); 
                               dispatch.DisplayPatients();
                       },
                  Cancel: function() { dialog.dialog( "close" ); UpdateCalculatedEvent("--");}
                },
                close: function() {}
                
         });
           dialog.dialog( "open" );
 
     }

     //--------------------------------------------------------------------------------------------------
     function AlignEvents(){
     
          console.log("========Align Event: "+ AlignBy);
          Events.forEach(function(d){ d.offset = 0; d.showPatient=true;})
          EventsByID.forEach(function(ID, Patient){
                         Patient.forEach(function(id, event){event.showPatient = true; event.offset=0;})})

          if (AlignBy === "AgeDx"){ 
          } else if(EventTypes.keys().indexOf(AlignBy) !== -1){
               EventsByID.forEach(function(ID, Patient){
                    if( Patient.has(AlignBy)){
                         var MinPatientAlignBy = d3.min(Patient.get(AlignBy), function(d) {var date = (d.date instanceof Array ? d3.min(d.date) : d.date);  return date})
                         Events.filter(function(d){return d.PatientID === ID})
                              .forEach(function(d){ d.offset = MinPatientAlignBy;})
                    }
                    else{          // hide Patients that can't be aligned
                         Events.filter(function(d){return d.PatientID === ID})
                                   .forEach(function(d){ d.showPatient = false; d.offset=0;})
                         Patient.forEach(function(id, event){event.showPatient = false; event.offset=0;})
                    }
               })
          }
     }     

     //--------------------------------------------------------------------------------------------------
     function OrderEvents(){
     
          console.log("========Order Event: "+ OrderBy);
          var PatientOrderBy = []


          if(CalculatedEvents.has(OrderBy) ){
                var event = CalculatedEvents.get(OrderBy)[0]
//                console.log(event)
                PatientOrderBy = getDateDiff(OrderBy, event.Event1,event.Event2,""); 
          } else if(EventTypes.keys().indexOf(OrderBy) !== -1){
               EventsByID.forEach(function(ID, Patient){
                    if( Patient.has(OrderBy)){
                         PatientOrderBy.push(d3.min(Patient.get(OrderBy), function(d) 
                              {var date = (d.date instanceof Array ? d3.min(d.date) : d.date);   
                                   return {ID: ID, value: date} }))
                    } else{
                         PatientOrderBy.push({ID: ID, value: 0} )
                    }   })
          } 
     
          PatientOrderBy.sort(DescendingValues).forEach(function(Ordered, i){
                         Events.filter(function(d){return d.PatientID === Ordered.ID})
                                   .forEach(function(d){ d.PtNum = i})
                         if(EventsByID.has(Ordered.ID)){EventsByID.get(Ordered.ID)
                                   .forEach(function(d){ d.PtNum = i})}
               })
          console.log("Reordered")
          console.log(PatientOrderBy)
     }     
     //--------------------------------------------------------------------------------------------------
     function OrderBySidePlot(){
     
          console.log("========Order by SidePlot: "+ SidePlotEvent);
          var PatientOrderBy = [], Categories = [];

          OrderBy = "--";
          if(CalculatedEvents.has(SidePlotEvent) ){
                var event = CalculatedEvents.get(SidePlotEvent)[0]
//                console.log(event)
                PatientOrderBy = getDateDiff(SidePlotEvent, event.Event1,event.Event2,""); OrderBy=SidePlotEvent;
          
          } else if(EventTypes.keys().indexOf(SidePlotEvent) !== -1){

               EventsByID.forEach(function(ID, Patient){
                    if(Patient.has(SidePlotEvent) && Patient.get(SidePlotEvent)[0].showPatient){
                         Patient.get(SidePlotEvent).forEach(function(k){
                              if(Categories.indexOf(k.Type) == -1){ Categories.push(k.Type)}
                         })
                         PatientOrderBy.push({ID:ID, value: Patient.get(SidePlotEvent)[0].Type})
                    }
               })
               
               Categories.sort();
  //             console.log(Categories)
  //             console.log(Categories.length)
          
               PatientOrderBy.forEach(function(d,i){
                    d.value = Categories.indexOf(d.value)
               })
               
          }
          
          PatientOrderBy.sort(DescendingValues).forEach(function(Ordered, i){
                         Events.filter(function(d){return d.PatientID === Ordered.ID})
                                   .forEach(function(d){ d.PtNum = i})
                         if(EventsByID.has(Ordered.ID)){EventsByID.get(Ordered.ID)
                                   .forEach(function(d){ d.PtNum = i})}
               })
          
          
          console.log("Reordered")
          console.log(PatientOrderBy)
     }     

     //--------------------------------------------------------------------------------------------------
     function DescendingDate(a,b) {
       if (a.date > b.date)
          return -1;
       if (a.date < b.date)
         return 1;
       return 0;
     }
    //--------------------------------------------------------------------------------------------------
     function DescendingStartDate(a,b) {
       if (a.date[0] > b.date[0])
          return -1;
       if (a.date[0] < b.date[0])
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function AscendingDate(a,b) {
       if (a.date < b.date)
          return -1;
       if (a.date > b.date)
         return 1;
       return 0;
     }
    //--------------------------------------------------------------------------------------------------
     function AscendingStartDate(a,b) {
       if (a.date[0] < b.date[0])
          return -1;
       if (a.date[0] > b.date[0])
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function DescendingValues(a,b) {
       if (a.value > b.value)
          return -1;
       if (a.value < b.value)
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function makeArray(count, content) {
        var result = [];
        if(typeof(content) == "function") {
           for(var i=0; i<count; i++) {
              result.push(content(i));
           }
        } else {
           for(var i=0; i<count; i++) {
              result.push(content);
           }
        }
        return result;
     }
     //--------------------------------------------------------------------------------------------------
     function isValidDate(text) {
          //eg text = '2/30/2011';
     
          var comp = text.split('/');
          var m = parseInt(comp[0], 10);
          var d = parseInt(comp[1], 10);
          var y = parseInt(comp[2], 10);
          var date = new Date(y,m-1,d);
     
          if (date.getFullYear() !== y || date.getMonth() + 1 !== m || date.getDate() !== d){
               console.log("Invalid Format Month/Day/Year " + text + ": " + m + "/" + d+ "/" + y)
             return false;
          }
               
          // check month and year
          if(y < 1000 || y > 3000 || m == 0 || m > 12){
               console.log("Invalid Month/Year: " + m + "/" + y)
             return false;
          }
         var monthLength = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 ];
     
         // Adjust Days for leap years
         if(y % 400 == 0 || (y % 100 != 0 && y % 4 == 0))
             monthLength[1] = 29;
     
         // Check the range of the day
         if( d <= 0 || d > monthLength[m - 1]){
               console.log("Invalid Day/Month: " + d+ "/" + m)    
               return false;
          }
          
          return true;
     }
     //--------------------------------------------------------------------------------------------------     
     function ToggleVisibleEvent(d){
         
         var hide = false;
         var newFilters = [];
      
         ShowEvents.forEach(function (f) {
           if (d === f) {  
                hide = true;
                console.log("Hiding " + d);
                Events.forEach(function(D){ 
                     if(D.Name === d) {D.disabled=true}});
           } else { newFilters.push(f);}
         });
     
          // Hide the shape or show it
          if (hide) {  d3.select(this).style("opacity", 0.2);
         } else {
           d3.select(this).style("opacity", 1);
           newFilters.push(d);
           Events.forEach(function(D){ 
                     if(D.Name === d) {D.disabled=false}});
          }
          ShowEvents = newFilters;
          dispatch.DisplayPatients();
     }
     //--------------------------------------------------------------------------------------------------
     
     //--------------------------------------------------------------------------------------------------

  return{
   init: function(){
          onReadyFunctions.push(initializeUI);
          
          addJavascriptMessageHandler("DisplayPatientTimeLine", DisplayPatientTimeLine);
         addJavascriptMessageHandler("timeLinesHandlePatientIDs", handlePatientIDs);
//         addJavascriptMessageHandler("UpdateSelectionList", UpdateSelectionMenu);
         addJavascriptMessageHandler("FilterTimelinePatients", FilterTimelinePatients);
         socketConnectedFunctions.push(loadPatientDemoData);
   },
   RefreshSelectionMenu: function(){
       dispatch.UpdateMenuOptions();
   }
  };

}); // TimeLineModule
//----------------------------------------------------------------------------------------------------
PatientTimeLine = TimeLineModule();
PatientTimeLine.init();
</script>


<body>
<style>

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.select{
	background-color: white;
}
.button{
	background-color: white;
	border-radius: 0 0 5px 5px; 
	border-style: none solid solid; 
	border-width: 0 1px 1px;

}
.resizable {
    resize: both;   /* Options: horizontal, vertical, both */
    overflow: auto; /* fix for Safari */
}

.domain { 
  fill: none; 
  } 



</style>

<canvas width="960" height="500" style="display:none"></canvas>

<div id="patientTimeLinesDiv">
	<div id="ArrangeDataDiv">
	     <span id="AddSideBar">Features: </span>
	     <span id="PatientSetDiv">Patient Set:</span> 
	     <span id="AlignByDiv">Align By: </span>
	     <span id="OrderByDiv">Order By: </span>
<!--	     <button id="SaveImageDiv">Save Image </button> 
  -->        	 <button id="SendSelectionToClinicalTable">To Clinical Data... </button>
     	 <button id="timelineSaveSelection">Save Selection</button>
     </div>
     <div id="TimeLineDisplay">
      </div>
     
     <div id="AddCalculatedEvent"  style="display:none">
     <form>
          <label for="Name">Name</label>
          <input type="text" id="Name" value="e.g. Survival"><br>
          <label for="Event1">Event 1</label>
          <input type="text" id="Event1" value="(legend)"><br>
          <label for="Event2">Event 2</label>
          <input type="text" id="Event2" value="(legend)"><br>
          <label for="TimeScale"> Time Scale</label>
          <input type="text" id="TimeScale" value="Days, Months, Years"><br>
	</form>
     </div>
</div>

</body>
</html>

<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">

	<script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111018/d3/d3.layout.js"></script>
	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined")
    {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
    }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------
</script>


<script>
//----------------------------------------------------------------------------------------------------
var SavedSelectionModule = (function (){
     
     var nodecount_i;
     var height;
     var root;
    
    var	tree, diagonal;
	var SaveSelectedDisplay;
    var InitialLoad;
    var SaveSelectedsvg;
    var CurrentSelection;
    var SelectionNames= [];
  
//--------------------------------------------------------------------------------------------
  function handleWindowResize(){
      SaveSelectedDisplay.width($(window).width() * 0.95);
      SaveSelectedDisplay.height($(window).height() * 0.95);
     }; // handleWindowResize

   
//----------------------------------------------------------------------------------------------------
	function initializeSelectionUI(){			     
	 console.log("====== Initializing Selection UI")

        nodecount_i=0;
         var margin = {top: 10, right: 15, bottom: 30, left: 20};
        InitialLoad = true;
	    SaveSelectedDisplay = $("#SavedSelectionTreeDiv");
        handleWindowResize();
        
        height = SaveSelectedDisplay.height(); //200;      
        var width = SaveSelectedDisplay.width(); //200;       
         
        tree = d3.layout.tree()
         .size([(height-margin.top-margin.bottom), (width-margin.left-margin.right)]);
     
        diagonal = d3.svg.diagonal()
         .projection(function(d) { return [d.y, d.x]; });
          
        SaveSelectedsvg = d3.select("#SavedSelectionTreeDiv").append("svg")
         .attr("width", width)
         .attr("height", height)
         .append("g")
             .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

         $(window).resize(handleWindowResize);

        if(typeof(window.tabsAppRunning) == "undefined") {
      		$("#ModuleDate").text(fetchHeader("Module.js") );
        } else {
            $("#ModuleDate").text(fetchHeader("../../tabsApp/Module.js") );
        }
		// if date modified needs updated
		//http://www.dynamicdrive.com/forums/archive/index.php/t-63637.html

       };
       
//----------------------------------------------------------------------------------------------------
     function testingAddSavedSelection() {
       msg = {cmd:"test",
              callback: "",
              status:"request",
              payload:{  name: "test set",
         			PatientIDs : "random set of IDs here",
         			Tab: "None",
         			Settings: "gibberish"
         		}
             };
        addSavedSelection(msg);

}
//----------------------------------------------------------------------------------------------------
     function addSavedSelection(msg) {
       
       console.log("=== Saving Selection", msg)
 
 		var i=0;
 		var nameSuffix = ""
 		var nodeName =msg.payload.name 
        while(SelectionNames.indexOf(nodeName.concat(nameSuffix)) !== -1){
		    i++;
		    nameSuffix = "_".concat(i)	
		}
       newNode = msg.payload
       newNode.name = nodeName.concat(nameSuffix)
       SelectionNames.push(newNode.name)
       
       if(CurrentSelection.children){ 
            CurrentSelection.children.push(newNode);
       } else { CurrentSelection.children = [newNode] }
       
       var currentNode = CurrentSelection
       var update_id = CurrentSelection.id
       while(currentNode.parent){ 
          currentNode.parent.children[ currentNode.parent.children.indexOf(function(d) {  d.id ===update_id})] = currentNode;
          currentNode = currentNode.parent
        }
        root = currentNode;
       updateSavedSelection(root);
       
       CurrentSelection = CurrentSelection.children.filter(function(d){ return d.id === nodecount_i })[0]
    console.log("new tree: ", root)
    console.log("CurrentSelection: ", CurrentSelection)
	}       


//----------------------------------------------------------------------------------------------------
function make_editable(d, field)
{
// code from https://gist.github.com/GerHobbelt/2653660

    console.log("make_editable", arguments);
 
    this
      .on("mouseover", function() {
        d3.select(this).style("fill", "red");
      })
      .on("mouseout", function() {
        d3.select(this).style("fill", null);
      })
      .on("click", function(d) {
        var p = this.parentNode;
        console.log(this, arguments);
 
        // inject a HTML form to edit the content here...
 
        // bug in the getBBox logic here, but don't know what I've done wrong here;
        // anyhow, the coordinates are completely off & wrong. :-((
        var xy = this.getBBox();
        var p_xy = p.getBBox();
 
        xy.x -= p_xy.x;
        xy.y -= p_xy.y;
 
        var el = d3.select(this);
        var p_el = d3.select(p);
 
        var frm = p_el.append("foreignObject");
 
        var inp = frm
            .attr("x", xy.x)
            .attr("y", xy.y)
            .attr("width", 300)
            .attr("height", 25)
            .append("xhtml:form")
                    .append("input")
                        .attr("value", function() {
                            // nasty spot to place this call, but here we are sure that the <input> tag is available
                            // and is handily pointed at by 'this':
                            this.focus();
 
                            return d[field];
                        })
                        .attr("style", "width: 294px;")
                        // make the form go away when you jump out (form looses focus) or hit ENTER:
                        .on("blur", function() {
                            console.log("blur", this, arguments);
 
                            var txt = inp.node().value;
 
                            d[field] = txt;
                            el
                                .text(function(d) { return d[field]; });
 
                            // Note to self: frm.remove() will remove the entire <g> group! Remember the D3 selection logic!
                            p_el.selectAll(function() { return this.getElementsByTagName("foreignObject"); }).remove();
                        })
                        .on("keydown", function() {
                            console.log("keypress", this, arguments);
 
                            // IE fix
                            if (!d3.event)
                                d3.event = window.event;
 
                            var e = d3.event;
                            if (e.keyCode == 13)
                            {
                                if (typeof(e.cancelBubble) !== 'undefined') // IE
                                  e.cancelBubble = true;
                                if (e.stopPropagation)
                                  e.stopPropagation();
                                e.preventDefault();
 
                                var txt = inp.node().value;
 
                                d[field] = txt;
                                el
                                    .text(function(d) { return d[field]; });
 
                                // odd. Should work in Safari, but the debugger crashes on this instead.
                                // Anyway, it SHOULD be here and it doesn't hurt otherwise.
                                p_el.selectAll(function() { return this.getElementsByTagName("foreignObject"); }).remove();
                            }
                        });
      });
}
//----------------------------------------------------------------------------------------------------
     function updateSavedSelection(source) {
       var duration = d3.event && d3.event.altKey ? 5000 : 500;
     
     var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "20")
                .style("visibility", "hidden")
                ;
     
       // Compute the new tree layout.
       var nodes = tree.nodes(root).reverse();
       console.log("Nodes", nodes);
       
       // Normalize for fixed-depth.
       nodes.forEach(function(d) { d.y = d.depth * 180; });
     
       // Update the nodes…
       var node =  SaveSelectedsvg.selectAll("g.node")
           .data(nodes, function(d) { return d.id || (d.id = ++nodecount_i); });
     
       // Enter any new nodes at the parent's previous position.
       var nodeEnter = node.enter().append("g")
           .attr("class", "node")
           .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
            .on("click", function(d) { toggle(d); updateSavedSelection(d); });
     
       nodeEnter.append("circle")
           .attr("r", 1e-6)
           .style("fill", function(d) { return d._children ? "lightsteelblue" : "grey"; })
           .on("mouseover", function(d){
                  var settings = getSettingsString(d);
                    tooltip.html(d.PatientIDs.length + " Patients from " + d.Tab + "<br></br>Settings: " + settings)
                     return tooltip.style("visibility", "visible"); })
           .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
           .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
           ;
     
       nodeEnter.append("text")
           .attr("class", "NodeName")
           .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
           .attr("dy", "1em")
           .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
           .text(function(d) { return d.name; })
           .style("fill-opacity", 1e-6)
           .call(make_editable, "NodeName");
     
       // Transition nodes to their new position.
       var nodeUpdate = node.transition()
           .duration(duration)
           .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });
     
       nodeUpdate.select("circle")
           .attr("r", 4.5)
           .style("fill", function(d) { return d._children ? "lightsteelblue" : "grey"; });
     
       nodeUpdate.select("text")
           .style("fill-opacity", 1);
     
       // Transition exiting nodes to the parent's new position.
       var nodeExit = node.exit().transition()
           .duration(duration)
           .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
           .remove();
     
       nodeExit.select("circle")
           .attr("r", 1e-6);
     
       nodeExit.select("text")
           .style("fill-opacity", 1e-6);
     
       // Update the links…
       var link = SaveSelectedsvg.selectAll("path.link")
           .data(tree.links(nodes), function(d) { return d.target.id; });
     
       // Enter any new links at the parent's previous position.
       link.enter().insert("path", "g")
           .attr("class", "link")
           .attr("d", function(d) {
             var o = {x: source.x0, y: source.y0};
             return diagonal({source: o, target: o});
           })
         .transition()
           .duration(duration)
           .attr("d", diagonal);
     
       // Transition links to their new position.
       link.transition()
           .duration(duration)
           .attr("d", diagonal);
     
       // Transition exiting nodes to the parent's new position.
       link.exit().transition()
           .duration(duration)
           .attr("d", function(d) {
             var o = {x: source.x, y: source.y};
             return diagonal({source: o, target: o});
           })
           .remove();
     
       // Stash the old positions for transition.
       nodes.forEach(function(d) {
         d.x0 = d.x;
         d.y0 = d.y;
       });
     }
     
//----------------------------------------------------------------------------------------------------
     // Toggle children.
     function toggle(d) {
       if (d.children) {
         d._children = d.children;
         d.children = null;
       } else {
         d.children = d._children;
         d._children = null;
       }
     }
//----------------------------------------------------------------------------------------------------
    function getSettingsString(d){
		console.log("change setting string: ",  d)
		var SettingsString = d.Settings;
		if(d.Tab === "ClinicalTable"){
		   if(d.Settings.ageAtDxMin){
		       SettingsString = "AgeDx [" + d.Settings.ageAtDxMin + ", " + d.Settings.ageAtDxMax + "] <br>"
		                  + "Survival [" + d.Settings.overallSurvivalMin + ", " + d.Settings.overallSurvivalMax + "]";
		    }
		}
		return SettingsString;
		
}
//----------------------------------------------------------------------------------------------------

function fetchHeader(url) {
    wch = 'Last-Modified'
    try {
        var req=new XMLHttpRequest();
        req.open("HEAD", url, false);
        req.send(null);
        if(req.status== 200){
            return req.getResponseHeader(wch);
        }
        else return false;
    } catch(er) {
        return er.message;
    }
}

//----------------------------------------------------------------------------------------------------
    function getSettingsString(d){
		console.log("change setting string: ",  d)
		var SettingsString = d.Settings;
		if(d.Tab === "ClinicalTable"){
		   if(d.Settings.ageAtDxMin){
		       SettingsString = "AgeDx [" + d.Settings.ageAtDxMin + ", " + d.Settings.ageAtDxMax + "] <br>"
		                  + "Survival [" + d.Settings.overallSurvivalMin + ", " + d.Settings.overallSurvivalMax + "]";
		    }
		}
		return SettingsString;
		
}
//----------------------------------------------------------------------------------------------------
    function loadPatientData(){

       console.log("==== SavedSelection  get all PatientIDs from ClinicalTable");
       cmd = "getCaisisPatientHistory"; //sendCurrentIDsToModule
       status = "request"
       callback = "SetupSavedSelectionTree"
          filename = "" // was 'BTC_clinicaldata_6-18-14.RData', now learned from manifest file
          msg = {cmd: cmd, callback: callback, status: "request", payload: filename};
        // console.log(JSON.stringify(msg))
       socket.send(JSON.stringify(msg));
       } // loadPatientDemoData

//----------------------------------------------------------------------------------------------------
     function SetupSavedSelectionTree(msg){			     

		console.log("===== Setup SavedSelection Tree")
         console.log(msg)

         var AllData = msg.payload
         var PtIDs = []; 
         for(var i=0;i<AllData.length; i++){
         	if(PtIDs.indexOf(AllData[i].PatientID) === -1)
         		PtIDs.push(AllData[i].PatientID)
         }
         console.log("All Patients: ", PtIDs)
         root = {   "name": "All Patients",
         			"PatientIDs" : PtIDs,
         			"Tab": "ClinicalTable",
         			"Settings": "None"
         		}
         
         root.x0 = height / 2;
         root.y0 = 0;
             	
         function toggleAll(d) {
           if (d.children) {
             d.children.forEach(toggleAll);
             toggle(d);
           }
         }
         
       InitialLoad = false;
       updateSavedSelection(root); 
       CurrentSelection = root;
       SelectionNames.push(root.name);
  
       console.log("root: ", root)
      
 //      testingAddSavedSelection()
       
     }     
  
//--------------------------------------------------------------------------------------------
 //    function HandleWindowResize(){
 //         Display.width($(window).width() * 0.95);
 //         Display.height($(window).height() * 0.80);
 //         if(!InitialLoad) {updateSavedSelection(root);}
 //    };
  
//----------------------------------------------------------------------------------------------------
     
       return{
     
        init: function(){
           onReadyFunctions.push(initializeSelectionUI);
           addJavascriptMessageHandler("SetupSavedSelectionTree", SetupSavedSelectionTree);
 		   addJavascriptMessageHandler("addSelectionToTree", addSavedSelection);
          socketConnectedFunctions.push(loadPatientData);
           }
        };
     
}); // SavedSelectionModule
 

//----------------------------------------------------------------------------------------------------
SavedSelection = SavedSelectionModule();
SavedSelection.init();

</script>
<body>

<style>
.node circle {
  cursor: pointer;
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.node text {
  font-size: 11px;
}

path.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}
</style>


  <div id="SavedSelectionDiv">
     <div id="SavedSelectionTreeDiv"></div>
  <div id="SelectionBanner">
    <div id="Acknowledgement">Created by Lisa McFerrin</div>
 <!--   <script language="Javascript">
		document.write("This page was last modified on: " + document.lastModified +"");
	</script>
--> <div id="DateUpdated"> Last modified: 
    <span id="ModuleDate"> </span>
    </div>
  </div>

  </div>
  
 

</body>
</html>

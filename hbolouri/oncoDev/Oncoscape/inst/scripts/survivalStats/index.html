<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://localhost/home/js/cytoscape-2.2.4.min.js"></script>

   <!-- script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.2.min.js"></script -->

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <script src="//cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>
   <script src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png"></script>
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>

<script>

var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];

//--------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   dispatchOptions[cmd] = func
}
//----------------------------------------------------------------------------------------------------
//addDispatchOption = function(cmd, func)
//{
//   dispatchOptions[cmd] = func
//}
//--------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//--------------------------------------------------------------------------------------------------
$(document).ready(function() {
    console.log("==== index.common document.ready #1");
    socket = new WebSocket("ws://" + window.location.host);
    setupSocket(socket);
    })
//--------------------------------------------------------------------------------------------------
</script>

</head>


<script>
//--------------------------------------------------------------------------------------------------
demoTissueSet = function()
{
   return ["0525.T.2", "0598.T.1", "0622.T.1", "0636.T.1", "0664.T.1", "0761.T.1", "135.1.T.1", 
           "249.T.1", "270X.T.1", "286X.T.1", "349.T.1", "392.1.T.1", "443.1.T.1", "450.T.1", 
           "480.T.1", "821.T.1", "891.T.1", "929.T.1", "958.T.1"];


} // demoTissueSet
//--------------------------------------------------------------------------------------------------
$(document).ready(function() {
    console.log("==== survivalStats code.js document.ready");
    if(typeof(window.tabsAppRunning) == "undefined") {
       socketConnectedFunctions.push(analyzeSelectedTissuesWithDemoData);
       }
    addJavascriptMessageHandler("tissueIDsForSurvivalStats", handleTissueIDsForSurvivalStats);
    });
//--------------------------------------------------------------------------------------------------
handleTissueIDsForSurvivalStats = function(msg)
{
   console.log("--- handleTissueIDsForSurvivalStats");
   console.log(msg.cmd)
   console.log(msg)
   sampleCount = msg.payload.tissueIDs.length;
   console.log("   sampleCount: " + sampleCount);
   tissueIDs = msg.payload.tissueIDs;

   analyzeSelectedTissues(tissueIDs);
   $("#tabs").tabs( "option", "active", 6); 

   
} // handleTissueIDsForSurivalStats
//--------------------------------------------------------------------------------------------------
analyzeSelectedTissuesWithDemoData = function()
{
   analyzeSelectedTissues(demoTissueSet());
}  
//--------------------------------------------------------------------------------------------------
analyzeSelectedTissues = function(tissueIDs)
{
    msg = {cmd:"predictDzSubtypes", status: "request", payload: tissueIDs};
    msg.json = JSON.stringify(msg);
    socket.send(msg.json);
    msg = {cmd:"calculateSurvivalCurves", status: "request", payload: tissueIDs};
    msg.json = JSON.stringify(msg);
    socket.send(msg.json);
    msg = {cmd:"drawSurvivalBoxPlot", status: "request", payload: tissueIDs};
    msg.json = JSON.stringify(msg);
    socket.send(msg.json);

} // analyzeSelectedTissues
//--------------------------------------------------------------------------------------------------
displaySamplesVsSubtypePvals = function(msg)
{
   console.log("=== displaySamplesVsSubtypePvals");
   $("#dzSubTypeDataTableDiv").html(msg.payload)

} // displaySamplesVsSubtypePvals
//--------------------------------------------------------------------------------------------------
displaySurvivalCurves = function(msg)
{
   console.log("about to add survival curve image to survivalCurve div");
   encodedImage = msg.payload;
   document.getElementById("survivalCurveImage").src = encodedImage;
}
//--------------------------------------------------------------------------------------------------
displaySurvivalBoxPlot = function(msg)
{
   console.log("about to add survival boxplot image to survivalBoxPlot div");
   encodedImage = msg.payload;
   document.getElementById("survivalBoxPlotImage").src = encodedImage;
}
//--------------------------------------------------------------------------------------------------
addJavascriptMessageHandler("samplesVsSubtypePvals", displaySamplesVsSubtypePvals);
addJavascriptMessageHandler("displaySurvivalCurves", displaySurvivalCurves);
addJavascriptMessageHandler("displaySurvivalBoxPlot", displaySurvivalBoxPlot);
//----------------------------------------------------------------------------------------------------
</script>


<style>
</style>

<div id="survivalStatsDiv">
  <div id="statisticsNotesDiv"></div>
  <div id="dzSubTypeDataTableDiv"></div>
  <div id="survivalCurveDiv">
      <img id="survivalCurveImage" width="500" height="500"></img>
      <img id="survivalBoxPlotImage" width="500" height="500"></img>
  </div>
 </div>


</body>
</html>

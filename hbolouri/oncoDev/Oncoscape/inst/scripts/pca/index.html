<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://s3.amazonaws.com/oncoscape/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape.js-qtip.js"></script>
   <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">

	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string) 
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
// from http://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
function openCenteredBrowserWindow(url, title, w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

    width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);

    if (window.focus) {
       newWindow.focus();
       }

} // openCenteredBrowserWindow
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
// the nginx proxy server, used by fhcrc IT for the publicly-visible version of Oncoscape
// times out web sockets at 90 seconds.
// this function, when called more often that that, will keep the websocket open.
keepAlive = function()
{   
    console.log("keep alive"); 
    msg = {cmd: "keepAlive", callback: "", status:"request", payload:""}
    socket.send(JSON.stringify(msg));

} // keepAlive
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined") {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
        setInterval(keepAlive, 30000);
        }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------


</script>

<script>
//----------------------------------------------------------------------------------------------------
var UserSettingsModule = (function () {

     var username = "Guest"
     var userID = null
     var SelectionNames = [];
     
//----------------------------------------------------------------------------------------------------
//======= PUBLIC FUNCTIONS ==========
//----------------------------------------------------------------------------------------------------
      getUserID = function(){
           console.log("Sending User ID: ", userID)
           return userID;
      }      
//----------------------------------------------------------------------------------------------------
      getUsername = function(){
           console.log("Sending Username: ", username)
           return username;
      }      

//----------------------------------------------------------------------------------------------------
      setUsername = function(msg){
           console.log("Set username: ", msg.payload.username)
           username = msg.payload.username
      }      

    //--------------------------------------------------------------------------------------------
     addSelection = function(NewSelection){
  
           //Check NewSelection values for completeness/accuracy
           // should have selectionnames, patientIDs, Tab, and Settings
           
           NewSelection.userID = getUserID() 
     
           msg = {cmd: "addNewUserSelection",
                  callback: "UpdateSelectionListeners",
                  status:"request",
                  payload: NewSelection 
                 };
 
           msg.json = JSON.stringify(msg);
//           console.log(msg.json);
           socket.send(msg.json);
     }
    //--------------------------------------------------------------------------------------------
     getSelectionbyName = function(selectionname, callback){
               
			if(SelectionNames.indexOf(selectionname) == -1){
   			     alert("Error: ",selectionname, " not in list")
                  return;
			} else{
  
                msg = {cmd:"getUserSelection",
                  callback: callback,
                  status:"request",
                  payload:{userID: getUserID(),
                           selectionname: selectionname}
                  };
     
                 console.log(JSON.stringify(msg));
                  socket.send(JSON.stringify(msg));
          }     
    }

   //--------------------------------------------------------------------------------------------
     getSelectionNames = function(){

            return SelectionNames;
     }

//----------------------------------------------------------------------------------------------------
//======= PRIVATE FUNCTIONS ==========
//----------------------------------------------------------------------------------------------------
      function CreateNewUser(){
      
         console.log("======= creating new guest user")
  
            userID = Math.random().toString(36).substring(7)
            console.log(userID);
      }
//----------------------------------------------------------------------------------------------------
     function UserSettingsInitializeUI(){

           CreateNewUser();
       };

//----------------------------------------------------------------------------------------------------
     function addNewUser(){
              
            msg = {cmd:"addNewUserToList",
                 callback: "UpdateUserInfo",
                 status:"request",
                 payload: { userID: userID, username: username}
                };
                console.log(JSON.stringify(msg))
          socket.send(JSON.stringify(msg));
     }
 
         

//----------------------------------------------------------------------------------------------------
    function UpdateSelectionListeners(msg){
    
        console.log("===== Updating JS Selection Lists")
        console.log(msg)
         
         if(msg.status === "success"){
           SelectionNames.push(msg.payload.selectionname)  
           
           if(typeof(SavedSelection) != "undefined")  SavedSelection.addSelectionToTable(msg);
           if(typeof(PatientTimeLine) != "undefined") PatientTimeLine.RefreshSelectionMenu()
           if(typeof(ctbl) != "undefined") ctbl.UpdateSelectionMenu()
         }
     }
  
 
     
//----------------------------------------------------------------------------------------------------
return{

   init: function(){
      onReadyFunctions.push(UserSettingsInitializeUI);
      socketConnectedFunctions.push(addNewUser);
     addJavascriptMessageHandler("UpdateSelectionListeners", UpdateSelectionListeners);
     addJavascriptMessageHandler("UpdateUserInfo", setUsername);

      }
   };

}); // DateAndTimeModule
//----------------------------------------------------------------------------------------------------
UserSettings = UserSettingsModule();
UserSettings.init();

</script>
<script>
var ActiveModules = [];

//----------------------------------------------------------------------------------------------------
addSelectionDestination = function(module)
{
   if(module in ActiveModules){
        alert("Selection Destination message handler for '" +  module + " already set");
   } else{  ActiveModules.push(module)  }
}

//----------------------------------------------------------------------------------------------------
getSelectionDestinations = function(){
     return ActiveModules;
//   return tissueMenu.children().map(function() {return $(this).val();}).get();
}

//--------------------------------------------------------------------------------------------
function sendSelectionToModule(moduleName, currentIDs, metadata){
    
      callback = moduleName + "HandlePatientIDs";    // genralize to "HandleSelectedIDs"?
      msg = {cmd:"sendIDsToModule",                  // generalize to "sendIDsToModule"?
             callback: callback,
             status:"request",
             payload:{targetModule: ModuleName,
                      ids: currentIDs,
                      metadata: metadata}
             };
      socket.send(JSON.stringify(msg));
    }

</script>

 
<script>
//----------------------------------------------------------------------------------------------------
var PCAModule = (function () {

  var broadcastButton;
  var pcaDisplay;
  var pcaScores;
  var patientClassification;
  var firstTime = true;
  var pcaSelectedRegion;    // from brushing
  var d3PlotBrush;
  var pcaTabNumber = 2;
  var d3pcaDisplay;
  var pcaTextDisplay;
  var PCAsendSelectionMenu;
  var ThisModuleName = "PCA"
  
  //--------------------------------------------------------------------------------------------
  function initializeUI () {
      pcaDisplay = $("#pcaDisplay");
      d3pcaDisplay = d3.select("#pcaDisplay");
      pcaHandleWindowResize();
      $(window).resize(pcaHandleWindowResize);
 
        PCAsendSelectionMenu = $("#PCAsendSelectiontoModuleButton")
        PCAsendSelectionMenu.change(sendToModuleChanged);
        PCAsendSelectionMenu.empty();
        
        PCAsendSelectionMenu.append("<option>Send Selection to:</option>")
        var ModuleNames = getSelectionDestinations()
        for(var i=0;i< ModuleNames.length; i++){
           var SendToModule = ModuleNames[i]
           if(SendToModule !== ThisModuleName){
              optionMarkup = "<option>" + SendToModule + "</option>";
              PCAsendSelectionMenu.append(optionMarkup);
           }
        }  
        PCAsendSelectionMenu.prop("disabled",true);


      broadcastButton = $("#pcaBroadcastSelectionToClinicalTable");
      broadcastButton.click(pcaBroadcastSelection);
      broadcastButton.prop("disabled",true);
      pcaTextDisplay = $("#pcaTextDisplayDiv");
      };

  //--------------------------------------------------------------------------------------------
  function runDemo (){
     payload = "";
     msg = {cmd: "calculate_mRNA_PCA", callback: "pcaPlot", status: "request", 
            payload: payload};
     socket.send(JSON.stringify(msg));
     };

  //--------------------------------------------------------------------------------------------
  function getPatientClassification (){
     payload = "";
     msg = {cmd: "getPatientClassification", callback: "handlePatientClassification", 
            status: "request", payload: payload};
     socket.send(JSON.stringify(msg));
     };

  //--------------------------------------------------------------------------------------------
  function handlePatientClassification (msg){
     console.log("=== handlePatientClassification");
     if(msg.status == "success"){
        patientClassification = JSON.parse(msg.payload)
        console.log("got classification, length " + patientClassification.length);
        console.log(patientClassification.payload);
        drawLegend();
        }
     else{
       alert("error!" + msg.payload)
       }
      }; // handlePatientIDs
 //-------------------------------------------------------------------------------------------- 
  function drawLegend () {

   console.log("==== draw legend: ") 

   for(var i=0; i<patientClassification.length; i++){
      if(patientClassification[i].gbmDzSubType[0] == null | patientClassification[i].gbmDzSubType[0] == ""){ 
          patientClassification[i].gbmDzSubType[0]= "undefined" } }

        Classifications = d3.nest()
              .key(function(d) { return d.gbmDzSubType[0]; })
              .map(patientClassification, d3.map);

   var Legendsvg = d3.select("#pcaLegend").append("svg").attr("id", "pcaLegendSVG")
                      .attr("width", $("#pcaDisplay").width())

    var LegendLabels = d3.values(Classifications.keys())
         
    var legend =    Legendsvg
                   .append("g")
                   .attr("class", "legend")
                   .attr("transform", "translate(" + 10 + "," + 10 + ")")  
                   .selectAll(".legend")
                     .data(LegendLabels)
                     .enter().append("g")
                ;

    var text = legend.append("text")
            .attr("y", 10)
            .attr("x", 0)
            .style("font-size", 12)
            .text(function(d) { return d})
           ;

    var TextOffset = []
    var xPosition = 0

   text.attr("transform", function(d, i){
        TextOffset.push(xPosition)
        console.log(i, xPosition)
        console.log(this)
        console.log(this.getBBox())
        console.log(d)
        xPosition = xPosition + this.getBBox().width +20
     return "translate(" + (TextOffset[i]+10) +",0)"
   })
  
  
 console.log("BBox node: ", text.node().getBBox())  
// console.log("BBox node: ", text.node().getBBox())  
 
     legend.append("circle")
            .attr("cx", 0)
            .attr("cy", 5)
            .attr("r", function(d) { return 6;})
            .style("fill", function(d) { return Classifications.get(d)[0].color[0]})
            .attr("transform", function(d, i){
               return "translate(" + (TextOffset[i]) +",0)"
             })
  }
  
  //--------------------------------------------------------------------------------------------
  function highlightPoints(data){
     console.log("DATA === ");
     console.log(data);
     selectPoints(data, true);
  };
  
  //--------------------------------------------------------------------------------------------
  function selectPoints(selectIds, clearExistingSelectionFirst){
      if(clearExistingSelectionFirst){
          clearSelection();
      }
      var ids = selectIds.ids;
//      for(i=0;i<selectIds.ids.length;i++){
//          ids.push(listOfPoints[i].ID);
//      }

    console.log("selectIds: ");
    console.log(selectIds.ids);
      d3.selectAll("circle")
          .filter(function(d, i) { return ids.indexOf(d.id) > -1;})
          .classed("highlighted", true)
          .transition()
          .attr("r", 5)
          .duration(500);
      };
  
  //--------------------------------------------------------------------------------------------
  function clearSelection(){
      d3.selectAll("circle")
          .classed("highlighted", false)
          .attr("r", 3);
      };
  
  //--------------------------------------------------------------------------------------------
  function pcaHandleWindowResize () {
     pcaDisplay.width($(window).width() * 0.95);
     pcaDisplay.height($(window).height() * 0.80);
     if(!firstTime) {d3PcaScatterPlot(pcaScores);}
     };

    //----------------------------------------------------------------------------------------------------
     function sendToModuleChanged() {

       ModuleName = PCAsendSelectionMenu.val()
       pcaBroadcastSelection ()
       PCAsendSelectionMenu.val("Send Selection to:")
    } // sendToModuleChanged


   //--------------------------------------------------------------------------------------------
  function pcaBroadcastSelection (){
      console.log("pcaBroadcastSelection: " + pcaSelectedRegion);
      x1=pcaSelectedRegion[0][0];
      y1=pcaSelectedRegion[0][1];
      x2=pcaSelectedRegion[1][0];
      y2=pcaSelectedRegion[1][1];
      ids = [];
      for(var i=0; i < pcaScores.length; i++){
         p = pcaScores[i];
         if(p.PC1 >= x1 & p.PC1 <= x2 & p.PC2 >= y1 & p.PC2 <= y2)
            ids.push(p.id[0]);
         } // for i
      if(ids.length > 0)
//         sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
          sendSelectionToModule(ModuleName, ids);
      };

  //--------------------------------------------------------------------------------------------
//  function sendIDsToModule (ids, moduleName, title){
//       callback = moduleName + title;
//       msg = {cmd:"sendIDsToModule",
//              callback: callback,
//              status:"request",
//              payload:{targetModule: moduleName,
//                       ids: ids}
//             };
//      socket.send(JSON.stringify(msg));
//      } // sendTissueIDsToModule


  //--------------------------------------------------------------------------------------------
  function pcaPlot (msg){
      console.log("==== pcaPlot");
      //console.log(msg);
      if(msg.status == "success"){
         pcaScores = JSON.parse(msg.payload.tbl);
         d3PcaScatterPlot(pcaScores);
         console.log(msg.payload.importance)
//         pcaData = JSON.parse(msg.payload.importance);
//         pcaDataTable(pcaData);
         
         if(!firstTime)  // first call comes at startup.  do not want to raise tab then.
             $("#tabs").tabs( "option", "active", pcaTabNumber);
         } // success
    else{
      console.log("pcaPlot about to call alert: " + msg)
      alert(msg.payload)
      }
     firstTime = false;
     };

  //--------------------------------------------------------------------------------------------
  function handlePatientIDs(msg){
      console.log("Module.pca: handlePatientIDs");
      console.log(msg)
      if(msg.status == "success"){
         patientIDs = msg.payload.ids
         //console.log("pca handlePatientIds: " + patientIDs);
         payload = patientIDs;
         console.log(payload);
         if(payload.Higlight == "Highlight"){
            console.log("HIGHLIGHTED!!!!!!");
            highlightPoints(payload);
        }else{
            console.log("NOT HIGHLIGHTED!!!!!!");
            msg = {cmd: "calculate_mRNA_PCA", callback: "pcaPlot", status: "request",
                payload: payload};
            socket.send(JSON.stringify(msg));
            }
        }
    else{
      console.log("handlePatientIDs about to call alert: " + msg)
      alert(msg.payload)
      }
     }; // handlePatientIDs

  //--------------------------------------------------------------------------------------------
  function d3PlotBrushReader () {
     console.log("plotBrushReader 1037a 22jul2014");
     pcaSelectedRegion = d3PlotBrush.extent();
     //console.log("region: " + pcaSelectedRegion);
     x0 = pcaSelectedRegion[0][0];
     x1 = pcaSelectedRegion[1][0];
     width = Math.abs(x0-x1);
     //console.log("width: " + width);
     if(width > 1){
       PCAsendSelectionMenu.prop("disabled",false);

        broadcastButton.prop("disabled", false);
        console.log("width > 1, new button state, disabled?: " + broadcastButton.prop("disabled"));
        }
     else{
       PCAsendSelectionMenu.prop("disabled",true);

        broadcastButton.prop("disabled", true);
        console.log("width !> 1, new button state, disabled?: " + broadcastButton.prop("disabled"));
        }
     }; // d3PlotBrushReader

  //-------------------------------------------------------------------------------------------
  function chooseColor (d){
     id = d.id[0];
     for(var i=0; i<patientClassification.length; i++){
        if (id == patientClassification[i].rowname[0]){
          result = patientClassification[i].color[0]
          return(result)
          } // if match
        } // for i
     //console.log("chooseColor, no match for id " + id);
     return("black");
     }
  //-------------------------------------------------------------------------------------------
   function pcaDataTable(pcaData){
        var pcaText = d3.select("#pcaTextDisplay")
        console.log(pcaData)
        var tblColumnNames = ["A", "B", "C"];
        columnTitles = [];
        for(var i=0; i < tblColumnNames.length; i++){
          columnTitles.push({sTitle: tblColumnNames[i]});
        }

     displayDiv.html('<table cellpadding="0" cellspacing="0" margin-left="10" border="1" class="display" id="pcaTable"></table>');
     $("#pcaTable").dataTable({
        "sDom": "Rlfrtip",
         sDom: 'C<"clear">lfrtip',
        "aoColumns": columnTitles,
	    "sScrollX": "100px",
        "iDisplayLength": 25,
         bPaginate: true,
        "scrollX": true,
        "fnInitComplete": function(){
            $(".display_results").show();
            }
         }); // dataTable

     console.log("displayTable adding data to table");
     tableRef = $("#pcaTable").dataTable();
//     tableRef.fnAddData(pcaData);

        
   }
 //-------------------------------------------------------------------------------------------
  function d3PcaScatterPlot(dataset) {
     console.log("DATASET = ");
     console.log(dataset);
     broadcastButton.prop("disabled",true);
     var padding = 50;
     var width = $("#pcaDisplay").width();
     var height = $("#pcaDisplay").height();

     var xMax = d3.max(dataset, function(d) { return +d.PC1;} );
     var xMin = d3.min(dataset, function(d) { return +d.PC1;} );
     var yMax = d3.max(dataset, function(d) { return +d.PC2;} );
     var yMin = d3.min(dataset, function(d) { return +d.PC2;} );
 
       // todo:  after finding min and max, determine largest of each axis in abs value
       // todo:  then find next larger even number, use that throughout
     
     xMax = xMax * 1.1
     xMin = xMin * 1.1
     yMax = yMax * 1.1
     yMin = yMin * 1.1

     //console.log("xMax: " + xMax);   console.log("xMin: " + xMin);
     //console.log("yMax: " + yMax);   console.log("yMin: " + yMin);

     d3pcaDisplay.select("#pcaSVG").remove();  // so that append("svg") is not cumulative
 
     var xScale = d3.scale.linear()
                    .domain([xMin,xMax])
                    .range([padding, width - padding]);

     var yScale = d3.scale.linear()
                    .domain([yMin, yMax])
                    .range([height - padding, padding]); // note inversion 

     var xTranslationForYAxis = xScale(0);
     var yTranslationForXAxis = yScale(0);

     var xAxis = d3.svg.axis()
                   .scale(xScale)
                   .orient("top")
                   .ticks(5);

     var yAxis = d3.svg.axis()
                   .scale(yScale)
                   .orient("left")
                   .ticks(5);

     var tooltip = d3.select("body")
                     .attr("class", "tooltip")
                     .append("div")
                     .style("position", "absolute")
                     .style("z-index", "10")
                     .style("visibility", "hidden")
                     .text("a simple tooltip");

     d3PlotBrush = d3.svg.brush()
        .x(xScale)
        .y(yScale)
        .on("brushend", d3PlotBrushReader);

     var svg = d3pcaDisplay.append("svg")
                 .attr("id", "pcaSVG")
                 .attr("width", width)
                 .attr("height", height)
                 .call(d3PlotBrush);

     svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0, " + yTranslationForXAxis + ")")
        .call(xAxis)
        .append("text")
        .style("font-size", 14)
        .text("PC1");

     svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + xTranslationForYAxis + ", 0)")
        .call(yAxis)
        .append("text")
//            .attr("transform", "rotate(-90)")
              .attr("y", 10)
              .attr("dy", ".71em")
             .style("font-size", 14)
            .style("text-anchor", "end") //start, middle
            .text("PC2");
            
    
     var circle = svg.append("g").selectAll("circle")
                     .data(dataset)
                     .enter()
                     .append("circle")
                     .attr("cx", function(d,i) {return xScale(d.PC1);})
                     .attr("cy", function(d,i) {return yScale(d.PC2);})
                     .attr("r", function(d) { return 3;})
                     .style("fill", function(d) {return(chooseColor(d))})
                     //.style("fill", function(d) { return "blue"})
                     .on("mouseover", function(d,i){
                         tooltip.text(d.id);
                         return tooltip.style("visibility", "visible");
                         })
                    .on("mousemove", function(){return tooltip.style("top",
                           (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
      
 
     } // d3PcaScatterPlot
      
//--------------------------------------------------------------------------------------------
  return{
   init: function(){
      onReadyFunctions.push(initializeUI);
      addSelectionDestination("PCA")   
      addJavascriptMessageHandler("pcaPlot", pcaPlot);
      addJavascriptMessageHandler("PCAHandlePatientIDs", handlePatientIDs);
      addJavascriptMessageHandler("handlePatientClassification", handlePatientClassification)
      socketConnectedFunctions.push(getPatientClassification);
      socketConnectedFunctions.push(runDemo);
      }
   };

}); // PCAModule
//----------------------------------------------------------------------------------------------------
pca = PCAModule();
pca.init();

</script>
<body>
<style>

.domain { 
  fill: none; 
  } 


.extent {
  fill-opacity: .1;
  stroke: #f00;
}


.axis path, .axis line {
    stroke: black;
    stroke-width: 1px;
    }

circle.highlighted {
   fill: orange;
   opacity: 1;
   }

#pcaDiv {
   margin: 0px;
   padding: 0px;
   }

#pcaDisplay {
   border: 1px solid #aaa;
   width: 50px;
   height: 50px;
   background-color: #FAFAFA;
   margin-top: 1px;
   margin-left: 3px;
   margin-right: 0;
   margin-bottom: 1px;
   padding: 1px;
   padding-bottom: 0px;
   }

#pcaBroadcastSelectionToClinicalTable{
   font-size: 10pt;
   }

#pcaHighlight{
   font-size: 10pt;
   }

</style>

<div id="pcaDiv">
<!--   <button id="pcaBroadcastSelectionToClinicalTable">To Clinical Data... </button>
-->   <select id="PCAsendSelectiontoModuleButton" name="SendSelectionToModule">Send Selection to...</select>
   <div id="pcaDisplay"></div>
   <div id="pcaLegend"></div>
   <div id="pcaTextDisplayDiv"></div>
   
</div>

</body>
</html>

<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">

	<script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111018/d3/d3.layout.js"></script>
	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined")
    {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
    }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------
</script>

<script>
onReadyFunctions.push(function() {
    console.log("====== tabapps document ready");
    window.tabsAppRunning = true
    $("#tabs").tabs({
         // todo: distinguish between tabs, only do needed resets
       activate: function(event, ui) {
            console.log("tabs.activate");
            console.log(" ==== tab.activate, tableRef.fnAdjustColumnSizing");
            var tableRef = $("#clinicalTable").dataTable();
            if (tableRef.length > 0) {
               tableRef.fnAdjustColumnSizing();
              } // if
            console.log(" ==== tab.activate, possible cyjs resize and fit");
            if(typeof(cwMarkers) != "undefined") {
               cwMarkers.resize(); 
               cwMarkers.fit(50);
               }
            if(typeof(cwGBM) != "undefined") {
                cwGBM.resize();
                cwGBM.fit(50);
                }
            if(typeof(cwAngio) != "undefined") {
                cwAngio.resize();
                cwAngio.fit(50);
                }
            } // activate
        }); // tabs
    });  // ready

</script>


<body>
<style>
.ui-tabs .ui-tabs-nav li a {font-size:10pt !important;}
</style>

<script>
</script>

<script>
//----------------------------------------------------------------------------------------------------
var DashboardModule = (function () {

     function DashboardInitializeUI(){

      };

     
return{

   init: function(){
      onReadyFunctions.push(DashboardInitializeUI);
//      addJavascriptMessageHandler("String", displayTime);
      }
   };

}); // DateAndTimeModule
//----------------------------------------------------------------------------------------------------
Dashboard = DashboardModule();
Dashboard.init();

</script>
<script>
//----------------------------------------------------------------------------------------------------
var ClinicalTableModule = (function () {

var currentIDs;   // assign this to the full content in the tbl on startup
var tableRef;
var pcaButton;
var timeLinesButton;
var displayDiv;
var ClinicalTableTabNum=1;

   //--------------------------------------------------------------------------------------------
   function initializeUI(){
      pcaButton = $("#toPCAButton");
      pcaButton.click(function(){sendCurrentIDsToModule("PCA")});
      timeLinesButton = $("#toTimeLinesButton")
      timeLinesButton.click(function(){sendCurrentIDsToModule("timeLines")});
      displayDiv = $("#clinicalDataTableDiv");
      $(window).resize(handleWindowResize);
      handleWindowResize();
      $("#ageAtDxMinSlider").slider({
         change: function(event, ui) {$("#ageAtDxMinSliderReadout").text (ui.value)},
         min: 10,
         max: 89,
         value: 10
         });
    $("#ageAtDxMinSliderReadout").text(10);

    $("#ageAtDxMaxSlider").slider({
       change: function(event, ui) {$("#ageAtDxMaxSliderReadout").text (ui.value)},
       min: 10,
       max: 89,
       value: 89
       });
    $("#ageAtDxMaxSliderReadout").text(89);

    $("#overallSurvivalMinSlider").slider({
       change: function(event, ui) {$("#overallSurvivalMinSliderReadout").text (ui.value)},
       min: 0,
       max: 11,
       value: 0
       });
    $("#overallSurvivalMinSliderReadout").text(0);

    $("#overallSurvivalMaxSlider").slider({
       change: function(event, ui) {$("#overallSurvivalMaxSliderReadout").text (ui.value)},
       min: 0,
       max: 11,
       value: 11
       });
    $("#overallSurvivalMaxSliderReadout").text(11);
    //$("#applyClinicalTablesFiltersSlidersButton").button();
    //$("#showAllClinicalTablesRowsButton").button()
    $("#showAllClinicalTablesRowsButton").click(showAllRows)
    $("#applyClinicalTablesFiltersSlidersButton").click(readAndApplyClinicalTableFilters);
    $("#toMarkersAndTissuesButton").prop("disabled",true);
    $("#toGBMPathwaysButton").prop("disabled",true);
    $("#toSurvivalStatsButton").prop("disabled",true);
    $("#toTimeLinesButton").prop("disabled",false);
    };

   //--------------------------------------------------------------------------------------------
   function sendCurrentIDsToModule (moduleName) {
      console.log("entering sendCurrentIDsToModule");
      var rows = tableRef._('tr', {"filter":"applied"});   // cryptic, no?
      var currentIDs = []
      for(var i=0; i < rows.length; i++) 
          currentIDs.push(rows[i][0]);
      console.log(currentIDs.length + " patientIDs going to " + moduleName)
      callback = moduleName + "HandlePatientIDs";
      msg = {cmd:"sendPatientIDsToModule",
             callback: callback,
             status:"request",
             payload:{targetModule: moduleName,
                      ids: currentIDs}
             };
      msg.json = JSON.stringify(msg);
      //console.log(msg.json);
      socket.send(msg.json);
      
      msg = {cmd:"sendPatientIDsToSelectionTree",
              callback: "addSelectionToTree",
              status:"request",
              payload:{  name: "table_filter",
         			PatientIDs : currentIDs,
         			Tab: "ClinicalTable",
         			Settings: {ageAtDxMin: $("#ageAtDxMinSliderReadout").val(),
                      ageAtDxMax: $("#ageAtDxMaxSliderReadout").val(),
                      overallSurvivalMin: $("#overallSurvivalMinSliderReadout").val(),
                      overallSurvivalMax: $("#overallSurvivalMaxSliderReadout").val()}
         		}
             };
      msg.json = JSON.stringify(msg);
           console.log(msg.json);
      socket.send(msg.json);
      } // sendTissueIDsToModule

//----------------------------------------------------------------------------------------------------
   function showAllRows() {
      tableRef.fnFilter("", 0);
      }

   //--------------------------------------------------------------------------------------------
   function readAndApplyClinicalTableFilters() {
      console.log("readAndApplyClinicalTableFilters")
      var ageAtDxMin = $("#ageAtDxMinSliderReadout").val()
      var ageAtDxMax = $("#ageAtDxMaxSliderReadout").val()
      var overallSurvivalMin = $("#overallSurvivalMinSliderReadout").val()
      var overallSurvivalMax = $("#overallSurvivalMaxSliderReadout").val()

      msg = {cmd:"filterPatientHistory", 
             callback: "handleFilterPatientHistory",
             status:"request",
             payload:{ageAtDxMin: ageAtDxMin,
                      ageAtDxMax: ageAtDxMax,
                      overallSurvivalMin: overallSurvivalMin,
                      overallSurvivalMax: overallSurvivalMax}};
      msg.json = JSON.stringify(msg);
      console.log(msg.json);
      socket.send(msg.json);
      } // readAndApplyClinicalTableFilters 


   //--------------------------------------------------------------------------------------------
   function handleFilterPatientHistory(msg) {
      console.log("=== handleFilterPatientHistory");
      console.log(msg);
      if(msg.status != "success"){
         alert("handleFilterClinicalDataTable error: " + msg.payload);
         return;
         }

      var count = msg.payload.count;
      var ids = msg.payload.ids;
      console.log("--- filtered ids returned by Oncoscape: " + ids);

        // having trouble getting visible tissueIDs from DataTable for now
        // an imperfect workaround:  save them to a global variable
        // TODO:  this does not work with direct in-browser filtering of the table

       // if tissueIDs is a single string, then 'length' returns the number
       // of characters in the string, not the number of elements in the array
       // protect against this.

     if(count == 1){
        currentIDs = [ids]
        filterString = ids
        }
     else{
        currentIDs =  ids
        filterString = ids[0];
        for(var i=1; i < ids.length; i++){
           filterString += "|" + ids[i]
           }
        } // if more than one id

      console.log("---- clinicalDataTable2.handleFilterClinicalDataTable");
      console.log(filterString)
      console.log("about to call fnFilter");
      tableRef.fnFilter(filterString, 0, true);
      $("#tabs").tabs( "option", "active", ClinicalTableTabNum);
      } // handleFilterClinicalDataTable 


   //--------------------------------------------------------------------------------------------
  function handleWindowResize(){
      displayDiv.width($(window).width() * 0.95);
      displayDiv.height($(window).height() * 0.95);
     }; // handleWindowResize

   //--------------------------------------------------------------------------------------------
  function requestData (){
     console.log("cdt requests data");
     payload = ""; // demo/clinicalTable320.RData";
     msg = {cmd: "getTabularPatientHistory", callback: "handlePatientHistory", status: "request", 
            payload: payload};
     msg.json = JSON.stringify(msg);
     socket.send(msg.json);
     };

   //--------------------------------------------------------------------------------------------
  function displayTable(msg){
     console.log("entering ctbl displayTable");
     tblColumnNames = msg.payload.colnames;
     columnTitles = [];
     for(var i=0; i < tblColumnNames.length; i++){
        columnTitles.push({sTitle: tblColumnNames[i]});
        }
     
     console.log(columnTitles);

     displayDiv.html('<table cellpadding="0" cellspacing="0" margin-left="10" border="1" class="display" id="clinicalTable"></table>');
     $("#clinicalTable").dataTable({
        "sDom": "Rlfrtip",
         sDom: 'C<"clear">lfrtip',
        "aoColumns": columnTitles,
	"sScrollX": "100px",
        "iDisplayLength": 25,
         bPaginate: true,
        "scrollX": true,
        "fnInitComplete": function(){
            $(".display_results").show();
            }
         }); // dataTable

     console.log("displayTable adding data to table");
     tableRef = $("#clinicalTable").dataTable();
     tableRef.fnAddData(msg.payload.mtx);
     }; // displayTable


  return{
    requestData: requestData,
    init: function(){
      onReadyFunctions.push(initializeUI);
      addJavascriptMessageHandler("handlePatientHistory", displayTable);
      addJavascriptMessageHandler("handleFilterPatientHistory", handleFilterPatientHistory);
      addJavascriptMessageHandler("PatientHistoryHandlePatientIDs", handleFilterPatientHistory);
      socketConnectedFunctions.push(requestData);
      }
    }; // returned object

  }); // DateAndTimeModule

//----------------------------------------------------------------------------------------------------
ctbl = ClinicalTableModule();
ctbl.init();

</script>
<script>
//----------------------------------------------------------------------------------------------------
var PCAModule = (function () {

  var broadcastButton;
  var pcaDisplay;
  var pcaResults;
  var patientClassification;
  var firstTime = true;
  var pcaSelectedRegion;    // from brushing
  var d3PlotBrush;
  var pcaTabNumber = 2;
  var d3pcaDisplay;
  
  //--------------------------------------------------------------------------------------------
  function initializeUI () {
      pcaDisplay = $("#pcaDisplay");
      d3pcaDisplay = d3.select("#pcaDisplay");
      pcaHandleWindowResize();
      broadcastButton = $("#pcaBroadcastSelectionToClinicalTable");
      //broadcastButton.button();
      broadcastButton.click(pcaBroadcastSelection);
      $(window).resize(pcaHandleWindowResize);
      broadcastButton.prop("disabled",true);
      };

  //--------------------------------------------------------------------------------------------
  function runDemo (){
     payload = "";
     msg = {cmd: "calculate_mRNA_PCA", callback: "pcaPlot", status: "request", 
            payload: payload};
     socket.send(JSON.stringify(msg));
     };

  //--------------------------------------------------------------------------------------------
  function getPatientClassification (){
     payload = "";
     msg = {cmd: "getPatientClassification", callback: "handlePatientClassification", 
            status: "request", payload: payload};
     socket.send(JSON.stringify(msg));
     };

  //--------------------------------------------------------------------------------------------
  function handlePatientClassification (msg){
     console.log("=== handlePatientClassification");
     //console.log(msg)
     if(msg.status == "success"){
        patientClassification = JSON.parse(msg.payload)
        console.log("got classification, length " + patientClassification.length);
        }
     else{
       alert("error!" + msg.payload)
       }
      }; // handlePatientIDs

  //--------------------------------------------------------------------------------------------
  function pcaHandleWindowResize () {
     pcaDisplay.width($(window).width() * 0.95);
     pcaDisplay.height($(window).height() * 0.80);
     if(!firstTime) {d3PcaScatterPlot(pcaResults);}
     };

   //--------------------------------------------------------------------------------------------
  function pcaBroadcastSelection (){
      console.log("pcaBroadcastSelection: " + pcaSelectedRegion);
      x1=pcaSelectedRegion[0][0];
      y1=pcaSelectedRegion[0][1];
      x2=pcaSelectedRegion[1][0];
      y2=pcaSelectedRegion[1][1];
      ids = [];
      for(var i=0; i < pcaResults.length; i++){
         p = pcaResults[i];
         if(p.PC1 >= x1 & p.PC1 <= x2 & p.PC2 >= y1 & p.PC2 <= y2)
            ids.push(p.id[0]);
         } // for i
      if(ids.length > 0)
         sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
      };

  //--------------------------------------------------------------------------------------------
  function sendIDsToModule (ids, moduleName, title){
       callback = moduleName + title;
       msg = {cmd:"sendIDsToModule",
              callback: callback,
              status:"request",
              payload:{targetModule: moduleName,
                       ids: ids}
             };
      socket.send(JSON.stringify(msg));
      } // sendTissueIDsToModule


  //--------------------------------------------------------------------------------------------
  function pcaPlot (msg){
      console.log("==== pcaPlot");
      //console.log(msg);
      if(msg.status == "success"){
         pcaResults = JSON.parse(msg.payload);
         d3PcaScatterPlot(pcaResults);
         if(!firstTime)  // first call comes at startup.  do not want to raise tab then.
             $("#tabs").tabs( "option", "active", pcaTabNumber);
         } // success
    else{
      console.log("pcaPlot about to call alert: " + msg)
      alert(msg.payload)
      }
     firstTime = false;
     };

  //--------------------------------------------------------------------------------------------
  function handlePatientIDs(msg){
      console.log("Module.pca: handlePatientIDs");
      //console.log(msg)
      if(msg.status == "success"){
         patientIDs = msg.payload
         //console.log("pca handlePatientIds: " + patientIDs);
         payload = patientIDs
         msg = {cmd: "calculate_mRNA_PCA", callback: "pcaPlot", status: "request", 
                payload: payload};
         socket.send(JSON.stringify(msg));
         }
    else{
      console.log("handlePatientIDs about to call alert: " + msg)
      alert(msg.payload)
      }
     }; // handlePatientIDs

  //--------------------------------------------------------------------------------------------
  function d3PlotBrushReader () {
     console.log("plotBrushReader 1037a 22jul2014");
     pcaSelectedRegion = d3PlotBrush.extent();
     //console.log("region: " + pcaSelectedRegion);
     x0 = pcaSelectedRegion[0][0];
     x1 = pcaSelectedRegion[1][0];
     width = Math.abs(x0-x1);
     //console.log("width: " + width);
     if(width > 1){
        broadcastButton.prop("disabled", false);
        console.log("width > 1, new button state, disabled?: " + broadcastButton.prop("disabled"));
        }
     else{
        broadcastButton.prop("disabled", true);
        console.log("width !> 1, new button state, disabled?: " + broadcastButton.prop("disabled"));
        }
     }; // d3PlotBrushReader

  //-------------------------------------------------------------------------------------------
  function chooseColor (d){
     id = d.id[0];
     for(var i=0; i<patientClassification.length; i++){
        if (id == patientClassification[i].rowname[0]){
          result = patientClassification[i].color[0]
          return(result)
          } // if match
        } // for i
     //console.log("chooseColor, no match for id " + id);
     return("black");
     }
  //-------------------------------------------------------------------------------------------
  function d3PcaScatterPlot(dataset) {

     broadcastButton.prop("disabled",true);
     var padding = 50;
     var width = $("#pcaDisplay").width();
     var height = $("#pcaDisplay").height();

     var xMax = d3.max(dataset, function(d) { return +d.PC1;} );
     var xMin = d3.min(dataset, function(d) { return +d.PC1;} );
     var yMax = d3.max(dataset, function(d) { return +d.PC2;} );
     var yMin = d3.min(dataset, function(d) { return +d.PC2;} );
 
       // todo:  after finding min and max, determine largest of each axis in abs value
       // todo:  then find next larger even number, use that throughout
     
     xMax = xMax * 1.1
     xMin = xMin * 1.1
     xMax = 40
     xMin = -40
     yMax = 30
     yMin = -30

     //console.log("xMax: " + xMax);   console.log("xMin: " + xMin);
     //console.log("yMax: " + yMax);   console.log("yMin: " + yMin);


    d3pcaDisplay.select("svg").remove();  // so that append("svg") is not cumulative
 
     var xScale = d3.scale.linear()
                    .domain([xMin,xMax])
                    .range([padding, width - padding]);

     var yScale = d3.scale.linear()
                    .domain([yMin, yMax])
                    .range([height - padding, padding]); // note inversion 

     var xTranslationForYAxis = xScale(0);
     var yTranslationForXAxis = yScale(0);

     var xAxis = d3.svg.axis()
                   .scale(xScale)
                   .orient("bottom")
                   .ticks(5);

     var yAxis = d3.svg.axis()
                   .scale(yScale)
                   .orient("left")
                   .ticks(5);

     var tooltip = d3.select("body")
                     .attr("class", "tooltip")
                     .append("div")
                     .style("position", "absolute")
                     .style("z-index", "10")
                     .style("visibility", "hidden")
                     .text("a simple tooltip");

     d3PlotBrush = d3.svg.brush()
        .x(xScale)
        .y(yScale)
        .on("brushend", d3PlotBrushReader);

     var PCAsvg = d3pcaDisplay.append("svg")
                 .attr("width", width)
                 .attr("height", height)
                 .call(d3PlotBrush);

     PCAsvg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0, " + yTranslationForXAxis + ")")
        .call(xAxis);

     PCAsvg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + xTranslationForYAxis + ", 0)")
        .call(yAxis);

     var circle = PCAsvg.append("g").selectAll("circle")
                     .data(dataset)
                     .enter()
                     .append("circle")
                     .attr("cx", function(d,i) {return xScale(d.PC1);})
                     .attr("cy", function(d,i) {return yScale(d.PC2);})
                     .attr("r", function(d) { return 3;})
                     .style("fill", function(d) {return(chooseColor(d))})
                     //.style("fill", function(d) { return "blue"})
                     .on("mouseover", function(d,i){
                         tooltip.text(d.id);
                         return tooltip.style("visibility", "visible");
                         })
                    .on("mousemove", function(){return tooltip.style("top",
                           (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
      
 
     } // d3PcaScatterPlot


  //--------------------------------------------------------------------------------------------
  return{
   init: function(){
      onReadyFunctions.push(initializeUI);
      addJavascriptMessageHandler("pcaPlot", pcaPlot);
      addJavascriptMessageHandler("PCAHandlePatientIDs", handlePatientIDs);
      addJavascriptMessageHandler("handlePatientClassification", handlePatientClassification)
      socketConnectedFunctions.push(getPatientClassification);
      socketConnectedFunctions.push(runDemo);
      }
   };

}); // PCAModule
//----------------------------------------------------------------------------------------------------
pca = PCAModule();
pca.init();

</script>
<script>
//----------------------------------------------------------------------------------------------------
var TimeLineModule = (function () {

     

     //--------------------------------------------------------------------------------------------------
     var TimelineTabNumber = 3;
     var TimeLineMargin = {top: 10, right: 15, bottom: 30, left: 20};
     var AlignBy = "--";
     var OrderBy = "--";
     var SidePlotEvent = "--";
     var TimeLineDisplay;
     var MainEvents = ["DOB","Encounter", "Diagnosis", "OR",  "MRI","Radiation", "Chemo","Progression",  "Status"]
     var MainEventColors = ["#17becf", "#d62728", "#8c564b","#ff7f0e", "#7f7f7f","#9467bd","#1f77b4","#2ca02c", "#bcbd22"]
     var MainEventTextSpacing = [0, 70, 82, 85, 75, 72, 75, 75, 80];
     var TimeLineSelectedRegion;    // from brushing
     var TimeLined3PlotBrush;
     var dialog;
     var TimeLinebroadcastButton;
     var CalculatedEvents =[{Name:"Survival", Event1: "Diagnosis", Event2: "Status", TimeScale: "Months"},
                            {Name:"AgeDx",Event1: "DOB", Event2: "Diagnosis", TimeScale: "Years"},
                            {Name:"TimeToProgression",Event1: "Diagnosis", Event2: "Progression", TimeScale: "Days"},
                            {Name:"FirstProgressionToDeath",Event1: "Progression", Event2: "Status", TimeScale: "Days"} ];
         CalculatedEvents = d3.nest()
              .key(function(d) { return d.Name; })
              .map(CalculatedEvents, d3.map);
              
     var OneDay = 1000 *60 * 60*24;
     var TimeLineColor = d3.scale.ordinal().range(MainEventColors).domain(MainEvents);
     var PatientHeight = 3;

     var Events,EventsByID, FormatDate, EventTypes, ShowEvents;
     var dispatch = d3.dispatch("load","LoadOptions", "DisplayPatients", "Update", "UpdateMenuOptions");
     var TimeLineInitialLoad=true;

       
        //--------------------------------------------------------------------------------------------
       function initializeUI(){
             console.log("========== initializing Timeline UI")
           TimeLineDisplay = $("#TimeLineDisplay");
           TimeLineHandleWindowResize();
           TimeLinebroadcastButton = $("#SendSelectionToClinicalTable");
              TimeLinebroadcastButton.click(broadcastSelection);
           $(window).resize(TimeLineHandleWindowResize);
           TimeLinebroadcastButton.prop("disabled",true);
          
           dispatch.load();
      };

     //--------------------------------------------------------------------------------------------------     
     function getDateDiff(Event1, Event2, TimeScale){
          console.log("Date Difference of " +Event2+ " - " + Event1 + " in " + TimeScale)          
          var DateDiff = []; var TimeScaleValue=1
          if(TimeScale==="Days"){TimeScaleValue=OneDay;}
          else if(TimeScale ==="Months"){TimeScaleValue=OneDay*30.425}
          else if(TimeScale==="Years"){ TimeScaleValue = OneDay*365.25}
               
          EventsByID.forEach(function(ID, Patient){
               var dateDiff = 0; var date1, date2;
               if(Patient.has(Event1) && Patient.has(Event2) ){
                   if(Patient.get(Event1)[0].date.length >1){
                        date1 = Patient.get(Event1).sort(AscendingStartDate)[0].date[0]
                    } else{
                         date1 = Patient.get(Event1).sort(AscendingDate)[0].date
                    }
                  if(Patient.get(Event2)[0].date.length >1){
                        date2 = Patient.get(Event2).sort(AscendingStartDate)[0].date[0]
                    } else{
                         date2 = Patient.get(Event2).sort(AscendingDate)[0].date
                    }
                    dateDiff = (date2 - date1 )/TimeScaleValue
                         DateDiff.push( {ID: ID,PtNum: Patient.get(Event1)[0].PtNum, value: dateDiff, Scale: TimeScale})
          }
          })
          return DateDiff;
     }
     
     //--------------------------------------------------------------------------------------------------     
     function getHorizontalBarSize(Patient){
     
          console.log("Creating Horizontal BarPlot: ", Patient)
          var BarSizes = []
          Patient.forEach(function(d){
               xBar = 0; barWidth = ~~d.value
               if(d.value < 0){ xBar = ~~d.value; barWidth = Math.abs(d.value);  }
               BarSizes.push( {ID: d.ID, info: ~~d.value, Scale: d.Scale, xBar: xBar, yBar: d.PtNum,  width: barWidth})
          })     
          return BarSizes;
     }
     
      //--------------------------------------------------------------------------------------------
     function TimeLineHandleWindowResize(){
       	console.log("===== resizing Timeline window")
          TimeLineDisplay.width($(window).width() * 0.95);
           TimeLineDisplay.height($(window).height() * 0.80);
          if(!TimeLineInitialLoad) {dispatch.DisplayPatients();}
     };

   //--------------------------------------------------------------------------------------------
   function broadcastSelection(){
      console.log("broadcastSelection: " + TimeLineSelectedRegion);
      x1=TimeLineSelectedRegion[0][0];
      y1=TimeLineSelectedRegion[0][1];
      x2=TimeLineSelectedRegion[1][0];
      y2=TimeLineSelectedRegion[1][1];
      ids = [];
      
      console.log(TimeLineSelectedRegion)
      function LogTime(t){
                     if(AlignBy === "--"){ 
                               return t;
                     } else{ var Dir = (t<0 ? -1 : 1); 
                         return Dir * Math.log(Math.abs(t/OneDay)+1)/Math.log(2)
                    }
               }     
  
      for(var i=0; i < Events.length; i++){
         event = Events[i];
         if(event.PtNum >= y1/PatientHeight & event.PtNum <= y2/PatientHeight){
			// Patient within range
            
            if(event.date.length>1 ){
                 if( (LogTime(event.date[0]-event.offset) >=x1 & LogTime(event.date[0]-event.offset) <= x2) ||
	                 (LogTime(event.date[1]-event.offset) >=x1 & LogTime(event.date[1]-event.offset) <= x2) ){
	                  // date endpoints within range
	                
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            } else{
                 if (LogTime(event.date-event.offset) >=x1 & LogTime(event.date-event.offset) <= x2) {
	                  // date within range
                      if(ids.indexOf(event.PatientID) === -1)
                        	ids.push(event.PatientID);
                }
            }
         }
      } // for i
    
    if(ids.length > 0)
         sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
    };

//--------------------------------------------------------------------------------------------
  function d3PlotBrushReader(){
     console.log("plotBrushReader");
     TimeLineSelectedRegion = TimeLined3PlotBrush.extent();
     //console.log("region: " + pcaSelectedRegion);
     y0 = TimeLineSelectedRegion[0][1];
     y1 = TimeLineSelectedRegion[1][1];
     selectHeight = Math.abs(y0-y1);
     if(selectHeight > 1)
        TimeLinebroadcastButton.prop("disabled", false);
     else
        TimeLinebroadcastButton.prop("disabled", true);
     }; // d3PlotBrushReader

   //--------------------------------------------------------------------------------------------
  function sendIDsToModule(ids, moduleName, title){
       callback = moduleName + title;
       msg = {cmd:"sendIDsToModule",
              callback: callback,
              status:"request",
              payload:{targetModule: moduleName,
                       ids: ids}
             };
     socket.send(JSON.stringify(msg));
      } // sendTissueIDsToModule

   //--------------------------------------------------------------------------------------------------     
   function handlePatientIDs(msg){
      console.log("Module.TimeLine: handlePatientIDs");
      console.log(msg)
    $("#tabs").tabs( "option", "active", TimelineTabNumber);
 //       TimeLineInitialLoad=true;
     if(msg.status == "success"){
         patientIDs = msg.payload
         console.log("TimeLine handlePatientIds: " + patientIDs);
         payload = patientIDs
         msg = {cmd: "getCaisisPatientHistory", callback: "DisplayPatientTimeLine", status: "request", 
                payload: payload};
         socket.send(JSON.stringify(msg));
         }
      else{
         console.log("handlePatientIDs about to call alert: " + msg)
         alert(msg.payload)
         }
      }; // handlePatientIDs


    //----------------------------------------------------------------------------------------------------
    function loadPatientDemoData(){

       console.log("==== patientTimeLines  get Events from File");
//       TimeLineInitialLoad=true;
       cmd = "getCaisisPatientHistory";
       status = "request"
       callback = "DisplayPatientTimeLine"
          filename = "" // was 'BTC_clinicaldata_6-18-14.RData', now learned from manifest file
          msg = {cmd: cmd, callback: callback, status: "request", payload: filename};
        // console.log(JSON.stringify(msg))
       socket.send(JSON.stringify(msg));
       } // loadPatientDemoData

     //--------------------------------------------------------------------------------------------------
     function DisplayPatientTimeLine(msg) {
         console.log("==== DisplayPatientTimeLine  Module.js document.ready");
          console.log(msg);

         console.log("==== DisplayPatientTimeLine  Events");     
          Events = msg.payload;
          console.log("Event count: " + Events.length);
         
          parseDate = d3.time.format ("%m/%d/%Y").parse;
          FormatDate = d3.time.format ("%x");
     
            Events.forEach(function(d) {
               d.Keep=true;
               if(d.date instanceof Array){
                    for(var i=0;i<d.date.length;i++){ 
                         if(parseDate(d.date[i])===null || !isValidDate(d.date[i])){ 
                              console.log("Flag "+ d.date[i]); d.Keep = false;
                         }else{  d.date[i] = parseDate(d.date[i]); }
               }}else{
                    if(parseDate(d.date)===null || !isValidDate(d.date)){ console.log("Flag "+ d.date); d.Keep=false;
                    } else{d.date = parseDate(d.date); }
               }
               if(d.Name === "Death") d.Name="Status"
              d.showPatient = true;
              d.disabled = false;
              d.offset = 0    });
     
          console.log("Remove Invalid Dates")
          Events = Events.filter(function(d) {if(!d.Keep){ console.log(d.date)}
               return d.Keep })

           EventsByID = d3.nest()
              .key(function(d) { return d.PatientID; })
               .key(function(d) { return d.Name; })
              .map(Events, d3.map);
 
          EventTypes = d3.map()
          Events.forEach(function(d){
               if(EventTypes.has(d.Name)){
                    if(EventTypes.get(d.Name).indexOf(d.Type) === -1){
                         EventTypes.get(d.Name).push(d.Type)            }
               } else {
                    EventTypes.set(d.Name, [d.Type])
               }
          });          
     
          ShowEvents = EventTypes.keys();

          CalculatedEvents.forEach(function(key, entry){
               var value = entry[0];
               if(!EventTypes.has(value.Event1) ||  !EventTypes.has(value.Event2) ){
                    console.log("Removing Calculated Event: " + key)
                    CalculatedEvents.remove(key)
               }
          })

          console.log("CaculatedEvents stored:", CalculatedEvents)
          console.log("Events stored:", Events)
          console.log("EventsByID stored:", EventsByID)

          if(TimeLineInitialLoad){
               dispatch.LoadOptions();
               TimeLineInitialLoad=false;
          }
          dispatch.DisplayPatients();
     }

     //--------------------------------------------------------------------------------------------------
     dispatch.on("LoadOptions.AllDisplays", function(){

          console.log("======== LoadOptions.AllDisplays")
          
          var width = $("#TimeLineDisplay").width();
          var height = $("#TimeLineDisplay").height();
          
          var   TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                legendSize = {height: 0.05*height, width: TimeLineSize.width};

          var svg = d3.select("#TimeLineDisplay").append("svg")
                   .attr("width", TimeLineSize.width + SideBarSize.width + 2*TimeLineMargin.left + 2*TimeLineMargin.right )
                   .attr("height", SideBarSize.height + TimeLineMargin.top + TimeLineMargin.bottom + legendSize.height)
                       ;

          var SidePlot = svg.append("g").attr("class", "SidePlotSVG")
                  .attr("transform", "translate(" + TimeLineMargin.left + "," + TimeLineMargin.top + ")");     
             
          var TimeLine = svg.append("g").attr("class", "TimeLineSVG")
                  .attr("transform", "translate(" + (SideBarSize.width+2*TimeLineMargin.left) + "," + TimeLineMargin.top + ")");
          
          
          var TextOffSet = d3.scale.ordinal()
               .range(MainEventTextSpacing)
               .domain(MainEvents);

          console.log("==== Event Types")
          var legend = svg
                     .append("g")
                   .attr("class", "legend")
                   .attr("transform", "translate(" + (SideBarSize.width+2* TimeLineMargin.left) + "," + (TimeLineSize.height+ TimeLineMargin.top + TimeLineMargin.bottom) + ")")
                    .selectAll(".legend")
                     .data(TimeLineColor.domain().filter(function(d){
                          return EventTypes.keys().indexOf(d) !== -1 })  )
              .enter().append("g")
            .attr("transform", function(d, i) { 
                      return "translate(" + i*TextOffSet(d) + ",0)" })
               ;
            legend.append("rect")
           .attr("width", 10)
           .attr("height", 10)
           .style("fill", function(d) { return TimeLineColor(d)})
           .on("click", ToggleVisibleEvent);

            legend.append("text")
            .attr("y", 9)
            .attr("x", 12)
            .style("font-size", 12)
           .text(function(d) { return d; });

          //--------------------------------------------------------------------------------------------------
          dispatch.on("DisplayPatients.SidePlotDisplay",  function(){

               console.log("======== DisplayPatients.SidePlotDisplay")
          
               SidePlot.selectAll("g").remove();

                   width = $("#TimeLineDisplay").width();
                    height = $("#TimeLineDisplay").height();
          
                 TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)}
                SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)}
                legendSize = {height: 0.05*height, width: TimeLineSize.width};
          
               svg.select(".legend")
                   .attr("transform", "translate(" + (SideBarSize.width+2* TimeLineMargin.left) + "," + (TimeLineSize.height+ TimeLineMargin.top + TimeLineMargin.bottom) + ")")
          
               var y = d3.scale.linear().range([SideBarSize.height, 0]), 
                    yAxis = d3.svg.axis().scale(y).orient("left").ticks(0),          
                    x = d3.scale.linear().range([0, SideBarSize.width]),
                    xAxis = d3.svg.axis().scale(x).orient("bottom")
                     y.domain(d3.extent(Events, function(d) { return PatientHeight*d.PtNum; }));
                              
               var PatientOrderBy = []
               var Categories = []

               
               console.log("Display Current Side Plot Event: " + SidePlotEvent)

               if(SidePlotEvent === "--"){     return;     
               } else if (CalculatedEvents.has(SidePlotEvent) ){
                    var event = CalculatedEvents.get(SidePlotEvent)[0]
                     console.log("Using event: ", event)
                     PatientOrderBy =  getHorizontalBarSize(getDateDiff(event.Event1,event.Event2,event.TimeScale)); 
               } else if(["Chemo", "Radiation", "Diagnosis", "OR", "Status", "MRI"].indexOf(SidePlotEvent) !== -1){
                    //get number of categories
                    EventsByID.forEach(function(ID, Patient){
                         if(Patient.has(SidePlotEvent) && Patient.get(SidePlotEvent)[0].showPatient){
                              Patient.get(SidePlotEvent).forEach(function(k){
                              if(Categories.indexOf(k.Type) == -1){ Categories.push(k.Type)} })
                         }
                    })
                    Categories.sort();
                    console.log(Categories)
                    console.log(Categories.length)
                    var xWidth = 1/Categories.length;
                    EventsByID.forEach(function(ID, Patient){
                         if(!Patient.has(SidePlotEvent)){
                         } else if(Patient.get(SidePlotEvent)[0].showPatient){               
                              var xPos = Categories.indexOf(Patient.get(SidePlotEvent)[0].Type)
                              PatientOrderBy.push( {ID: ID,info:Patient.get(SidePlotEvent)[0].Type, yBar: Patient.get(SidePlotEvent)[0].PtNum,
                                              xBar: xPos * xWidth , width: xWidth})
                         }
                    })
                    xAxis.ticks(Categories.length)
                         .tickValues(makeArray(Categories.length,  function(i) { return i/Categories.length; }))
                         .tickFormat(function (d) {console.log(Categories[d*Categories.length]); return Categories[d*Categories.length]     })
               } 

               console.log("PatientOrderBy")
               console.log(PatientOrderBy)

                x.domain([d3.min([d3.min(PatientOrderBy, function(d){return d.width}),d3.min(PatientOrderBy, function(d){return d.xBar})]),
                               d3.max(PatientOrderBy, function(d){ return d.xBar + d.width})]).nice();

               console.log("SidePlotDomain: ", d3.min([d3.min(PatientOrderBy, function(d){return d.width}),d3.min(PatientOrderBy, function(d){return d.xBar})]),
               d3.max(PatientOrderBy, function(d){ return d.xBar + d.width}) )

 //            d3PlotBrush = d3.svg.brush()
   //            .x(x)
     //          .y(y)
       //        .on("brushend", d3PlotBrushReader);

          //     SidePlot.call(d3PlotBrush);

             var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");
     
                 SidePlot.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (SideBarSize.height+10) + ")")
                .call(xAxis)
                .selectAll("text")  
                    .style("text-anchor", "end")
                    .style("font-size", 12)
                      .attr("dy", ".55em")
                      .attr("dx", "-.45em")
                     .attr("transform", function(d) {
                         return "rotate(-75)" 
                        });
 
                 SidePlot.append("g")
                .attr("class", "y axis")
                .call(yAxis)
              .append("text")
                .on("mouseover", function(d){
                        tooltip.text("click to reorder by SidePlot value");
                     return tooltip.style("visibility", "visible"); })
                 .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
               .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                 .on("click", function(){
                           OrderBySidePlot(); 
                           dispatch.Update();
                           dispatch.DisplayPatients();})
                .attr("transform", "rotate(-90)")
                .attr("y", 2)
                .attr("dy", "-.71em")
                .style("font-size", 12)
                .style("text-anchor", "end")
                .text(SidePlotEvent)
                ;
            
               var BarPlot_Horiz = SidePlot.append("g").selectAll("rect")
                    .data(PatientOrderBy)
                    .enter()
                         .append("rect")
                         .attr("x", function(d) { return x(d.xBar);  })
                         .attr("y", function(d) { return y(PatientHeight*d.yBar); })
                         .attr("width", function(d) { return Math.abs(x(d.width) - x(0));  })
                         .attr("height", function(d) { return PatientHeight; })
                         .attr("fill", function(d){ 
                              var ColorShade =  d3.rgb(TimeLineColor(SidePlotEvent)); //d3.rgb("grey"); //
                              if(Categories.length>0){ 
                                   return ColorShade.brighter((Categories.indexOf(d.info) % 5)/2) };
                              return ColorShade;
                              })
                         .on("mouseover", function(d,i){
                          tooltip.text(d.ID + ": " + d.info);
                     return tooltip.style("visibility", "visible");
                     })
                          .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                          .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                         ;
          })

          //--------------------------------------------------------------------------------------------------
          dispatch.on("DisplayPatients.TimeLineDisplay",  function(){

               console.log("======== DisplayPatients.TimeLineDisplay")
               TimeLine.selectAll("g").remove();


                var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");

               var EventOffset = d3.map({"Radiation": 1.5, "Chemo": -1.5})
               var x,TimeScale, xTitle, xAxis, 
                    y = d3.scale.linear().range([TimeLineSize.height, 0]), 
                    yAxis = d3.svg.axis().scale(y).orient("left").ticks(0)
                    ;
               function LogTime(t){
                     if(AlignBy === "--"){ 
                               return t;
                     } else{ var Dir = (t<0 ? -1 : 1); 
                         return Dir * Math.log(Math.abs(t)+1)/Math.log(2) 
                    }
               }     
          
               if(OrderBy !== "--"){ OrderEvents();}
               if(AlignBy === "--"){ 
                     x = d3.time.scale().range([0, TimeLineSize.width]); TimeScale =1;
                     Xtitle="Year";
                     xAxis = d3.svg.axis().scale(x).orient("bottom")
               } else{
                    AlignEvents();
                     x =  d3.scale.linear().range([0, TimeLineSize.width])
                     TimeScale = OneDay
                     Xtitle = "Days"
                     xAxis = d3.svg.axis().scale(x).orient("bottom")
                         .ticks(10)
                         .tickFormat(function (d) { 
                              var Dir = (d<0 ? -1 : 1); 
                              return Math.round(Dir * (Math.pow(2, (Math.abs(d)))-1) *100)/100})
                    }

               var EventMin      = d3.min(Events.filter(function(d){ return d.showPatient && !d.disabled}), function(d){ 
                                        var date = (d.date instanceof Array ? d.date.sort(DescendingDate)[0] : d.date);  return LogTime((date - d.offset)/TimeScale);})
               var EventMax      = d3.max(Events.filter(function(d){ return d.showPatient && !d.disabled}), function(d){ 
                                        var date = (d.date instanceof Array ? d.date.sort(DescendingDate)[d.date.length-1] : d.date);  return LogTime((date - d.offset)/TimeScale);})

               console.log("Min: " + EventMin + ", Max: "+ EventMax)
               x.domain([EventMin, EventMax]);
               y.domain([d3.min(Events,function(d) { return d.PtNum; }),d3.max(Events,function(d) { return PatientHeight*d.PtNum; })]);


             TimeLined3PlotBrush = d3.svg.brush()
               .x(x)
               .y(y)
               .on("brushend", d3PlotBrushReader);

               TimeLine.call(TimeLined3PlotBrush);


            TimeLine.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + TimeLineSize.height + ")")
                .call(xAxis)
               .append("text")
               .style("font-size", 12)
                .text(Xtitle);
 
            TimeLine.append("g")
                .attr("class", "y axis")
                .call(yAxis)
              .append("text")
                     .attr("transform", "rotate(-90)")
                .attr("y", 2)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .style("font-size", 12)
                .text("Patients");
      
               var TimeSeries = TimeLine.append("g").selectAll("path")
                    .data(Events.filter(function(d){ return (d.date instanceof Array) && !d.disabled && d.showPatient}))
               ;

               console.log("TimeSeries")
               console.log(TimeSeries)

               TimeSeries.enter()
                    .append("line")
                    .attr("class", "path")
                    .attr("x1", function(d) { return x(LogTime((d.date[0] - d.offset)/TimeScale));  })
                    .attr("y1", function(d) { return y(PatientHeight*d.PtNum + EventOffset.get(d.Name)); })
                    .attr("x2", function(d) { return x(LogTime((d.date[1] - d.offset)/TimeScale));  })
                    .attr("y2", function(d) { return y(PatientHeight*d.PtNum+ EventOffset.get(d.Name)); })
                    .attr("stroke", function(d){ 
                         var ColorShade = d3.rgb(TimeLineColor(d.Name)); 
                         if(d3.keys(d).indexOf("Type") !== -1){ 
                              return ColorShade.brighter((EventTypes.get(d.Name).indexOf(d.Type) % 5)/2) };
                         return ColorShade;
                         })
                    .attr("stroke-width", PatientHeight*0.75)
                    .attr("data-legend",function(d) { return d.Name})
                    .on("mouseover", function(d,i){
                         var Type = ""; if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Type}
                     tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.date[0]) + ", "+ FormatDate(d.date[1]) + ") " + Type);
                     return tooltip.style("visibility", "visible");
                     })
                     .on("mousemove", function(){return tooltip.style("top",
                    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                     .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                    ;

               TimeSeries.exit().remove();

               var TimePoint = TimeLine.append("g").selectAll("circle")
                    .data(Events.filter(function(d){ return !(d.date instanceof Array) && !d.disabled && d.showPatient}));

               console.log("TimePoint")
               console.log(TimePoint)
                    
               TimePoint.enter()
                    .append("circle")
                    .attr("class", "circle")
                    .style("fill", function(d){ return TimeLineColor(d.Name) })
                    .attr("cx", function(d) {return x(LogTime((d.date -d.offset)/TimeScale)); })
                    .attr("cy", function(d) { return y(PatientHeight*d.PtNum); })
                    .attr("r", function(d) { return PatientHeight;})
                    .attr("data-legend",function(d) { return d.Name})
                    .on("mouseover", function(d,i){
                         var Type = ""; if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Type}
                      tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.date) +") " + Type);
                      return tooltip.style("visibility", "visible");
                     })
                     .on("mousemove", function(){return tooltip.style("top",
                    (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                     .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
               ;

               TimePoint.exit().remove();                    

               })
          })

          //--------------------------------------------------------------------------------------------------
          dispatch.on("load.Menu", function(){
         
              var width = $("#TimeLineDisplay").width();
               var height = $("#TimeLineDisplay").height();
          
               var   TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                     SideBarSize = {width: (0.2*width - TimeLineMargin.left - TimeLineMargin.right),  height: (0.95*height - TimeLineMargin.top - TimeLineMargin.bottom)},
                     legendSize = {height: 0.05*height, width: TimeLineSize.width};

               console.log("======== load.Menu")
                 var  AlignByMenu = d3.select("#AlignByDiv")
                   .attr("transform", "translate(" + (3*TimeLineMargin.left+SideBarSize.width+TimeLineMargin.right) + ",0)")
                    .append("g")
                     .append("select")
                    .on("change", function() {
                         AlignBy = this.value; 
                         AlignEvents(); 
                         dispatch.DisplayPatients()});
                 ;
               AlignByMenu.selectAll("option")
                    .data(["--"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;

                 var  OrderByMenu = d3.select("#OrderByDiv")
                   .attr("transform", "translate(" + (TimeLineMargin.left+SideBarSize.width+TimeLineMargin.left+TimeLineMargin.right) + ",0)")
                     .append("g")
                   .append("select")
                    .on("change", function() {
                         OrderBy = this.value; 
                         if(OrderBy === "+Add"){
                              console.log("== changing OrderBy with ", OrderBy)
                              OpenDialogForAddedEvents("OrderBy");
                         } else{
                              console.log("== changing OrderBy ", OrderBy)
                         OrderEvents();      
                              dispatch.DisplayPatients();
//                              dialog.dialog("destroy");
                         }
                    })
                 ;
               OrderByMenu.selectAll("option")
                    .data(["--", "+Add"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
               var  AddSideBarMenu = d3.select("#AddSideBar")
                    .style("display", "inline-block") 
                    .style("width", (SideBarSize.width + 2*TimeLineMargin.left + TimeLineMargin.right) +"px" )
                    .append("g")
                    .append("select")
                    .on("change", function() {SidePlotEvent = this.value; 
                         if(SidePlotEvent === "+Add"){
                              console.log("== changing SideBar with ", SidePlotEvent)
                              OpenDialogForAddedEvents("SidePlot");
                         } else{ 
                              console.log("== changing SideBar", SidePlotEvent)
                                                  dispatch.DisplayPatients(); 
//                         dialog.dialog("destroy");
                         }
                                                  });
               AddSideBarMenu.selectAll("option")
                    .data(["--", "+Add"])
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
                var  SaveImage = d3.select("#SaveImageDiv")
                    .on("click", function() {
                         console.log("========Save Image: ")
          
                         var html = d3.select("svg")
                                      .attr("version", 1.1)
                                  .attr("xmlns", "http://www.w3.org/2000/svg")
                                      .node().parentNode.innerHTML;
                        var imgsrc = 'data:image/svg+xml;base64,'+ btoa(html);
                         var img = '<img src="'+imgsrc+'">';
                    
                         var canvas = document.querySelector("canvas"),
                             context = canvas.getContext("2d");

                         var image = new Image;
                         image.src = imgsrc;
                         image.onload = function() {
                                context.drawImage(image, 0, 0);
          
                              var canvasdata = canvas.toDataURL("image/png");
                              var pngimg = '<img src="'+canvasdata+'">'; 

                                var a = document.createElement("a");
                                   a.download = "test.png"
                                     a.href = canvasdata;
                                a.click();
                         }
                    })
     
         //--------------------------------------------------------------------------------------------------
         dispatch.on("UpdateMenuOptions.Menu", function(){
     
            console.log("======== UpdateMenuOptions")
            console.log("CalculatedEvents keys: ", CalculatedEvents.keys())
            console.log("EventTypes keys: ",EventTypes.keys())
            console.log("OrderByMenu: ", OrderByMenu)
     
          OrderByMenu.selectAll("option").remove()     
          AlignByMenu.selectAll("option").remove()
          AddSideBarMenu.selectAll("option").remove()
              
           OrderByMenu.selectAll("option")
                    .data(d3.merge([["--", "+Add"], CalculatedEvents.keys() ,EventTypes.keys()]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
                ;
       
                 AlignByMenu.selectAll("option")
                    .data(d3.merge([["--"],EventTypes.keys()]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
           ;
           
           AddSideBarMenu.selectAll("option")
                    .data(d3.merge([["--", "+Add"], CalculatedEvents.keys(), ["Radiation", "Chemo", "Diagnosis", "OR", "MRI", "Status"].filter(function(d){console.log(d, EventTypes.has(d)); return EventTypes.has(d) })]))
                    .enter()
                         .append("option")
                         .attr("value", function(d){return d})
                         .text(function(d) { return d})
           ;
                     
        })
        //--------------------------------------------------------------------------------------------------
          dispatch.on("LoadOptions.Menu",  function(){
               console.log("======== LoadOptions.Menu")     
               dispatch.UpdateMenuOptions()
          })
     
          
          //--------------------------------------------------------------------------------------------------
          dispatch.on("Update.Menu", function(){
               console.log("======== Update.Menu")
                
               OrderByMenu.selectAll("option")
                         .each(function(d){console.log(d); if(d === OrderBy) return d3.select(this).attr("selected", "selected")})
               AddSideBarMenu.selectAll("option")
                         .each(function(d){console.log(d); if(d === SidePlotEvent) return d3.select(this).attr("selected", "selected")})				
               AlignByMenu.selectAll("option")
                         .each(function(d){console.log(d); if(d === AlignBy) return d3.select(this).attr("selected", "selected")})
          })
     })
     //--------------------------------------------------------------------------------------------
     function UpdateCalculatedEvent(value){
               
          }
        //--------------------------------------------------------------------------------------------
       function CreateCalculatedEvent() {
                          var Name = $( "#Name" ).val();
                          var Event1 = $( "#Event1" ).val();
                          var Event2 = $( "#Event2" ).val();
                          var TimeScale = $( "#TimeScale").val();
                         console.log("Calculated Event: ")
                         console.log(Name); console.log(Event1); console.log(Event2); console.log(TimeScale);

                          var valid = true;
      
                          valid = valid && EventTypes.has(Event1);
                          valid = valid && EventTypes.has(Event2);
                           valid = valid && ["Days", "Months", "Years"].indexOf(TimeScale) !== -1;
  
                          if ( valid ) {
                            CalculatedEvents.set(Name, [{Name: Name, Event1: Event1, Event2: Event2,  TimeScale: TimeScale}])
                            console.log("Calculated Events Added: " + Name)
                            console.log(CalculatedEvents);
                             dialog.dialog( "close" );
                             return(Name);
                          } else {
                                 console.log("Invalid Calculated Event");
                               return("--");
                          }
                   }

      
      //--------------------------------------------------------------------------------------------
       function OpenDialogForAddedEvents(MenuType) {
          console.log("======== Dialog for Adding Events")
          dialog = $( "#AddCalculatedEvent" ).dialog({
                autoOpen: false,
                title: "Calculate Event",
                height: 300,
                width: 400,
                buttons: {
                  "Create": function(){
                            var value = CreateCalculatedEvent()
                            
                            if(MenuType == "OrderBy"){
                                   OrderBy = value;
                                   console.log("OrderBy is now: " + OrderBy);
                                   OrderEvents();
                              } else if (MenuType == "SidePlot"){
                                   SidePlotEvent = value;
                                   console.log("SidePlotEvent is now: " + SidePlotEvent);
                              }
                              dialog.dialog("close")
                               dispatch.UpdateMenuOptions();
                               dispatch.Update(); 
                               dispatch.DisplayPatients();
                       },
                  Cancel: function() { dialog.dialog( "close" ); UpdateCalculatedEvent("--");}
                },
                close: function() {}
                
         });
           dialog.dialog( "open" );
          console.log("open dialog")

     }

     //--------------------------------------------------------------------------------------------------
     function AlignEvents(){
     
          console.log("========Align Event: "+ AlignBy);
          Events.forEach(function(d){ d.offset = 0; d.showPatient=true;})
          EventsByID.forEach(function(ID, Patient){
                         Patient.forEach(function(id, event){event.showPatient = true; event.offset=0;})})

          if (AlignBy === "AgeDx"){ 
          } else if(EventTypes.keys().indexOf(AlignBy) !== -1){
               EventsByID.forEach(function(ID, Patient){
                    if( Patient.has(AlignBy)){
                         var MinPatientAlignBy = d3.min(Patient.get(AlignBy), function(d) {var date = (d.date instanceof Array ? d3.min(d.date) : d.date);  return date})
                         Events.filter(function(d){return d.PatientID === ID})
                              .forEach(function(d){ d.offset = MinPatientAlignBy;})
                    }
                    else{          // hide Patients that can't be aligned
                         Events.filter(function(d){return d.PatientID === ID})
                                   .forEach(function(d){ d.showPatient = false; d.offset=0;})
                         Patient.forEach(function(id, event){event.showPatient = false; event.offset=0;})
                    }
               })
          }
     }     

     //--------------------------------------------------------------------------------------------------
     function OrderEvents(){
     
          console.log("========Order Event: "+ OrderBy);
          var PatientOrderBy = []


          if(CalculatedEvents.has(OrderBy) ){
                var event = CalculatedEvents.get(OrderBy)[0]
                console.log(event)
                PatientOrderBy = getDateDiff(event.Event1,event.Event2,""); 
          } else if(EventTypes.keys().indexOf(OrderBy) !== -1){
               EventsByID.forEach(function(ID, Patient){
                    if( Patient.has(OrderBy)){
                         PatientOrderBy.push(d3.min(Patient.get(OrderBy), function(d) 
                              {var date = (d.date instanceof Array ? d3.min(d.date) : d.date);   
                                   return {ID: ID, value: date} }))
                    } else{
                         PatientOrderBy.push({ID: ID, value: 0} )
                    }   })
          } 
     
          PatientOrderBy.sort(DescendingValues).forEach(function(Ordered, i){
                         Events.filter(function(d){return d.PatientID === Ordered.ID})
                                   .forEach(function(d){ d.PtNum = i})
                         if(EventsByID.has(Ordered.ID)){EventsByID.get(Ordered.ID)
                                   .forEach(function(d){ d.PtNum = i})}
               })
          
          console.log("Reordered")
          console.log(PatientOrderBy)
     }     
     //--------------------------------------------------------------------------------------------------
     function OrderBySidePlot(){
     
          console.log("========Order by SidePlot: "+ SidePlotEvent);
          var PatientOrderBy = [], Categories = [];

          OrderBy = "--";
          if(CalculatedEvents.has(SidePlotEvent) ){
                var event = CalculatedEvents.get(SidePlotEvent)[0]
                console.log(event)
                PatientOrderBy = getDateDiff(event.Event1,event.Event2,""); OrderBy=SidePlotEvent;
          
          } else if(EventTypes.keys().indexOf(SidePlotEvent) !== -1){

               EventsByID.forEach(function(ID, Patient){
                    if(Patient.has(SidePlotEvent) && Patient.get(SidePlotEvent)[0].showPatient){
                         Patient.get(SidePlotEvent).forEach(function(k){
                              if(Categories.indexOf(k.Type) == -1){ Categories.push(k.Type)}
                         })
                         PatientOrderBy.push({ID:ID, value: Patient.get(SidePlotEvent)[0].Type})
                    }
               })
               
               Categories.sort();
               console.log(Categories)
               console.log(Categories.length)
          
               PatientOrderBy.forEach(function(d,i){
                    d.value = Categories.indexOf(d.value)
               })
               
          }
          
          PatientOrderBy.sort(DescendingValues).forEach(function(Ordered, i){
                         Events.filter(function(d){return d.PatientID === Ordered.ID})
                                   .forEach(function(d){ d.PtNum = i})
                         if(EventsByID.has(Ordered.ID)){EventsByID.get(Ordered.ID)
                                   .forEach(function(d){ d.PtNum = i})}
               })
          
          
          console.log("Reordered")
          console.log(PatientOrderBy)
     }     

     //--------------------------------------------------------------------------------------------------
     function DescendingDate(a,b) {
       if (a.date > b.date)
          return -1;
       if (a.date < b.date)
         return 1;
       return 0;
     }
    //--------------------------------------------------------------------------------------------------
     function DescendingStartDate(a,b) {
       if (a.date[0] > b.date[0])
          return -1;
       if (a.date[0] < b.date[0])
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function AscendingDate(a,b) {
       if (a.date < b.date)
          return -1;
       if (a.date > b.date)
         return 1;
       return 0;
     }
    //--------------------------------------------------------------------------------------------------
     function AscendingStartDate(a,b) {
       if (a.date[0] < b.date[0])
          return -1;
       if (a.date[0] > b.date[0])
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function DescendingValues(a,b) {
       if (a.value > b.value)
          return -1;
       if (a.value < b.value)
         return 1;
       return 0;
     }
     //--------------------------------------------------------------------------------------------------
     function makeArray(count, content) {
        var result = [];
        if(typeof(content) == "function") {
           for(var i=0; i<count; i++) {
              result.push(content(i));
           }
        } else {
           for(var i=0; i<count; i++) {
              result.push(content);
           }
        }
        return result;
     }
     //--------------------------------------------------------------------------------------------------
     function isValidDate(text) {
          //eg text = '2/30/2011';
     
          var comp = text.split('/');
          var m = parseInt(comp[0], 10);
          var d = parseInt(comp[1], 10);
          var y = parseInt(comp[2], 10);
          var date = new Date(y,m-1,d);
     
          if (date.getFullYear() !== y || date.getMonth() + 1 !== m || date.getDate() !== d){
               console.log("Invalid Format Month/Day/Year " + text + ": " + m + "/" + d+ "/" + y)
             return false;
          }
               
          // check month and year
          if(y < 1000 || y > 3000 || m == 0 || m > 12){
               console.log("Invalid Month/Year: " + m + "/" + y)
             return false;
          }
         var monthLength = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 ];
     
         // Adjust Days for leap years
         if(y % 400 == 0 || (y % 100 != 0 && y % 4 == 0))
             monthLength[1] = 29;
     
         // Check the range of the day
         if( d <= 0 || d > monthLength[m - 1]){
               console.log("Invalid Day/Month: " + d+ "/" + m)    
               return false;
          }
          
          return true;
     }
     //--------------------------------------------------------------------------------------------------     
     function ToggleVisibleEvent(d){
         
         var hide = false;
         var newFilters = [];
      
         ShowEvents.forEach(function (f) {
           if (d === f) {  
                hide = true;
                console.log("Hiding " + d);
                Events.forEach(function(D){ 
                     if(D.Name === d) {D.disabled=true}});
           } else { newFilters.push(f);}
         });
     
          // Hide the shape or show it
          if (hide) {  d3.select(this).style("opacity", 0.2);
         } else {
           d3.select(this).style("opacity", 1);
           newFilters.push(d);
           Events.forEach(function(D){ 
                     if(D.Name === d) {D.disabled=false}});
          }
          ShowEvents = newFilters;
          dispatch.DisplayPatients();
     }
     //--------------------------------------------------------------------------------------------------
     
     //--------------------------------------------------------------------------------------------------

  return{
   init: function(){
             console.log("========== initializing PatientModule")
          onReadyFunctions.push(initializeUI);
          
          addJavascriptMessageHandler("DisplayPatientTimeLine", DisplayPatientTimeLine);
         addJavascriptMessageHandler("timeLinesHandlePatientIDs", handlePatientIDs);
      
         socketConnectedFunctions.push(loadPatientDemoData);
   }
  };

}); // TimeLineModule
//----------------------------------------------------------------------------------------------------
PatientTimeLine = TimeLineModule();
PatientTimeLine.init();
</script>



<script>
//----------------------------------------------------------------------------------------------------
var SavedSelectionModule = (function (){
     
     var nodecount_i;
     var height;
     var root;
    
    var	tree, diagonal;
	var SaveSelectedDisplay;
    var InitialLoad;
    var SaveSelectedsvg;
    var CurrentSelection;
    var SelectionNames= [];
  
//--------------------------------------------------------------------------------------------
  function handleWindowResize(){
      SaveSelectedDisplay.width($(window).width() * 0.95);
      SaveSelectedDisplay.height($(window).height() * 0.95);
     }; // handleWindowResize

   
//----------------------------------------------------------------------------------------------------
	function initializeSelectionUI(){			     
	 console.log("====== Initializing Selection UI")

        nodecount_i=0;
         var margin = {top: 10, right: 15, bottom: 30, left: 20};
        InitialLoad = true;
	    SaveSelectedDisplay = $("#SavedSelectionTreeDiv");
        handleWindowResize();
        
        height = SaveSelectedDisplay.height(); //200;      
        var width = SaveSelectedDisplay.width(); //200;       
         
        tree = d3.layout.tree()
         .size([(height-margin.top-margin.bottom), (width-margin.left-margin.right)]);
     
        diagonal = d3.svg.diagonal()
         .projection(function(d) { return [d.y, d.x]; });
          
        SaveSelectedsvg = d3.select("#SavedSelectionTreeDiv").append("svg")
         .attr("width", width)
         .attr("height", height)
         .append("g")
             .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

         $(window).resize(handleWindowResize);

		// if date modified needs updated
		//http://www.dynamicdrive.com/forums/archive/index.php/t-63637.html

       };
       
//----------------------------------------------------------------------------------------------------
     function testingAddSavedSelection() {
       msg = {cmd:"test",
              callback: "",
              status:"request",
              payload:{  name: "test set",
         			PatientIDs : "random set of IDs here",
         			Tab: "None",
         			Settings: "gibberish"
         		}
             };
        addSavedSelection(msg);

}
//----------------------------------------------------------------------------------------------------
     function addSavedSelection(msg) {
       
       console.log("=== Saving Selection", msg)
 
 		var i=0;
 		var nameSuffix = ""
 		var nodeName =msg.payload.name 
        while(SelectionNames.indexOf(nodeName.concat(nameSuffix)) !== -1){
		    i++;
		    nameSuffix = "_".concat(i)	
		}
       newNode = msg.payload
       newNode.name = nodeName.concat(nameSuffix)
       SelectionNames.push(newNode.name)
       
       if(CurrentSelection.children){ 
            CurrentSelection.children.push(newNode);
       } else { CurrentSelection.children = [newNode] }
       
       var currentNode = CurrentSelection
       var update_id = CurrentSelection.id
       while(currentNode.parent){ 
          currentNode.parent.children[ currentNode.parent.children.indexOf(function(d) {  d.id ===update_id})] = currentNode;
          currentNode = currentNode.parent
        }
        root = currentNode;
       updateSavedSelection(root);
       
       CurrentSelection = CurrentSelection.children.filter(function(d){ return d.id === nodecount_i })[0]
    console.log("new tree: ", root)
    console.log("CurrentSelection: ", CurrentSelection)
	}       


//----------------------------------------------------------------------------------------------------
function make_editable(d, field)
{
// code from https://gist.github.com/GerHobbelt/2653660

    console.log("make_editable", arguments);
 
    this
      .on("mouseover", function() {
        d3.select(this).style("fill", "red");
      })
      .on("mouseout", function() {
        d3.select(this).style("fill", null);
      })
      .on("click", function(d) {
        var p = this.parentNode;
        console.log(this, arguments);
 
        // inject a HTML form to edit the content here...
 
        // bug in the getBBox logic here, but don't know what I've done wrong here;
        // anyhow, the coordinates are completely off & wrong. :-((
        var xy = this.getBBox();
        var p_xy = p.getBBox();
 
        xy.x -= p_xy.x;
        xy.y -= p_xy.y;
 
        var el = d3.select(this);
        var p_el = d3.select(p);
 
        var frm = p_el.append("foreignObject");
 
        var inp = frm
            .attr("x", xy.x)
            .attr("y", xy.y)
            .attr("width", 300)
            .attr("height", 25)
            .append("xhtml:form")
                    .append("input")
                        .attr("value", function() {
                            // nasty spot to place this call, but here we are sure that the <input> tag is available
                            // and is handily pointed at by 'this':
                            this.focus();
 
                            return d[field];
                        })
                        .attr("style", "width: 294px;")
                        // make the form go away when you jump out (form looses focus) or hit ENTER:
                        .on("blur", function() {
                            console.log("blur", this, arguments);
 
                            var txt = inp.node().value;
 
                            d[field] = txt;
                            el
                                .text(function(d) { return d[field]; });
 
                            // Note to self: frm.remove() will remove the entire <g> group! Remember the D3 selection logic!
                            p_el.selectAll(function() { return this.getElementsByTagName("foreignObject"); }).remove();
                        })
                        .on("keydown", function() {
                            console.log("keypress", this, arguments);
 
                            // IE fix
                            if (!d3.event)
                                d3.event = window.event;
 
                            var e = d3.event;
                            if (e.keyCode == 13)
                            {
                                if (typeof(e.cancelBubble) !== 'undefined') // IE
                                  e.cancelBubble = true;
                                if (e.stopPropagation)
                                  e.stopPropagation();
                                e.preventDefault();
 
                                var txt = inp.node().value;
 
                                d[field] = txt;
                                el
                                    .text(function(d) { return d[field]; });
 
                                // odd. Should work in Safari, but the debugger crashes on this instead.
                                // Anyway, it SHOULD be here and it doesn't hurt otherwise.
                                p_el.selectAll(function() { return this.getElementsByTagName("foreignObject"); }).remove();
                            }
                        });
      });
}
//----------------------------------------------------------------------------------------------------
     function updateSavedSelection(source) {
       var duration = d3.event && d3.event.altKey ? 5000 : 500;
     
     var tooltip = d3.select("body")
                .attr("class", "tooltip")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "20")
                .style("visibility", "hidden")
                ;
     
       // Compute the new tree layout.
       var nodes = tree.nodes(root).reverse();
       console.log("Nodes", nodes);
       
       // Normalize for fixed-depth.
       nodes.forEach(function(d) { d.y = d.depth * 180; });
     
       // Update the nodes…
       var node =  SaveSelectedsvg.selectAll("g.node")
           .data(nodes, function(d) { return d.id || (d.id = ++nodecount_i); });
     
       // Enter any new nodes at the parent's previous position.
       var nodeEnter = node.enter().append("g")
           .attr("class", "node")
           .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
            .on("click", function(d) { toggle(d); updateSavedSelection(d); });
     
       nodeEnter.append("circle")
           .attr("r", 1e-6)
           .style("fill", function(d) { return d._children ? "lightsteelblue" : "grey"; })
           .on("mouseover", function(d){
                  var settings = getSettingsString(d);
                    tooltip.html(d.PatientIDs.length + " Patients from " + d.Tab + "<br></br>Settings: " + settings)
                     return tooltip.style("visibility", "visible"); })
           .on("mousemove", function(){return tooltip.style("top",
                         (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
           .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
           ;
     
       nodeEnter.append("text")
           .attr("class", "NodeName")
           .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
           .attr("dy", "1em")
           .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
           .text(function(d) { return d.name; })
           .style("fill-opacity", 1e-6)
           .call(make_editable, "NodeName");
     
       // Transition nodes to their new position.
       var nodeUpdate = node.transition()
           .duration(duration)
           .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });
     
       nodeUpdate.select("circle")
           .attr("r", 4.5)
           .style("fill", function(d) { return d._children ? "lightsteelblue" : "grey"; });
     
       nodeUpdate.select("text")
           .style("fill-opacity", 1);
     
       // Transition exiting nodes to the parent's new position.
       var nodeExit = node.exit().transition()
           .duration(duration)
           .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
           .remove();
     
       nodeExit.select("circle")
           .attr("r", 1e-6);
     
       nodeExit.select("text")
           .style("fill-opacity", 1e-6);
     
       // Update the links…
       var link = SaveSelectedsvg.selectAll("path.link")
           .data(tree.links(nodes), function(d) { return d.target.id; });
     
       // Enter any new links at the parent's previous position.
       link.enter().insert("path", "g")
           .attr("class", "link")
           .attr("d", function(d) {
             var o = {x: source.x0, y: source.y0};
             return diagonal({source: o, target: o});
           })
         .transition()
           .duration(duration)
           .attr("d", diagonal);
     
       // Transition links to their new position.
       link.transition()
           .duration(duration)
           .attr("d", diagonal);
     
       // Transition exiting nodes to the parent's new position.
       link.exit().transition()
           .duration(duration)
           .attr("d", function(d) {
             var o = {x: source.x, y: source.y};
             return diagonal({source: o, target: o});
           })
           .remove();
     
       // Stash the old positions for transition.
       nodes.forEach(function(d) {
         d.x0 = d.x;
         d.y0 = d.y;
       });
     }
     
//----------------------------------------------------------------------------------------------------
     // Toggle children.
     function toggle(d) {
       if (d.children) {
         d._children = d.children;
         d.children = null;
       } else {
         d.children = d._children;
         d._children = null;
       }
     }
//----------------------------------------------------------------------------------------------------
    function getSettingsString(d){
		console.log("change setting string: ",  d)
		var SettingsString = d.Settings;
		if(d.Tab === "ClinicalTable"){
		   if(d.Settings.ageAtDxMin){
		       SettingsString = "AgeDx [" + d.Settings.ageAtDxMin + ", " + d.Settings.ageAtDxMax + "] <br>"
		                  + "Survival [" + d.Settings.overallSurvivalMin + ", " + d.Settings.overallSurvivalMax + "]";
		    }
		}
		return SettingsString;
		
}
//----------------------------------------------------------------------------------------------------
    function loadPatientData(){

       console.log("==== SavedSelection  get all PatientIDs from ClinicalTable");
       cmd = "getCaisisPatientHistory"; //sendCurrentIDsToModule
       status = "request"
       callback = "SetupSavedSelectionTree"
          filename = "" // was 'BTC_clinicaldata_6-18-14.RData', now learned from manifest file
          msg = {cmd: cmd, callback: callback, status: "request", payload: filename};
        // console.log(JSON.stringify(msg))
       socket.send(JSON.stringify(msg));
       } // loadPatientDemoData

//----------------------------------------------------------------------------------------------------
     function SetupSavedSelectionTree(msg){			     

		console.log("===== Setup SavedSelection Tree")
         console.log(msg)

         var AllData = msg.payload
         var PtIDs = []; 
         for(var i=0;i<AllData.length; i++){
         	if(PtIDs.indexOf(AllData[i].PatientID) === -1)
         		PtIDs.push(AllData[i].PatientID)
         }
         console.log("All Patients: ", PtIDs)
         root = {   "name": "All Patients",
         			"PatientIDs" : PtIDs,
         			"Tab": "ClinicalTable",
         			"Settings": "None"
         		}
         
         root.x0 = height / 2;
         root.y0 = 0;
             	
         function toggleAll(d) {
           if (d.children) {
             d.children.forEach(toggleAll);
             toggle(d);
           }
         }
         
       InitialLoad = false;
       updateSavedSelection(root); 
       CurrentSelection = root;
       SelectionNames.push(root.name);
  
       console.log("root: ", root)
      
 //      testingAddSavedSelection()
       
     }     
  
//--------------------------------------------------------------------------------------------
 //    function HandleWindowResize(){
 //         Display.width($(window).width() * 0.95);
 //         Display.height($(window).height() * 0.80);
 //         if(!InitialLoad) {updateSavedSelection(root);}
 //    };
  
//----------------------------------------------------------------------------------------------------
     
       return{
     
        init: function(){
           onReadyFunctions.push(initializeSelectionUI);
           addJavascriptMessageHandler("SetupSavedSelectionTree", SetupSavedSelectionTree);
 		   addJavascriptMessageHandler("addSelectionToTree", addSavedSelection);
          socketConnectedFunctions.push(loadPatientData);
           }
        };
     
}); // SavedSelectionModule
 

//----------------------------------------------------------------------------------------------------
SavedSelection = SavedSelectionModule();
SavedSelection.init();

</script>
<script>
onReadyFunctions.push(function() {
    console.log("====== tabapps document ready");
    window.tabsAppRunning = true
    $("#tabs").tabs({
         // todo: distinguish between tabs, only do needed resets
       activate: function(event, ui) {
            console.log("tabs.activate");
            console.log(" ==== tab.activate, tableRef.fnAdjustColumnSizing");
            var tableRef = $("#clinicalTable").dataTable();
            if (tableRef.length > 0) {
               tableRef.fnAdjustColumnSizing();
              } // if
            console.log(" ==== tab.activate, possible cyjs resize and fit");
            if(typeof(cwMarkers) != "undefined") {
               cwMarkers.resize(); 
               cwMarkers.fit(50);
               }
            if(typeof(cwGBM) != "undefined") {
                cwGBM.resize();
                cwGBM.fit(50);
                }
            if(typeof(cwAngio) != "undefined") {
                cwAngio.resize();
                cwAngio.fit(50);
                }
            } // activate
        }); // tabs
    });  // ready

</script>


<script>
//----------------------------------------------------------------------------------------------------
var todoModule = (function () {

var ToDoURL = "https://docs.google.com/spreadsheets/d/1Rqqpma1M8aF5bX4BM2cYYgDd5hazUysqzCxLhGUwldo/edit?usp=sharing"
var ToDobutton;

initializeUI = function(){
    ToDobutton = $("#ToDoLink");
    ToDobutton.on("click",function(d){window.open(ToDoURL) }   )
    };


return{

   init: function(){
      onReadyFunctions.push(initializeUI);
      }
   };

}); // DateAndTimeModule
//----------------------------------------------------------------------------------------------------
todo = todoModule();
todo.init();

</script>

<div id="tabs">
   <ul>
     <li><a href="#DashboardDiv">Dashboard</a></li>
     <li><a href="#clinicalDataModuleDiv">Clinical Data</a></li>
     <li><a href="#pcaDiv">PCA</a></li>
     <li><a href="#patientTimeLinesDiv">Timelines</a></li>
     <li><a href="#SavedSelectionDiv">Saved Selection</a></li>
     <li><a href="#todoDiv">Todo</a></li>
   </ul>

<style>
ul.UserDocs {
    list-style-type: circle;
}
</style>


<div id="DashboardDiv">
<h3> Oncoscape </h3>
   <p> Welcome to Oncoscape! </p>
   <p> This page will include:</p>
   <ul class="UserDocs">
     <li> a welcome message</li>
     <li> links to download vignettes </li>
     <li> Explanation of available data </li>
     <li> Tooltips/Tutorial </li>
     <li> link to download/install software </li>
   </ul>
</div>

<style>

.domain { 
  fill: none; 
  } 


.extent {
  fill-opacity: .1;
  stroke: #f00;
}


.axis path, .axis line {
    stroke: black;
    stroke-width: 1px;
    }

#pcaDiv {
   margin: 0px;
   padding: 0px;
   }

#pcaDisplay {
   border: 1px solid #aaa;
   width: 50px;
   height: 50px;
   background-color: #FAFAFA;
   margin-top: 1px;
   margin-left: 3px;
   margin-right: 0;
   margin-bottom: 1px;
   padding: 1px;
   padding-bottom: 0px;
   }

#pcaBroadcastSelectionToClinicalTable{
   font-size: 10pt;
   }

</style>

<div id="pcaDiv">
   <button id="pcaBroadcastSelectionToClinicalTable">To Clinical Data... </button>
   <div id="pcaDisplay"></div>
</div>

<style>


#clinicalDataTableDiv {
   min-width: 900px;
   margin: 0 auto;
   background-color: #E8E8E8;
   font-family: sans-serif;
   font-size: 14px;
   }

#oldclinicalDataTableDiv {
   border: 1px solid #aaa;
   height: 500px;
   font-family: sans-serif;
   background-color: #E8E8E8;
   font-size: 12px;
   margin-top: 1px;
   margin-left: 10px;
   margin-right: 10px;
   margin-bottom: 1px;
   padding: 1px;
   padding-bottom: 20px;
   }

th, td { white-space: nowrap; } 



#compactViewButton{
   margin-left: 40px;
   }


#clinicalDataTableControlsDiv {
   border: 1px solid #ccc;
   font-family: sans-serif;
   font-size: 12px;
   margin-top: 2px;
   margin-left: 10px;
   margin-right: 10px;
   margin-bottom: 5px;
   background-color: #E8E8E8;
   }

#clinicalTablesButtonsDiv{
   padding-left: 20px;
   padding-bottom: 5px;
   }

#clinicalDataTableFilterControlsDiv{
   font-family: sans-serif;
   font-size: 14px;
   margin-top: 40px;
   margin-left: 100px;
   margin-right: 100px;
   margin-bottom: 20px;
   }

#clinicalDataTableOutboundButtonDiv{
   margin-left: 240px;
   }

.clinicalDataFilterSlider { 
   margin-left:20px; 
   margin-right:5px; 
   margin-top:0px;
   border: 1px solid #FFF;
   height: 20px;
   max: 0;  min: 10; 
   orientation: 'horizontal';
   background-color: #FFF;
   color: #00F;
   }

.clinicalDataFilterSliderReadout {
  font-family:"Courier";
  color: #0000FF;
  background-color: #FFF;
  font-size: 14px;
  border: 1px solid #DDD;
  width: 20px;
  height: 16px;
  resize: none;
  margin-top: 4px;
  margin-left: 2px;
  }

.clinicalDataFilterSliderTitleDiv {
  font-family:"Arial";
  color: #000000;
  font-size: 14px;
  padding-top: 10px;
  padding-left: 40px;
  }

.tblClinicalControlButton {
   margin-bottom: 2px;
   }




</style>


<div id="clinicalDataModuleDiv">
   <div id="clinicalDataTableControlsDiv">
      <div id=clinicalDataTableFilterControlsDiv" style="border: 1px;">

       <div id="slider1Div" style="display: inline-block">
           <div id="sliderTitleDiv" class="clinicalDataFilterSliderTitleDiv" style="margin-left: 10px;">ageAtDx min</div>
           <div style="width: 200px; overflow: hidden;">
               <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="ageAtDxMinSlider" class="clinicalDataFilterSlider"></div>
               <div style="margin-left: 20px;" id='msgBox'>  
                  <textarea id="ageAtDxMinSliderReadout" readonly class="clinicalDataFilterSliderReadout"'></textarea> 
               </div>
           </div>
        </div>

       <div id="slider2Div" style="display: inline-block">
           <div id="sliderTitleDiv"  class="clinicalDataFilterSliderTitleDiv" style="margin-left: 10px;">ageAtDx max</div>
           <div style="width: 300px; overflow: hidden;">
               <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="ageAtDxMaxSlider" class="clinicalDataFilterSlider"></div>
               <div style="margin-left: 20px;" id='msgBox'>  
                  <textarea id="ageAtDxMaxSliderReadout" readonly class="clinicalDataFilterSliderReadout"'></textarea> 
               </div>
           </div>
        </div>

       <div id="slider3Div" style="display: inline-block">
           <div id="sliderTitle3Div" class="clinicalDataFilterSliderTitleDiv" style="margin-left: 10px;">survival min</div>
           <div style="width: 200px; overflow: hidden;">
               <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="overallSurvivalMinSlider" class="clinicalDataFilterSlider"></div>
               <div style="margin-left: 20px;" id='msgBox'>  
                  <textarea id="overallSurvivalMinSliderReadout" readonly class="clinicalDataFilterSliderReadout"'></textarea> 
               </div>
           </div>
        </div>

       <div id="slider4Div" style="display: inline-block">
           <div id="sliderTitle4Div" class="clinicalDataFilterSliderTitleDiv" style="margin-left: 10px;">survival max</div>
           <div style="width: 200px; overflow: hidden;">
               <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="overallSurvivalMaxSlider" class="clinicalDataFilterSlider"></div>
               <div style="margin-left: 20px;" id='msgBox'>  
                  <textarea id="overallSurvivalMaxSliderReadout" readonly class="clinicalDataFilterSliderReadout"'></textarea> 
               </div>
           </div>
        </div>

       <div id="clinicalTablesButtonsDiv" style="display: block">
           <div id="sliderApplyDiv" style="display: inline-block">
              <button id="applyClinicalTablesFiltersSlidersButton" class="tblClinicalControlButton" type="button">Apply Filters</button>
           </div>
           <div id="viewButtonDiv" style="display: inline-block">
              <button id="showAllClinicalTablesRowsButton" class="tblClinicalControlButton" type="button">Remove Filters</button>
              <!-- button id="toggleMoreFewerColumnsButton" class="tblClinicalControlButton" type="button">More Columns</button -->
           </div>

          <div id="clinicalDataTableOutboundButtonDiv" style="display: inline-block">
             <button id="toMarkersAndTissuesButton" class="tblClinicalControlButton" type="button">Markers &amp; Tissues</button>
             <button id="toGBMPathwaysButton" class="tblClinicalControlButton" type="button">GBM Pathways</button>
             <button id="toPCAButton" class="tblClinicalControlButton" type="button">PCA</button>
             <button id="toSurvivalStatsButton" class="tblClinicalControlButton" type="button">Survival</button>
             <button id="toTimeLinesButton" class="tblClinicalControlButton" type="button">Timelines</button>
          </div>
       </div>

    </div>
   </div>
   <div id="clinicalDataTableDiv"></div>
</div>
<style>

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.select{
	background-color: white;
}
.button{
	background-color: white;
	border-radius: 0 0 5px 5px; 
	border-style: none solid solid; 
	border-width: 0 1px 1px;

}
.resizable {
    resize: both;   /* Options: horizontal, vertical, both */
    overflow: auto; /* fix for Safari */
}

.domain { 
  fill: none; 
  } 



</style>

<canvas width="960" height="500" style="display:none"></canvas>

<div id="patientTimeLinesDiv">
	<div id="ArrangeDataDiv">
	     <span id="AddSideBar">Features: </span>
	     <span id="AlignByDiv">Align By: </span>
	     <span id="OrderByDiv">Order By: </span>
<!--	     <button id="SaveImageDiv">Save Image </button>  -->
       	 <button id="SendSelectionToClinicalTable">To Clinical Data... </button>
     </div>
     <div id="TimeLineDisplay">
     <span id="SideBarPlot" class="resizeable"></span>
     <span id="patientTimeLinesDisplay" class="resizeable"></span>
     </div>
     
     <div id="AddCalculatedEvent"  style="display:none">
     <form>
          <label for="Name">Name</label>
          <input type="text" id="Name" value="e.g. Survival"><br>
          <label for="Event1">Event 1</label>
          <input type="text" id="Event1" value="(legend)"><br>
          <label for="Event2">Event 2</label>
          <input type="text" id="Event2" value="(legend)"><br>
          <label for="TimeScale"> Time Scale</label>
          <input type="text" id="TimeScale" value="Days, Months, Years"><br>
	</form>
     </div>
</div>


<style>
.node circle {
  cursor: pointer;
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.node text {
  font-size: 11px;
}

path.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}
</style>


  <div id="SavedSelectionDiv">
     <div id="SavedSelectionTreeDiv"></div>
  <div id="SelectionBanner">
    <div id="Acknowledgement">Created by Lisa McFerrin</div>
    <script language="Javascript">
		document.write("This page was last modified on: " + document.lastModified +"");
	</script>
  </div>

  </div>
  
 

<div id="todoDiv">
<h3> google doc test </h3>
   <button id=ToDoLink>Edit The Table</button>
   <iframe
      height="600px",
      width="95%",
      src="https://docs.google.com/spreadsheets/d/1Rqqpma1M8aF5bX4BM2cYYgDd5hazUysqzCxLhGUwldo/pubhtml;headers=false">  
   </iframe>
</div>

</div>


<script>
</script>

</body>
</html>

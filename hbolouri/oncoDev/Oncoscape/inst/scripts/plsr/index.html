<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://s3.amazonaws.com/oncoscape/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape.js-qtip.js"></script>
   <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">

	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string) 
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
// if jQuery-style tabs are in use with Oncoscape, this function raised the named tab to the
// the front (visible) position in the tabset
// the argument, "tabIDString" is the tab id used in the module's widget.html, reproduced exactly
// in tabsApp/widget.html, with some current examples being
//  pcaDiv, patientTimeLinesDiv, gbmPathwaysDiv
function raiseTab(tabIDString)
{
  tabsWidget = $("#oncoscapeTabs");
  if(tabsWidget.length > 0){
     selectionString = '#oncoscapeTabs a[href="#' + tabIDString + '"]';
     tabIndex = $(selectionString).parent().JAVASCRIPT_INDEX ();
     tabsWidget.tabs( "option", "active", tabIndex);
     } // if tabs exist

} // raiseTab
//----------------------------------------------------------------------------------------------------
// from http://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
function openCenteredBrowserWindow(url, title, w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

    width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);

    if (window.focus) {
       newWindow.focus();
       }

} // openCenteredBrowserWindow
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
// the nginx proxy server, used by fhcrc IT for the publicly-visible version of Oncoscape
// times out web sockets at 90 seconds.
// this function, when called more often that that, will keep the websocket open.
keepAlive = function()
{   
    console.log("keep alive"); 
    msg = {cmd: "keepAlive", callback: "", status:"request", payload:""}
    socket.send(JSON.stringify(msg));

} // keepAlive
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined") {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
        setInterval(keepAlive, 30000);
        }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------


</script>

<script>
var ActiveModules = {};

//----------------------------------------------------------------------------------------------------
addSelectionDestination = function(modulename, modulediv)
{
   if(modulename in ActiveModules){
        alert("Selection Destination message handler for '" + modulediv +": "+ modulename + " already set");
   } else{  ActiveModules[modulename] = modulediv  }
}

//----------------------------------------------------------------------------------------------------
getSelectionDestinations = function(){
    var keys = [];
    for(var k in ActiveModules) keys.push(k);
    return keys;
//   return tissueMenu.children().map(function() {return $(this).val();}).get();
}

 //--------------------------------------------------------------------------------------------
   function validSelectionToSend(modulename, ids){
       if(modulename == "PCA") 
          return checkBeforeSendSelectionsToPCA(ids)
       return true;
    }
   //--------------------------------------------------------------------------------------------
   function checkBeforeSendSelectionsToPCA(ids){
      var minimumPatientsForPCA = 8;
      if(ids.length < minimumPatientsForPCA){
         alert("Error! " + minimumPatientsForPCA + " or more patients needed to calculate PCA");
         return false;
         }
      return true;
      } // checkBeforeSendSelectionsToPCA


//--------------------------------------------------------------------------------------------
function sendSelectionToModule(moduleName, currentIDs, metadata, raiseDiv){
    
       raiseDiv = true;
       if(moduleName == "Save Selection"){
          var selectionname = PromptForSelectionName()
          if(typeof(selectionname) !== "string")  
             return;
          metadata.selectionname = selectionname;
          raiseDiv = false;
        }
    
       if(validSelectionToSend(moduleName, currentIDs)){    
          console.log(currentIDs.length + " patientIDs going to " + moduleName)    
       
          callback = moduleName + "HandlePatientIDs";    // genralize to "HandleSelectedIDs"?
          msg = {cmd:"sendIDsToModule",                  // generalize to "sendIDsToModule"?
                 callback: callback,
                 status:"request",
                 payload:{targetModule: moduleName,
                          ids: currentIDs,
                          metadata: metadata}
                 };
         socket.send(JSON.stringify(msg));

         if(raiseDiv == true)
           raiseTab(ActiveModules[moduleName])
        }
    }

</script>

 
<script>

   var currentData;    // the most recently calculated points and load vectors;
   var currentAbsoluteMaxValue; // most recent max value, used for scaling

//----------------------------------------------------------------------------------------------------
var PLSRModule = (function () {

   var plsrDisplay
   var d3plsrDisplay;

   var firstTime = true;


      // these are reported by the server, from an inspection of the data
   var ageAtDxMin, ageAtDxMax, survivalMin, survivalMax;

      // 4 sliders and their readout
   var ageAtDxMinSlider, ageAtDxMinSliderReadout;
   var ageAtDxMaxSlider, ageAtDxMaxSliderReadout;
   var survivalMinSlider, survivalMinSliderReadout;
   var survivalMaxSlider, survivalMaxSliderReadout;

      // the current values specifying the subsets
      // set as 1/3 from min and max initially, subsequently read
      // from the sliders
   var ageAtDxMinThreshold, ageAtDxMaxThreshold, survivalMinThreshold, survivalMaxThreshold;

   var calculateButton;
   //var sendSelectionMenu;
   var d3brush;
   var currentlySelectedRegion;
   var thisModuleName = "PLSR"
   var geneSetMenu;

  //--------------------------------------------------------------------------------------------
  function initializeUI () {

      plsrDisplay = $("#plsrDisplay");
      d3plsrDisplay = d3.select("#plsrDisplay");
      console.log("== intiailizeUI, plsrDisplay: " + plsrDisplay);
      console.log("== intiailizeUI, d3plsrDisplay: " + d3plsrDisplay);

      ageAtDxMinSlider = $("#plsrAgeAtDxMinSlider");
      ageAtDxMinSliderReadout = $("#plsrAgeAtDxMinSliderReadout");

      ageAtDxMaxSlider = $("#plsrAgeAtDxMaxSlider");
      ageAtDxMaxSliderReadout = $("#plsrAgeAtDxMaxSliderReadout");

      survivalMinSlider = $("#plsrSurvivalMinSlider");
      survivalMinSliderReadout = $("#plsrSurvivalMinSliderReadout");

      survivalMaxSlider = $("#plsrSurvivalMaxSlider");
      survivalMaxSliderReadout = $("#plsrSurvivalMaxSliderReadout");

      calculateButton = $("#plsrCalculateButton");
      calculateButton.button();
      calculateButton.click(requestPLSRByOnsetAndSurvival)

      geneSetMenu = $("#plsrGeneSetSelector");
      handleWindowResize();

      //clearSelectionButton = $("#plsrClearSelectionButton");
      //clearSelectionButton.button();
      //clearSelectionButton.click(clearSelection);

        // disabled (7 sep 2014) because no tabs accept gene symbols
      //sendSelectionMenu = $("#plsrSendSelectiontoModuleMenu")
      //sendSelectionMenu.change(sendSelection);
      //sendSelectionMenu.empty();

      //sendSelectionMenu.append("<option>Send Selection to:</option>")
      var destinationModules = getSelectionDestinations()
      if(destinationModules.length == 0)
         destinationModules = ["selfTest"];

      for(var i=0;i< destinationModules.length; i++){
         var module = destinationModules[i];
         if(module != thisModuleName){
            optionMarkup = "<option>" + module + "</option>";
            //sendSelectionMenu.append(optionMarkup);
            } // if not current module
         } // for i
      //sendSelectionMenu.prop("disabled",true);
      $(window).resize(handleWindowResize);
      };

   //--------------------------------------------------------------------------------------------
   function handleGeneSetNames(msg){
      newNames = msg.payload;
      addGeneSetNamesToMenu(newNames);
      } // handleGeneSetNames

   //--------------------------------------------------------------------------------------------
   function addGeneSetNamesToMenu (geneSetNames) {

      geneSetMenu.empty();
      if(geneSetNames.length == 0) {
         return;
         }
      
      for(var i=0; i < geneSetNames.length; i++){
         optionMarkup = "<option>" + geneSetNames[i] + "</option>";
         geneSetMenu.append(optionMarkup);
         } // for i

       } // addGeneSetNamesToMenu

  //--------------------------------------------------------------------------------------------
  function getAgeAtDxAndSurvialInputRanges () {
     msg = {cmd: "getAgeAtDxAndSurvivalRanges", callback: "handleAgeAtDxAndSurvivalRanges",
            status: "request", payload:""};
     msg.json = JSON.stringify(msg);
     console.log("sending cmd " + msg)
     socket.send(msg.json);
     } // getAgeAtDxAndSurvialInputRanges 

   //----------------------------------------------------------------------------------------------
   function handleAgeAtDxAndSurvivalRanges(msg) {

      console.log("==== handleAgeAtDxAndSurvivalRanges");
      console.log(msg);
      console.log(msg.payload);
      ageAtDxMin = Math.floor(msg.payload.ageAtDxLow);
      ageAtDxMax = Math.floor(msg.payload.ageAtDxHigh + 1);
      survivalMin = Math.floor(msg.payload.survivalLow);
      survivalMax = Math.floor(msg.payload.survivalHigh + 1);
      console.log("ageAtDxMin: " + ageAtDxMin);
      console.log("ageAtDxMax: " + ageAtDxMax);
      console.log("survivalMin: " + survivalMin);
      console.log("survivalMax: " + survivalMax);
      setupSliders();
      } // handleAgeAtDxAndSurvivalRanges 

   //--------------------------------------------------------------------------------------------------
   requestPLSRByOnsetAndSurvival = function() {
   

     ageAtDxMinThreshold = Number(ageAtDxMinSliderReadout.val()); 
     ageAtDxMaxThreshold = Number(ageAtDxMaxSliderReadout.val());
     survivalMinThreshold = Number(survivalMinSliderReadout.val());
     survivalMaxThreshold = Number(survivalMaxSliderReadout.val());

     console.log("=== requesting plsr, ageAtDx: " + ageAtDxMinThreshold + " - " + ageAtDxMaxThreshold);
     console.log("=== requesting plsr, survival: " + survivalMinThreshold + " - " + survivalMaxThreshold);

     var currentGeneSet = geneSetMenu.val();

     payload = {geneSet: currentGeneSet,
                ageAtDxThresholdLow: ageAtDxMinThreshold,
                ageAtDxThresholdHi:  ageAtDxMaxThreshold,
                overallSurvivalThresholdLow: survivalMinThreshold,
                overallSurvivalThresholdHi: survivalMaxThreshold};
   
      payload = JSON.stringify(payload)
      msg = {cmd: "calculatePLSR", callback: "handlePlsrResults", status: "request", payload: payload}
      msg.json = JSON.stringify(msg);
      console.log(msg.json)
      socket.send(msg.json);
      }  // requestPLSRByOnsetAndSurvival


   //--------------------------------------------------------------------------------------------------
   function setupSliders() {

      var ageAtDxSpan = ageAtDxMax - ageAtDxMin;
      var survivalSpan = survivalMax - survivalMin;

      ageAtDxMinThreshold = Math.floor(ageAtDxMin + (ageAtDxSpan/3));
      ageAtDxMaxThreshold = Math.floor(1 + ageAtDxMax - (ageAtDxSpan/3));
      survivalMinThreshold = survivalMin + (survivalSpan/3);
      survivalMaxThreshold = survivalMax - (survivalSpan/3);
    
      ageAtDxMinSlider.slider({
         slide: function(event, ui) {
            ageAtDxMin = Number(ui.value);
            ageAtDxMinSliderReadout.text (ui.value);
            },
         min: ageAtDxMin,
         max: ageAtDxMax,
         value: ageAtDxMinThreshold.toFixed(1)
         });
        ageAtDxMinSliderReadout.text(ageAtDxMinThreshold);
  
      ageAtDxMaxSlider.slider({
         slide: function(event, ui) {
            ageAtDxMax = Number(ui.value);
            ageAtDxMaxSliderReadout.text (ui.value)
            },
         min: ageAtDxMin,
         max: ageAtDxMax,
         value: ageAtDxMaxThreshold.toFixed(1)
         });
        ageAtDxMaxSliderReadout.text(ageAtDxMaxThreshold);
  
      survivalMinSlider.slider({
         slide: function(event, ui) {
            survivalMin = ui.value;
            currentValueFormattedString = survivalMin.toFixed(1)
            survivalMinSliderReadout.text(currentValueFormattedString);
            },
         min: survivalMin,
         max: survivalMax,
         step: 0.1,
         value: survivalMinThreshold.toFixed(1)
         });

      survivalMinSliderReadout.text(survivalMinThreshold.toFixed(1));
  
      survivalMaxSlider.slider({
         slide: function(event, ui){
            survivalMax = ui.value;
            currentValueFormattedString = survivalMax.toFixed(1)
            survivalMaxSliderReadout.text(currentValueFormattedString);
            },
         min: survivalMin,
         max: survivalMax,
         step: 0.1,
         value: survivalMaxThreshold.toFixed(1)
         });

      survivalMaxSliderReadout.text(survivalMaxThreshold.toFixed(1));
      } // setupSliders

   //--------------------------------------------------------------------------------------------------
   function handlePlsrResults (msg){

      console.log("=== handlePlsrResults");

      firstTime = false;
      if(msg.status == "error"){
         alert(msg.payload);
         return;
         }
   
        //todo: investigate why labkey is returning array[1] for properties in some cases
        //flattenArrays will not affect JSON without array[1] members
     
      var genes = JSON.parse(msg.payload.genes);
      for (var i = 0; i < genes.length; i++)
          flattenArrays(genes[i]);
      console.log(genes[0]);
   
      var vectors = JSON.parse(msg.payload.vectors);
      for (var i = 0; i < vectors.length; i++)
           flattenArrays(vectors[i]);
      console.log(vectors[0]);
   
         // R figures out the largest absolute value in vectors + genes
         // so that the d3 plot can be easily scaled
      var absMaxValue = msg.payload.absMaxValue

      // genes = genes.slice(1,8);
      allObjs = genes.concat(vectors);
      currentData = allObjs;    // the most recently calculated points and load vectors;
      currentAbsoluteMaxValue = absMaxValue; // most recent max value, used for scaling

   
      console.log("=== calling d3PlsrscatterPlot");
      svg = d3PlsrScatterPlot(allObjs, absMaxValue);

      } // handlePlsrResults

   //--------------------------------------------------------------------------------------------
   function d3PlotBrushReader () {

     console.log("=== plsr d3PlotBrushReader");
     currentlySelectedRegion = d3brush.extent();
     x0 = currentlySelectedRegion[0][0];
     x1 = currentlySelectedRegion[1][0];
     width = Math.abs(x0-x1);
     console.log("width: " + width);
     selectedIDs = identifyEntitiesInCurrentSelection();
     //sendSelectionMenu.prop("disabled", true);
     //if(selectedIDs.length > 0) 
     //   sendSelectionMenu.prop("disabled", false);
     }; // d3PlotBrushReader

  //-------------------------------------------------------------------------------------------
   function d3PlsrScatterPlot(dataset, absMaxValue) {

      var padding = 70;
      var width = plsrDisplay.width();
      var height = plsrDisplay.height();

      d3plsrDisplay.select("#plsrSVG").remove();  // so that append("svg") is not cumulative
   
      geneDataset = dataset.filter(function(x) {return(x.category=="gene")});
      vectorDataset = dataset.filter(function(x) {return(x.category=="vector")});
   
      window.plsrGeneDataset = geneDataset
      console.log("==== genes: " + geneDataset.length);
      console.log("==== vectors: " + vectorDataset.length);

      absMaxValue = 1.2 * absMaxValue
      var negAbsMaxValue = -1.0 * absMaxValue
   
      var xScale = d3.scale.linear()
                     .domain([negAbsMaxValue, absMaxValue])
                     .range([padding, width - padding * 2]);
   
      var yScale = d3.scale.linear()
                     .domain([negAbsMaxValue, absMaxValue])
                     .range([height - padding, padding]); // note inversion 
   
      var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .ticks(5);
   
      var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .ticks(5);
   
      d3brush = d3.svg.brush()
                      .x(xScale)
                      .y(yScale)
                      .on("brushend", d3PlotBrushReader);
   
     //function brushend() {
     // console.log("brushend");
     // selectedRegion = d3brush.extent()
     //  } ;// brushend
   
   
      function transform(d) {
         return "translate(" + xScale(d.Comp1) + "," + yScale(d.Comp2) + ")";
         }; //transform
   
      var assignColor = d3.scale.ordinal()
                                .domain(["gene",     "vector"])
                                .range(["gray",      "red"]);
   
      var svg = d3plsrDisplay.append("svg")
                  .attr("id", "plsrSVG")
                  .attr("width", width)
                  .attr("height", height)
                  .call(d3brush);
                  //.append("g");
                  //.attr("transform", "translate(" + padding + "," + padding + ")");
   
      //svg.append("g")
      //   .attr("class", "brush")
      //   .call(d3brush);
    
       var tooltip = d3plsrDisplay.append("div")
                                  .attr("class", "tooltip")
                                  .style("position", "absolute")
                                  .style("z-index", "10")
                                  .style("visibility", "hidden")
                                  .text("a simple tooltip");
   
           // draw the genes
        console.log("=== drawing genes: " + geneDataset.length);

        var circle= svg.selectAll("circle")
          .data(geneDataset)
          .enter()
          .append("circle")
          .attr("cx", function(d,i) {return xScale(d["Comp 1"]);})
          .attr("cy", function(d,i) {return yScale(d["Comp 2"]);})
          .attr("r",  function(d) {
              //console.log("appending gene circle: " + d.rowname); 
              return 2;})
          .text(function(d) {
              return(d.rowname);
              })
          .style("fill", function(d) { return assignColor(d.category); })
          .on("mouseover", function(d,i){
              tooltip.text(d.rowname);
              return tooltip.style("visibility", "visible");
              })
          .on("mousemove", function(){return tooltip.style("top",
              (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
          .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
          //.attr("transform", transform);
   
            //-----------------------
            // draw the vectors
            //-----------------------
      console.log("=== drawing vectors: " + vectorDataset.length);

      var line = svg.selectAll("line")
                     .data(vectorDataset)
                     .enter().append("line")
                                .attr("class", "line")
                                .style("stroke-width", 1)
                        .style("stroke", "red")
                        .attr("x1", xScale(0))
                        .attr("y1", yScale(0))
                        .attr("x2", function(v) { return xScale(v.x); })
                        .attr("y2", function(v) { return yScale(v.y); });
      var text = svg.selectAll("text")
                    .data(vectorDataset)
                    .enter().append("text")
                            .attr("class", "text")
                            .attr("x", function(v) { return xScale(v.x); })
                            .attr("y", function(v) { return yScale(v.y); })
                            .text( function(v) {return v.rowname})
                            .attr("text-anchor", "middle")
                            .style("fill", "black") ;
                                                    
        return(svg)

        } // d3PlsrScatterPlot

  //--------------------------------------------------------------------------------------------
  function getPatientClassification (){
     payload = "";
     msg = {cmd: "getPatientClassification", callback: "handlePatientClassification", 
            status: "request", payload: payload};
     socket.send(JSON.stringify(msg));
     };

  //--------------------------------------------------------------------------------------------
  function handlePatientClassification (msg){
     console.log("=== handlePatientClassification");
     //console.log(msg)
     if(msg.status == "success"){
        patientClassification = JSON.parse(msg.payload)
        console.log("got classification, length " + patientClassification.length);
        }
     else{
       alert("error!" + msg.payload)
       }
      }; // handlePatientIDs

  //--------------------------------------------------------------------------------------------
  function handleWindowResize () {
     console.log("=== Module.plsr handleWindowResize");
     plsrDisplay.width($(window).width() * 0.99);
     plsrDisplay.height($(window).height() * 0.80);
     if(!firstTime)
       d3PlsrScatterPlot(currentData, currentAbsoluteMaxValue);
     };

   //--------------------------------------------------------------------------------------------
   function sendSelection() {
      ids = identifyEntitiesInCurrentSelection()
      //destinationModule = sendSelectionMenu.val();
      console.log("=== sendSelection to '" + destinationModule + "': " + ids.length)
      if(ids.length > 0) {
        if(destinationModule == "Send Selection to:")
          return;
        if(destinationModule == "selfTest")
           console.log("selfTest selection destination, id count: " + ids.length + ": " + ids);
        else
           sendSelectionToModule(destinationModule, ids, {}, true);
        } // if ids
    } // sendSelectionToModule


   //--------------------------------------------------------------------------------------------
   identifyEntitiesInCurrentSelection = function(){
      console.log("identifyEntitiesInCurrentSelection: " + currentlySelectedRegion);
      x1 = currentlySelectedRegion[0][0];
      y1 = currentlySelectedRegion[0][1];
      x2 = currentlySelectedRegion[1][0];
      y2 = currentlySelectedRegion[1][1];
      ids = [];
      for(var i=0; i < currentData.length; i++){
         point = currentData[i];
         if(point.category >= "gene"){
           x = point[["Comp 1"]];
           y = point[["Comp 2"]];
           geneSymbol = point.rowname;
           if(x >= x1 & x <= x2 & y >= y1 & y <= y2)         
             ids.push(geneSymbol);
           } // if gene
         } // for i
      return(ids);
      //sendSelectionMenu.prop("disabled", true);  // default value
      if(ids.length > 0){
         console.log(" selected ids: " + ids);
         //sendSelectionMenu.prop("disabled", false);
         //destinationModule = sendSelectionMenu.val();
         //sendSelectionToModule(destinationModule, ids, {}, true);
         //sendIDsToModule(ids, "PatientHistory", "HandlePatientIDs");
         }
       
      }; // identifyEntitiesInCurrentSelection

  //--------------------------------------------------------------------------------------------
  function requestGeneSetNames(){
     callback = "handleGeneSetNames"
     msg = {cmd:"get_geneset_names",
            callback: callback,
            status:"request",
            payload:""}
     socket.send(JSON.stringify(msg));
     } // requestGeneSetNames

  //--------------------------------------------------------------------------------------------
  function sendIDsToModule (ids, moduleName, title){
       callback = moduleName + title;
       msg = {cmd:"sendIDsToModule",
              callback: callback,
              status:"request",
              payload:{targetModule: moduleName,
                       ids: ids}
             };
      socket.send(JSON.stringify(msg));
      } // sendTissueIDsToModule


  //--------------------------------------------------------------------------------------------
  return{
   init: function(){
      onReadyFunctions.push(initializeUI);
      addJavascriptMessageHandler("handleGeneSetNames", handleGeneSetNames);
      addJavascriptMessageHandler("handlePlsrResults", handlePlsrResults);
      //addJavascriptMessageHandler("tissueIDsForPLSR", plsrHandleIncomingTissueIDList);
      //addJavascriptMessageHandler('ageAtDxAndSurvivalRanges', handleAgeAtDxAndSurvivalRanges);
      addJavascriptMessageHandler("handleAgeAtDxAndSurvivalRanges", handleAgeAtDxAndSurvivalRanges);
      socketConnectedFunctions.push(getAgeAtDxAndSurvialInputRanges);
      socketConnectedFunctions.push(requestGeneSetNames);
      }
   };

}); // PLSRModule
//----------------------------------------------------------------------------------------------------
plsr = PLSRModule();
plsr.init();

</script>

<body>
<style>

.ui-button .ui-button-text {font-size:10pt !important;}

.domain { 
  fill: none; 
  } 

.extent {
  fill-opacity: .1;
  stroke: #f00;
}


.axis path, .axis line {
    stroke: black;
    stroke-width: 1px;
    }

#plsrDiv{
   border: 1px solid #000;
}

#plsrControlsDiv {
   border: 1px solid #aaa;
   //border: 5px solid #aaa;
   font-family: sans-serif;
   font-size: 12px;
   margin-top: 2px;
   margin-left: 5px;
   margin-right: 10px;
   margin-bottom: 5px;
   background-color: #E8E8E8;
   }

#plsrFilterControlsDiv {
   font-family: sans-serif;
   font-size: 14px;
   margin-top: 1px;
   margin-left: 5px;
   margin-right: 50px;
   margin-bottom: 5px;
   }

#plsrPlotDiv {
   border-style: solid;
   border-width: 1px;
   width: 800px;
   height: 500px;
   margin: 5px;
   }


.plsrSlider { 
   margin-left:20px; 
   margin-right:5px; 
   margin-top:0px;
   border: 3px solid #FFF;
   height: 20px;
   max: 0;  min: 10; 
   orientation: 'horizontal';
   }

.plsrSliderReadout {
  font-family:"Courier";
  color: #00F;
  background-color: #FFF;
  font-size: 12px;
  border: 2px solid #DDD;
  width: 30px;
  height: 15px;
  resize: none;
  margin-top: 5px;
  margin-left: 1px;
  }

.plsrSliderTitleDiv {
  font-family:"Arial";
  color: #000000;
  font-size: 14px;
  padding-top: 10px;
  padding-left: 40px;
  }


#plsrButtonDiv {
   padding-botton: 30px;
   }


</style>


<div id="plsrDiv">
    <div id="plsrControlsDiv">
          <div id="plsrFilterControlsDiv">

                             <!--    slider #1, for ageAtDxMin -->

              <div id="plsrSlider1Div" style="display: inline-block">
                  <div id="plsrSlider1TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">Low Age at Dx</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrAgeAtDxMinSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox1'>  
                               <textarea id="plsrAgeAtDxMinSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>



                             <!--    slider #2, for ageAtDxMax -->

              <div id="plsrSlider2Div" style="display: inline-block">
                  <div id="plsrSlider2TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">High Age at Dx</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrAgeAtDxMaxSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox2'>  
                               <textarea id="plsrAgeAtDxMaxSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>


                             <!--    slider #3, for overallSurvivalMin -->

              <div id="plsrSlider3Div" style="display: inline-block">
                  <div id="plsrSlider3TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">Low Survival</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrSurvivalMinSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox3'>  
                               <textarea id="plsrSurvivalMinSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>


                             <!--    slider #4, for overallSurvivalMax -->

              <div id="plsrSlider4Div" style="display: inline-block">
                  <div id="plsrSlider4TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">High Survival</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrSurvivalMaxSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox4'>  
                               <textarea id="plsrSurvivalMaxSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>

              <div id="plsrButtonDiv" style="display: inline-block">
                 <button id="plsrCalculateButton" type="button">Calculate</button>
                 <!-- select id="plsrSendSelectiontoModuleMenu"></select -->
                 <select id="plsrGeneSetSelector"></select>
              </div>



          </div>
    </div>

    <div id="plsrDisplay" style="margin-top:0"></div>
</div>

</body>
</html>

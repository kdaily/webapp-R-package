<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> Oncoscape </title>
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery-2.1.0.min.js"></script>
   <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
   <link   rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape-2.2.9.min.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://s3.amazonaws.com/oncoscape/fonts/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
   <link   href="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/d3.min.js"></script>

   <script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colreorder/1.1.0/css/dataTables.colReorder.min.css"></script>

   <!-- img src="//cdn.datatables.net/colreorder/1.1.0/images/insert.png" -->
   <script src="//cdn.datatables.net/colreorder/1.1.0/js/dataTables.colReorder.min.js"></script>
   <script src="//cdn.datatables.net/colvis/1.1.0/js/dataTables.colVis.min.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css"></script>

   <script src="http://s3.amazonaws.com/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/js/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://s3.amazonaws.com/oncoscape/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://s3.amazonaws.com/oncoscape/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
   <script src="http://s3.amazonaws.com/oncoscape/js/cytoscape.js-qtip.js"></script>
   <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">

	 

<script>

</script>
</head>


<script>
var socket;
var dispatchOptions = {};
var socketConnectedFunctions = [];
var onReadyFunctions = [];

//
// Do not modify the following line.  If Oncoscape is launched from LabKey then a new labkey javascript
// object will be created with members {.mode, .reportSession, .filteredPatients}
//
//var labkey = {labkeyOncoscape};

var filteredPatients = [];
//----------------------------------------------------------------------------------------------------
addJavascriptMessageHandler = function(cmd, func)
{
   if(cmd in dispatchOptions){
      alert("javascript message handler for '" +  cmd + " already set");
      }
   else{
      dispatchOptions[cmd] = func
      }
}
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string) 
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
// from http://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
function openCenteredBrowserWindow(url, title, w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

    width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);

    if (window.focus) {
       newWindow.focus();
       }

} // openCenteredBrowserWindow
//----------------------------------------------------------------------------------------------------
dispatchMessage = function(msg)
{
   console.log("--- webapp, index.common, dispatchMessage: " + msg.cmd);

   if (dispatchOptions[msg.cmd])
       dispatchOptions[msg.cmd](msg)
   else
      console.log("unrecognized socket request: " + msg.cmd);
} 
//--------------------------------------------------------------------------------------------------
setupSocket = function (socket)
{
  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } 
     socket.onmessage = function got_packet(msg) {
        msg = JSON.parse(msg.data)
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg)
        } // socket.onmessage, got_packet
     socket.onclose = function(){
        //$("#status").text(msg.cmd)
        console.log("socket closing");
        } // socket.onclose
    } // try
  catch(exception) {
    $("#status").text("Error: " + exception);
    }

} // setupSocket
//----------------------------------------------------------------------------------------------------
function invokeSuccess(r)
{
    socket.rserveExecuting = false;

    if (r.errors.length > 0)
    {
        for (var i=0; i < r.errors.length; i++)
        {
        $("#status").text("Error: " + r.errors[i]);
        }
    }
    else
    if (r.outputParams.length > 0)
    {
        // note that LabKey has handled the JSON parsing already
        var msg = r.outputParams[0].value;
        console.log("index.common onmessage sees " + msg.cmd);
        dispatchMessage(msg);
    }

    //
    // call the next pending command if available
    //
    if (socket.rservePendingCommands.length > 0)
    {
        // note that M4 macro language uses 'shift' so quote it below
        executeRserveCommand(socket.rservePendingCommands.shift());
    }
}
//----------------------------------------------------------------------------------------------------
function invokeFailure(error)
{
    $("#status").text("Error: " + error.exception);
}
//----------------------------------------------------------------------------------------------------
function executeRserveCommand(data)
{
    if (socket.rserveExecuting)
    {
        //
        // put this command on our pending list and execute when the server has responded.
        //

        //console.log("in executeRserveCommand - pending:" + data);
        socket.rservePendingCommands.push(data);
    }
    else
    {
        //
        // execute immediately
        //
        socket.rserveExecuting = true;

        //console.log("in executeRserveCommand - executing:" + data);
        LABKEY.Report.execute( {
            success: invokeSuccess,
            failure: invokeFailure,
            script : 'invokeCommand',
            reportSessionId : socket.rserveSession,
            inputParams : { DATA : data }
        });
    }
}
//----------------------------------------------------------------------------------------------------
// todo: investigate why json returned by LabKey is creating array[1] in some cases.
// both JSON.parse and the LabKey util decode function do this
//----------------------------------------------------------------------------------------------------
function flattenArrays(d)
{
    for (var key in d)
    {
        if (d.hasOwnProperty(key))
        {
            var val = d[key];
            if ((val instanceof Array) && val.length == 1)
            {
                d[key] = val[0];
            }
        }
    }
}
//----------------------------------------------------------------------------------------------------
setupLabKey = function(socket)
{
    // replace socket send for LabKey
    socket.send = executeRserveCommand;
    socket.rservePendingCommands = [];
    socket.rserveExecuting = false;
    socket.rserveSession = labkey.reportSession;
    console.log("rserveSession:  " + labkey.reportSession);

    // kick off init functions
    for(var f=0; f < socketConnectedFunctions.length; f++)
    {
        console.log("calling the next sockectConnectedFunction");
        socketConnectedFunctions[f]();
    }
}

function setupFilteredPatients()
{
    if (typeof labkey != "undefined" && labkey.filteredPatients)
    {
        filteredPatients = labkey.filteredPatients.split(';');
        console.log("==== filteredPatients: " + filteredPatients.length)
    }
}
//--------------------------------------------------------------------------------------------------
$(document).ready(function()
{
    console.log("==== index.common document.ready #1");

    for (var f = 0; f < onReadyFunctions.length; f++)
    {
        console.log("calling on ready function");
        onReadyFunctions[f]();
    }

    //
    // labkeyMode has three states:
    // undefined - labkey not involved
    // labkeyWS - labkey launched Oncoscape; local R must be run with WS
    // labkeyRS - labkey launched oncoscape; Rserve is used
    //
    if (typeof labkey == "undefined")
    {
        socket = new WebSocket("ws://" + window.location.host);
        setupSocket(socket);
     }
    else
    if (labkey.mode == "WS")
    {
        socket = new WebSocket("ws://localhost:7777/");
        setupSocket(socket);
    }
    else
    if (labkey.mode == "RS")
    {
        socket = {};
        setupLabKey(socket);
    }
    else
    {
        console.log("unrecognized labkey.mode was provided: " + labkey.mode);
    }

    // todo: probably a better place to put this
    setupFilteredPatients();
})
//--------------------------------------------------------------------------------------------------
</script>

<script>
//--------------------------------------------------------------------------------------------------
// global variables
// 
// window.plsrSelectedTissueIDs
//--------------------------------------------------------------------------------------------------
onReadyFunctions.push(function() {
    console.log("==== plsr code.js document.ready");
    $("#requestPLSRByTimeButton").click(requestPLSRByOnsetAndSurvival);
    $("#plsrAgeAtDxMinSlider").slider({
       change: function(event, ui) {$("#plsrAgeAtDxMinSliderReadout").text (ui.value)},
       min: 19,
       max: 90,
       value: 53
       });
    $("#plsrAgeAtDxMinSliderReadout").text(53);

    $("#plsrAgeAtDxMaxSlider").slider({
       change: function(event, ui) {$("#plsrAgeAtDxMaxSliderReadout").text (ui.value)},
       min: 19,
       max: 90,
       value: 68
       });
    $("#plsrAgeAtDxMaxSliderReadout").text(68);

    $("#plsrSurvivalMinSlider").slider({
       change: function(event, ui) {$("#plsrSurvivalMinSliderReadout").text (ui.value)},
       min: 0,
       max: 74,
       value: 6
       });
    $("#plsrSurvivalMinSliderReadout").text(6);

    $("#plsrSurvivalMaxSlider").slider({
       change: function(event, ui) {$("#plsrSurvivalMaxSliderReadout").text (ui.value)},
       min: 0,
       max: 74,
       value: 60
       });
    $("#plsrSurvivalMaxSliderReadout").text(60);
    $("#plsrCalculateButton").button();
    $("#plsrCalculateButton").click(requestPLSRByOnsetAndSurvival);
    $("#plsrSendGenesButton").button();
    $("#plsrSendGenesButton").click(broadcastSelectedGenes);

    socketConnectedFunctions.push(getAgeAtDxAndSurvialInputRanges);
    socketConnectedFunctions.push(requestPLSRByOnsetAndSurvival);
    });
//--------------------------------------------------------------------------------------------------
broadcastSelectedGenes = function()
{
    console.log("selected region: " + window.selectedRegion);
    selectedGenes = [];
    genes = window.plsrGeneDataset;

    for(var i=0; i < genes.length; i++){
       x = genes[i].Comp1
       y = genes[i].Comp2
       xInBounds = (x > window.selectedRegion[0][0] && x < window.selectedRegion[1][0])
       yInBounds = (y > window.selectedRegion[0][1] && y < window.selectedRegion[1][1])
       if(xInBounds && yInBounds) {
          geneName = genes[i].rowname
          console.log("gene in selected region: " + geneName)
          selectedGenes.push(geneName);
          } // if in bounds
       } // for i

    if(selectedGenes.length == 0){
       alert("No genes selected in PLSR display");
       return;
       }

    console.log("selectedGenes.length: " + selectedGenes.length);

    if(selectedGenes.length > 0){
       msg = {cmd:"sendIDsToModule", status: "request",
              payload:{module:"NetworkCuration",
                       ids:selectedGenes}};

       msg.json = JSON.stringify(msg);
       socket.send(msg.json);
       } // if selectedGenes

} // broadcastSelectedGenes
//----------------------------------------------------------------------------------------------------
getAgeAtDxAndSurvialInputRanges = function ()
{
   msg = {cmd: "getAgeAtDxAndSurvivalRanges", status: "request", payload:""};
   msg.json = JSON.stringify(msg);
   console.log("sending cmd " + msg)
   socket.send(msg.json);

} // getAgeAtDxAndSurvialInputRanges 
//--------------------------------------------------------------------------------------------------
plsrHandleIncomingTissueIDList = function(msg)
{
   console.log("==== plsrHandleIncomingTissueIDlist");
   console.log(msg);
   console.log(msg.payload);

   tissueIDCount = msg.payload.count;
   tissueIDs = msg.payload.tissueIDs;
   console.log("count: " + tissueIDCount + "  ids: " + tissueIDs)

   if(tissueIDCount == 0) {
      alert("no tissueIDs in message sent to PLSR")
      return;
      }
   else if (tissueIDCount == 1){
      tissueIDs = [tissueIDs];
      }

   console.log("assigning window.plsrSelectedTissueIDs");
   window.plsrSelectedTissueIDs = tissueIDs;
   requestPLSRByOnsetAndSurvival();

} // plsrHandleIncomingTissueIDList 
//--------------------------------------------------------------------------------------------------
handleAgeAtDxAndSurvivalRanges = function(msg)
{
   console.log("==== handleAgeAtDxAndSurvivalRanges");
   console.log(msg);
   console.log(msg.payload);
   ageAtDxLow = msg.payload.ageAtDxLow;
   ageAtDxHigh = msg.payload.ageAtDxHigh
   survivalLow = msg.payload.survivalLow
   survivalHigh = msg.payload.survivalHigh

   console.log("ageAtDxLow: " + ageAtDxLow);
   $("#ageAtDxLowInput").text(ageAtDxLow);

} // handleAgeAtDxAndSurvivalRanges 
//--------------------------------------------------------------------------------------------------
// requestPLSR = function()
// {
//    samples = ["0493.T.1",        "0513.T.1",       "0525.T.2",
//               "0531.T.1",        "0547.C.1",       "0547.T.1",
//               "0576.C.1",        "0576.T.1",       "0585.T.1",
//               "0598.T.1",        "0600.C.1",       "0600.T.1"];
// 
//    samples = "ALL"
// 
//    categories = ["Neural", "Proneural", "Classical", "Mesenchymal"];
//    payload = {samples:samples, categories:categories};
// 
//    payload = JSON.stringify(payload)
//    msg = {cmd: "calculatePLSR", status: "request", payload: payload}
//    msg.json = JSON.stringify(msg);
//    console.log(msg.json)
//    socket.send(msg.json);
// 
// } // requestPCA
//--------------------------------------------------------------------------------------------------
requestPLSRByOnsetAndSurvival = function()
{
   samples = "ALL"

   if(typeof window.plsrSelectedTissueIDs == "undefined"){
      samples = "ALL";
      }
   else{
      samples = window.plsrSelectedTissueIDs
      }

   console.log("=== requesting plsr for " + samples.length + " samples");

   val1 = Number($("#plsrAgeAtDxMinSliderReadout").val())
   val2 = Number($("#plsrAgeAtDxMaxSliderReadout").val())
   val3 = Number($("#plsrSurvivalMinSliderReadout").val())
   val4 = Number($("#plsrSurvivalMaxSliderReadout").val())

   console.log(val1);
   console.log(val2);
   console.log(val3);
   console.log(val4);

   payload = {samples:samples, 
              ageAtDxThresholdLow:val1,
              ageAtDxThresholdHi:val2,
              overallSurvivalThresholdLow:val3,
              overallSurvivalThresholdHi:val4};

   payload = JSON.stringify(payload)
   msg = {cmd: "calculatePLSRActualPatientTimes", status: "request", payload: payload}
   msg.json = JSON.stringify(msg);
   console.log(msg.json)
   socket.send(msg.json);


}  // requestPLSRByOnsetAndSurvival
//--------------------------------------------------------------------------------------------------
requestPLSRByOnsetAndSurvivalDemo = function()
{
   samples = "ALL"

   payload = {samples:samples, 
              ageAtDxThresholdLow:30,
              ageAtDxThresholdHi:20,
              overallSurvivalThresholdLow:15,
              overallSurvivalThresholdHi:20};

   $("#ageAtDxLowInput").val(30)
   $("#ageAtDxHighInput").val(20)
   $("#survivalLowInput").val(15)
   $("#survivalHighInput").val(20)

   payload = JSON.stringify(payload)
   msg = {cmd: "calculatePLSRPatientTimes", status: "request", payload: payload}
   msg.json = JSON.stringify(msg);
   console.log(msg.json)
   socket.send(msg.json);

} // requestPCAByOnsetAndSurvival
//--------------------------------------------------------------------------------------------------
displayPLSRresults = function(msg) {

   console.log("displayPLSRresults 1");
   console.log(msg)
   var dataset = JSON.parse(msg.payload);

   console.log("displayPLSRresults 3");
   console.log(dataset[0]);
   console.log("displayPLSRresults 5");
   d3PlsrScatterPlot(dataset);
   console.log("displayPLSRresults 7");
   window.dataset = dataset

} // displayPLSRresults
//--------------------------------------------------------------------------------------------------
displayPLSRPatientTimesResults = function(msg) 
{

   console.log("========== displayPLSRPatientTimesResults")
   window.tmp = msg;

   if(msg.status == "error"){
      alert(msg.payload);
      return;
      }

   //todo: investigate why labkey is returning array[1] for properties in some cases
   //flattenArrays will not affect JSON without array[1] members
   var genes = JSON.parse(msg.payload.genes);
   for (var i = 0; i < genes.length; i++)
       flattenArrays(genes[i]);
   console.log(genes[0]);

   var vectors = JSON.parse(msg.payload.vectors);
   for (var i = 0; i < vectors.length; i++)
        flattenArrays(vectors[i]);
   console.log(vectors[0]);

   //genes = genes.slice(1,8);
   allObjs = genes.concat(vectors);
   window.vectors = vectors
   window.allObjs = allObjs

   console.log("=== calling d3plsrscatterPlot");
   svg = d3PlsrScatterPlot(allObjs);

} // displayPLSRPatientTimesResults
//--------------------------------------------------------------------------------------------------
d3PlsrScatterPlot = function(dataset)
{
   var padding = 50;
   var width = 800;
   var height = 500;

   d3.select("svg").remove();  // so that append("svg") is not cumulative

   geneDataset = dataset.filter(function(x) {return(x.category=="gene")});
   vectorDataset = dataset.filter(function(x) {return(x.category=="vector")});

   window.plsrGeneDataset = geneDataset
   console.log("==== genes: " + geneDataset.length);
   console.log("==== vectors: " + vectorDataset.length);

   var xScale = d3.scale.linear()
                 .domain([-1.1, 1.1])
                 .range([padding, width - padding * 2]);

   var yScale = d3.scale.linear()
                 .domain([-1.1, 1.1])
                 .range([height - padding, padding]); // note inversion 

   var xAxis = d3.svg.axis()
              .scale(xScale)
              .orient("bottom")
              .ticks(5);

   var yAxis = d3.svg.axis()
              .scale(yScale)
              .orient("left")
              .ticks(5);

   var brush = d3.svg.brush()
       .x(xScale)
       .y(yScale)
       .on("brushend", brushend);

  function brushend() {
    console.log("brushend");
    var extent = brush.extent();
    console.log("e: " + extent);
    window.selectedRegion = extent;
    } ;// brushend

  function zoom() {
      circle.attr("transform", transform);
      line.attr("x1", xScale(0))
          .attr("y1", yScale(0))
          .attr("x2", function(v) { return xScale(v.Comp1); })
          .attr("y2", function(v) { return yScale(v.Comp2); });
      text.attr("x", function(v) { return xScale(v.Comp1); })
          .attr("y", function(v) { return yScale(v.Comp2); });
     }; //zoom

   function transform(d) {
     return "translate(" + xScale(d.Comp1) + "," + yScale(d.Comp2) + ")";
     }; //transform

   var assignColor = d3.scale.ordinal()
                             .domain(["gene", "vector"])
                            .range(["blue","red"]);

   var svg = d3.select("#plsrPlotDiv")
               .append("svg")
               .attr("width", width)
               .attr("height", height)
               .append("g")
                                .attr("transform", "translate(" + padding + "," + padding + ")")
                                .call(d3.behavior.zoom().x(xScale).y(yScale).on("zoom", zoom))
                .on("mousedown.zoom", null)
                            .on("touchstart.zoom", null)
                            .on("touchmove.zoom", null)
                            .on("touchend.zoom", null)
            ;

     svg.append("g")
        .attr("class", "brush")
        .call(brush);
 
    var tooltip = d3.select("body")
      .attr("class", "tooltip")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .text("a simple tooltip");

        // draw the genes
     var circle= svg.selectAll("circle")
       .data(geneDataset)
       .enter()
       .append("circle")
       .attr("r", function(d) {console.log("appending gene circle: " + d); return 2;})
       .text(function(d) {
           return(d.rowname);
           })
       .style("fill", function(d) { return assignColor(d.category); })
       .on("mouseover", function(d,i){
           tooltip.text(d.rowname);
           return tooltip.style("visibility", "visible");
           })
       .on("mousemove", function(){return tooltip.style("top",
           (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
       .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
       .attr("transform", transform);

         //-----------------------
         // draw the vectors
         //-----------------------
   var line = svg.selectAll("line")
                  .data(vectorDataset)
                  .enter().append("line")
                             .attr("class", "line")
                             .style("stroke-width", 1)
                     .style("stroke", "red")
                     .attr("x1", xScale(0))
                     .attr("y1", yScale(0))
                     .attr("x2", function(v) { return xScale(v.Comp1); })
                     .attr("y2", function(v) { return yScale(v.Comp2); });
   var text = svg.selectAll("text")
                 .data(vectorDataset)
                 .enter().append("text")
                         .attr("class", "text")
                         .attr("x", function(v) { return xScale(v.Comp1); })
                         .attr("y", function(v) { return yScale(v.Comp2); })
                         .text( function(v) {return v.rowname})
                         .attr("text-anchor", "middle")
                         .style("fill", "black") ;
                                                 
     return(svg)

} // d3PlsrScatterPlot
//--------------------------------------------------------------------------------------------------
d3PlsrVectors = function(svg, dataset, color)
{
   var padding = 50;
   var width = 800;
   var height = 600;

   var xScale = d3.scale.linear()
                 .domain([-1, 1])
                 .range([padding, width - padding * 2]);

   var yScale = d3.scale.linear()
                 .domain([-1, 1])
                 .range([height - padding, padding]); // note inversion 

   console.log("====== vectors: " + dataset.length);
   console.log(dataset[0]);

   //var svg = d3.select("svg")

   var tooltip = d3.select("body")
      .attr("class", "tooltip")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .text("a simple tooltip");

   svg.selectAll("circle")
       .data(dataset)
       .enter()
       .append("circle")
       .attr("cx", function(d,i) {
           console.log("appending circle at cx: " + d.Comp1);
           return xScale(d.Comp1);
           })
       .attr("cy", function(d,i) {
           return yScale(d.Comp2);
           })
       .attr("r", function(d) {
           return 2;
           })
       .text(function(d) {
           console.log(d.rowname);
           return(d.rowname);
           })
      .style("fill", color)
      .on("mouseover", function(d,i){
           tooltip.text(d.rowname);
           return tooltip.style("visibility", "visible");
           })
      .on("mousemove", function(){return tooltip.style("top",
          (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
      .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

} // d3PlsrVectors
//--------------------------------------------------------------------------------------------------
addJavascriptMessageHandler('plsrPlot', displayPLSRresults);
addJavascriptMessageHandler("plotPLSRPatientTimesResult", displayPLSRPatientTimesResults);
addJavascriptMessageHandler("tissueIDsForPLSR", plsrHandleIncomingTissueIDList);
addJavascriptMessageHandler('ageAtDxAndSurvivalRanges', handleAgeAtDxAndSurvivalRanges);
//----------------------------------------------------------------------------------------------------
</script>


<body>
<style>

.domain { 
  fill: none; 
  } 

.axis path, .axis line {
    stroke: black;
    stroke-width: 1px;
    }


#plsrControlsDiv {
   border: 1px solid #aaa;
   //border: 5px solid #aaa;
   font-family: sans-serif;
   font-size: 12px;
   margin-top: 2px;
   margin-left: 5px;
   margin-right: 10px;
   margin-bottom: 5px;
   background-color: #EED;
   }

#plsrFilterControlsDiv {
   font-family: sans-serif;
   font-size: 14px;
   margin-top: 1px;
   margin-left: 5px;
   margin-right: 50px;
   margin-bottom: 5px;
   }

#plsrPlotDiv {
   border-style: solid;
   border-width: 1px;
   width: 800px;
   height: 500px;
   margin: 5px;
   }


.plsrSlider { 
   margin-left:20px; 
   margin-right:5px; 
   margin-top:0px;
   border: 3px solid #FFF;
   height: 20px;
   max: 0;  min: 10; 
   orientation: 'horizontal';
   }

.plsrSliderReadout {
  font-family:"Courier";
  color: #00F;
  background-color: #FFF;
  font-size: 12px;
  border: 2px solid #DDD;
  width: 20px;
  height: 20px;
  resize: none;
  margin-top: 1px;
  margin-left: 1px;
  }

.plsrSliderTitleDiv {
  font-family:"Arial";
  color: #000000;
  font-size: 14px;
  padding-top: 10px;
  padding-left: 40px;
  }


#plsrButtonDiv {
   padding-botton: 30px;
   }


</style>


<div id="plsrDiv">
    <div id="plsrControlsDiv">
          <div id="plsrFilterControlsDiv">

                             <!--    slider #1, for ageAtDxMin -->

              <div id="plsrSlider1Div" style="display: inline-block">
                  <div id="plsrSlider1TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">Low Age at Dx</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrAgeAtDxMinSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox1'>  
                               <textarea id="plsrAgeAtDxMinSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>



                             <!--    slider #2, for ageAtDxMax -->

              <div id="plsrSlider2Div" style="display: inline-block">
                  <div id="plsrSlider2TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">High Age at Dx</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrAgeAtDxMaxSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox2'>  
                               <textarea id="plsrAgeAtDxMaxSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>


                             <!--    slider #3, for overallSurvivalMin -->

              <div id="plsrSlider3Div" style="display: inline-block">
                  <div id="plsrSlider3TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">Low Survival</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrSurvivalMinSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox3'>  
                               <textarea id="plsrSurvivalMinSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>


                             <!--    slider #4, for overallSurvivalMax -->

              <div id="plsrSlider4Div" style="display: inline-block">
                  <div id="plsrSlider4TitleDiv" class="plsrSliderTitleDiv" style="margin-left: 10px;">High Survival</div>
                  <div style="width: 200px; overflow: hidden;">
                      <div style="width: 120px; height: 10px; float: left; margin-top: 10px;" id="plsrSurvivalMaxSlider" class="plsrSlider"></div>
                           <div style="margin-left: 20px;" id='msgBox4'>  
                               <textarea id="plsrSurvivalMaxSliderReadout" readonly class="plsrSliderReadout"'></textarea> 
                          </div>
                  </div>
              </div>

              <div id="plsrButtonDiv" style="display: inline-block">
                 <button id="plsrCalculateButton" type="button">Calculate</button>
                 <button id="plsrSendGenesButton" type="button">Send Genes</button>
              </div>


          </div>
    </div>

    <div id="plsrPlotDiv" style="margin-top:0"></div>
</div>

</body>
</html>
